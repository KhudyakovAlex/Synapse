# Прошивка. База данных

АПК Синапс v1.0. ПО. Спецификации на разработку

**Последнее изменение:** 09.12.2025

## 1. Термины и определения

1.1. **Рабочие** данные — необходимые для организации работы освещения и в прошивке, и в приложении. В приложении находятся в таблицах SQLite, в прошивке в виде массивов структур C.

1.2. **Интерфейсные** данные — используемые только приложением для организации пользовательского интерфейса.  Примеры: названия светильников, номера их иконок. В приложении находятся в таблицах SQLite, в прошивке в виде единого блока где-то в постоянной памяти.

## 2. Основные положения

2.1. «Таблицы» БД в прошивке разложены в массивы структур C. Тем не менее ниже для простоты они представляются именно как таблицы.

2.2. Индексация записей в таблицах ниже осуществляется по индексам соответствующих структур в массивах. Поэтому отдельных полей ID, как в аналогичных таблицах приложения, здесь нет, но поля с FK на эти индексы (типа LOCATION_ID) есть. LUMINAIRES.LOCATION_ID = 5 означает, что светильник приписан к локации, которая в массиве локаций лежит в 6-м элементе массива с локациями (нумерация индексов массивов начинается с 0). 

## 3. Таблицы

### 3.1. CONTROLLERS

Таблица с информацией о контроллере. Имеет одну запись. Представлена здесь таблицей для общности с DB приложения. В реальности является просто набором переменных, хранящихся в прошивке.

- **NAME** (char[20]) — название контроллера, показываемое в приложении и списке устройств Bluetooth;
- **PASSWORD** (char[4]) — пароль заводской или изменённый пользователем; 4 цифры; заводской на коробке (или наклейке на корпусе);
- **IS_SCHEDULE** (char[1]) — включена ли в контроллере работа по расписанию (0/1);
- **IS_AUTO** (char[1]) — главный выключатель автоматического режима для всего контроллера (0/1);
- **ICO_NUM** (uint8_t) — номер иконки, которую будет иметь контроллер в приложении; 0 — дефолтная.
- **STATUS** (char[1]) — текущее состояние контроллера: A (ACTIVE) — штатная работа, I (INIT) — инициализация линии DALI, F (FAILURE) — неполадка.
- **SCENE_NUM** (uint8_t) — световая сцена, включённая для всего объекта (0,1,2,3,4)
- **IDATA** (BLOB(50000)) — интерфейсные данные; просто обозначим это здесь, чтобы где-то было; понятно, что это некая отдельная область памяти в контроллере. В версии USM приложения этого поля нет, оно там разложено по дополнительным полям в этих же таблицах. Всё по честному: тут нет этих доп. полей, там нет этого BLOB поля. Конвертация происходит в JSON/USML-конверторе приложения.

### 3.2. LOCATIONS

Локации.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **IS_AUTO** (char[1]) — работает ли локация в автоматическом режиме по датчикам (T/F).
- **SCENE_NUM** (uint8_t) - световая сцена, включенная в этой локации (0,1,2,3,4)

### 3.3. GROUPS

Группы светильников. Номер группы в DALI совпадает с ID (индексу в массиве) записи.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **LOCATION_ID** (short) — локация, к которой привязана группа; -1 — группа без локации (в корне);
- **SCENE_NUM** (uint8_t) - световая сцена, включенная в этой группе (0,1,2,3,4)

### 3.4. LUMINAIRES

Светильники.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **DALI_ADDR** (uint8_t) — короткий адрес DALI;
- **LOCATION_ID** (short) — локация, к которой привязан светильник; -1 — светильник без локации (в корне);
- **GROUP_ID** (short) — группа, к которой привязан светильник; если светильник не в группе: -1;
- **VAL_BRIGHT** (uint8_t) — значение яркости;
- **VAL_TW** (uint8_t) — значение температуры белого света;
- **VAL_R** (uint8_t) — значение красного канала (для RGB);
- **VAL_G** (uint8_t) — значение зелёного канала (для RGB);
- **VAL_B** (uint8_t) — значение синего канала (для RGB);
- **VAL_W** (uint8_t) — значение белого канала (для RGBW).
- **SCENE_NUM** (uint8_t) - световая сцена, включенная у этого светильника (0,1,2,3,4)
- **STATUS** (char[1]) — текущее состояние устройства: A (ACTIVE) — штатная работа, C (CHANGE) — замена устройства, F (FAILURE) — неполадка.

### 3.5. SCENE_LUMINAIRES

Параметры светильников в сценах.

- **SCENE_NUM** (uint8_t) - световая сцена (0,1,2,3,4)
- **LUMINAIRE_ID** (uint8_t) — светильник;
- **VAL_BRIGHT** (uint8_t) — значение яркости;
- **VAL_TW** (uint8_t) — значение температуры белого света;
- **VAL_R** (uint8_t) — значение красного канала (для RGB);
- **VAL_G** (uint8_t) — значение зелёного канала (для RGB);
- **VAL_B** (uint8_t) — значение синего канала (для RGB);
- **VAL_W** (uint8_t) — значение белого канала (для RGBW).

### 3.6. PRES_SENSORS

Датчики присутствия.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **DALI_ADDR** (uint8_t) — короткий адрес DALI датчика;
- **DALI_INST** (uint8_t) — номер инстанса датчика движения в DALI;
- **LOCATION_ID** (short) — локация, к которой привязан датчик; -1 — датчик без локации (в корне);
- **ACTION_OCCUPANCY_ID** (short) — действие, повешенное на присутствие; -1 — не повешено действие;
- **ACTION_VACANCY_ID** (short) — действие, повешенное на отсутствие; -1 — не повешено действие;
- **DELAY** (uint8_t) — задержка HOLD_TIME.
- **STATUS** (char[1]) — текущее состояние устройства: A (ACTIVE) — штатная работа, C (CHANGE) — замена устройства, F (FAILURE) — неполадка.

### 3.7. BRIGHT_SENSORS

Датчики освещённости.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **DALI_ADDR** (uint8_t) — короткий адрес DALI датчика;
- **DALI_INST** (uint8_t) — номер инстанса датчика движения в DALI;
- **LOCATION_ID** (short) — локация, к которой привязан датчик; -1 — датчик без локации (в корне);
- **GROUP_ID** (short) — группа, к которой привязан датчик; -1 — группа не назначена.
- **STATUS** (char[1]) — текущее состояние устройства: A (ACTIVE) — штатная работа, C (CHANGE) — замена устройства, F (FAILURE) — неполадка.

### 3.8. BUTTON_PANELS

Кнопочные панели.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **DALI_ADDR** (uint8_t) — короткий адрес панели в DALI;
- **LOCATION_ID** (short) — локация, к которой привязана панель; -1 — панель без локации (в корне);
- **STATUS** (char[1]) — текущее состояние устройства: A (ACTIVE) — штатная работа, C (CHANGE) — замена устройства, F (FAILURE) — неполадка.

### 3.9. BUTTONS

Кнопки.

- **BUTTON_PANEL_ID** (uint8_t) — кнопочная панель, в которой кнопка расположена;
- **DALI_INST** (uint8_t) — номер инстанса кнопки в DALI;
- **ACTION_SET_SHORT_NUM** (short) — действие по короткому нажатию; -1 — не повешено действие;
- **ACTION_LONG_ID** (short) — действие по долгому нажатию; -1 — не повешено действие.

### 3.10. ACTIONS

Действия с устройствами.

- **ACTION_SET_NUM** (short) — привязка к набору действий; если действие не входит ни в какой набор: -1;
- **POS** (uint8_t) — номер по порядку действия (начиная с 1) в списке действий, привязанных к кнопке (случай перебора действий одной кнопкой)

### 3.11. SUBACTIONS

Поддействия действий.

- **ACTION_ID** (short) — действие;
- **OBJECT_TYPE** (uint8_t) — тип объекта изменений:
    - 1 — весь объект;
    - 2 — локация;
    - 3 — группа;
    - 4 — светильник;
- **OBJECT_NUM** (uint8_t) — номер объекта изменений:
    - 1 — сцена;
    - 2 — температура TW;
    - 3 — флаг АВТО.
- **VALUE** (uint8_t) — значение в зависимости от объекта:
    - сцена - 0..4;
    - температура TW - 0..254;
    - флаг АВТО - 0 / 1.

### 3.12. EVENTS

События расписания.

- **EXIST** (char[1]) — задействована ли запись в работе или это пустое место, где может храниться запись (T/F).
- **DAYS** (char[7]) — 'FFTFFFF' — событие по дням недели; если все F — ежедневное;
- **TIME** (char[4]) — время события с точностью до минуты в формате HHMM 24H;
- **SMOOTH** (char[1]) — плавное изменение параметров от предыдущих значений (яркость, температура света) (T/F);
- **ACTION_ID** (short) — действие.

## 4. Ограничения по количеству записей в таблицах (для прошивки)

4.1. **CONTROLLERS** — 1.

4.2. **LOCATIONS** — 16.

4.3. **LUMINAIRES** — 64.

4.4. **SCENE_LUMINAIRES** — 320.

4.5. **GROUPS** — 16.

4.6. **PRES_SENSORS** — 64.

4.7. **BRIGHT_SENSORS** — 64.

4.8. **BUTTON_PANELS** — 64.

4.9. **BUTTONS** — 64.

4.10. **ACTIONS** — 255.

4.11. **SUBACTIONS** — 255.

4.12. **EVENTS** — 255.

## 5. Вопросы

## 6. Идеи
