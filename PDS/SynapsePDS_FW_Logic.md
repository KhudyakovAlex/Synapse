# Прошивка. Логика работы

АПК Синапс v1.0. ПО. Спецификации на разработку

**Последнее изменение:** 11.12.2025, 19:02 МСК

## 1. Назначение документа

Дать разработчику исчерпывающее понимание логики работы прошивки контроллера АПК Синапс.

## 2. Базовые документы

- **SynapsePDS_FW** — описание прошивки контроллера
- **SynapsePDS_FW_DB** — структура базы данных прошивки
- **SynapsePDS_USML** — протокол обмена данными

## 3. Термины и определения

3.1. **FW-USM** (Unit System Model прошивки) — виртуальная модель системы освещения в прошивке. Представляет собой набор массивов структур языка С, хранящих состояние всех устройств DALI-линии, настройки локаций, групп, действия, расписание и другие данные. Структура описана в **SynapsePDS_FW_DB**.

3.2. **APP-USM** — виртуальная модель системы освещения в приложении (SQLite). Является кэшем FW-USM для оперативного доступа UI и LLM к данным контроллера.

3.3. **USML** (Unit System Model Language) — бинарный протокол передачи данных между прошивкой и приложением.

3.4. **Телеграмма** (телега) — команда в формате USML, содержащая изменения USM.

3.5. **Рабочие данные** — данные для организации работы освещения (яркость светильников, адреса DALI, действия датчиков и т.п.). Хранятся в прошивке в виде массивов структур C.

3.6. **Интерфейсные данные** (IDATA) — данные для UI приложения (названия, номера иконок, координаты). В прошивке хранятся единым блоком размером 50000 байт.

3.7. **ACTION** — действие, состоящее из одного или нескольких поддействий (SUBACTION).

3.8. **SUBACTION** — элементарное изменение системы освещения (включение сцены у светильника/группы/локации, установка температуры TW, переключение режима АВТО).

## 4. Базовые принципы

### 4.1. Режимы работы контроллера

4.1.1. Прошивка в контроллере может работать в двух режимах:
- **Автономный режим** — контроллер обрабатывает сигналы от настенных кнопок, датчиков присутствия, датчиков освещённости, обеспечивает работу по расписанию.
- **Режим с подключением телефонов** — дополнительно к автономному режиму осуществляется ПНР, настройка и оперативное управление системой освещения.

4.1.2. К контроллеру одновременно могут быть подключены до 4 телефонов.

### 4.2. Управление через изменение данных

4.2.1. Все команды на выполнение действий передаются от телефонов контроллеру через изменение данных FW-USM.

4.2.2. Нет команд типа "запустить инициализацию". Вместо этого приложение изменяет поле **CONTROLLERS.STATUS** = `I`, что запускает соответствующую логику в прошивке.

4.2.3. То, какой код отработает в прошивке, определяется тем, какие данные в FW-USM меняются.

### 4.3. Синхронизация USM

4.3.1. В телеграммах от приложения к прошивке передаются изменения, которые пользователь хочет внести в систему освещения.

4.3.2. Получив телеграмму с изменениями, прошивка:
- Анализирует, какие данные изменились;
- Выполняет соответствующие действия (отправка команд в DALI, изменение внутреннего состояния);
- Обновляет свой FW-USM;
- Отправляет телеграмму с изменениями всем подключённым телефонам (широковещательно).

4.3.3. После любого изменения FW-USM прошивка отправляет телегу об этом всем подключённым телефонам (до 4 шт). Тем самым обеспечивается синхронизация FW-USM и APP-USM всех телефонов.

4.3.4. В телеграммах передаются только изменившиеся данные, а не весь FW-USM целиком.

### 4.4. Пример: включение светильника

Приложение отправляет команду на включение светильника 3 с яркостью 55:

1. Телеграмма с изменением `LUMINAIRES[3].VAL_BRIGHT = 55` приходит в контроллер.
2. Контроллер видит изменение яркости и отправляет DALI-команду светильнику с адресом `LUMINAIRES[3].DALI_ADDR`.
3. Контроллер обновляет `LUMINAIRES[3].VAL_BRIGHT = 55` в своём FW-USM.
4. Изменение широковещательно отправляется телеграммой всем подключённым телефонам.

## 5. Взаимодействие с телефоном

### 5.1. Bluetooth-подключение

5.1.1. Контроллер работает как периферийное устройство (Peripheral).

5.1.2. Телефоны работают как центральные устройства (Central).

5.1.3. К контроллеру могут одновременно подключиться до 4 телефонов.

5.1.4. Если подключено 4 телефона, контроллер не выдаёт в эфир адвертайзных сигналов.

5.1.5. Имя Bluetooth-устройства:
- По умолчанию: `SYNAPSE XXXXXXXX` (XXXXXXXX — серийный номер);
- После изменения имени/иконки: `[ICO]Name` (ICO — номер иконки в квадратных скобках; строка парсится в приложении и пользователю показывается иконка и имя без `[ICO]`).

### 5.2. Протокол обмена телеграммами

5.2.1. Телеграммы передаются в бинарном формате USML.

5.2.2. Структура USML-телеграммы:
- **Реестр** — битовая маска, определяющая, какие таблицы/записи/поля содержатся в телеграмме;
- **Данные** — последовательность байтов значений полей в порядке, определённом реестром.

5.2.3. При получении телеги от телефона прошивка должна отправить подтверждение успешного получения.

5.2.4. При отправке телеги телефону прошивка должна получить подтверждение. При отсутствии подтверждения — повторная отправка 2 дополнительных раза с интервалом 1 сек. Если ответа нет, считаем связь потеранной и отключаем телефон.

5.2.5. Телеги от прошивки отправляются широковещательно ВСЕМ подключённым телефонам.

### 5.3. Обновление даты и времени

5.3.1. При каждом подключении телефона к контроллеру приложение отправляет телеграмму с изменением **CONTROLLERS.TIMESTAMP**.

5.3.2. Значение передаётся в формате Unix timestamp (uint32_t) — количество секунд с 01.01.1970 00:00:00 UTC.

5.3.3. Прошивка обновляет свои внутренние часы для работы расписания.

## 6. Загрузка USM контроллера в телефон

### 6.1. Первое подключение к контроллеру

6.1.1. При первом подключении телефона к контроллеру прошивка сразу отправляет полный дамп FW-USM (включая пароль).

6.1.3. Дамп включает:
- Рабочие данные (все таблицы FW-USM);
- Интерфейсные данные (блок IDATA).

6.1.4. При успешной аутентификации приложение создаёт запись в таблице **CONTROLLERS** своей APP-USM.

6.1.5. Приложение распаковывает полученные данные в свою APP-USM.

### 6.2. Повторное подключение

6.2.1. При повторном подключении к знакомому контроллеру пароль не запрашивается.

6.2.2. Прошивка отправляет полный дамп FW-USM для синхронизации с APP-USM телефона.

6.2.3. Приложение обновляет свою APP-USM данными из FW-USM.

### 6.3. Восстановление связи после разрыва

6.3.1. При кратковременном разрыве связи приложение пытается восстановить соединение.

6.3.2. После нескольких безуспешных попыток приложение выкидывает пользователя в список контроллеров.

6.3.3. При восстановлении связи приложение автоматически заходит в контроллер в прежнюю локацию (если не успели зайти в другой контроллер).

6.3.4. Прошивка отправляет актуальное состояние FW-USM для синхронизации.

### 6.4. Одновременная работа нескольких телефонов

6.4.1. При подключении второго/третьего/четвёртого телефона прошивка отправляет ему полный дамп FW-USM.

6.4.2. Все изменения FW-USM, вызванные действиями любого из телефонов, рассылаются всем подключённым телефонам.

6.4.3. Каждое приложение обновляет свой APP-USM при получении телеграмм от прошивки.

## 7. Пуско-наладочные работы

### 7.1. Сохранение IDATA

7.1.1. Блок интерфейсных данных IDATA хранится в энергонезависимой памяти контроллера.

7.1.2. При любом изменении интерфейсных данных (имя, иконка) через приложение прошивка:
- Получает телеграмму с новым блоком IDATA;
- Записывает его в энергонезависимую память;
- Рассылает изменения всем подключённым телефонам.

7.1.3. При инициализации линии DALI блок IDATA сбрасывается (кроме NAME, PASSWORD, ICO_NUM контроллера).

### 7.2. Инициализация линии DALI

7.2.1. Инициализация стартуется телеграммой с изменением **CONTROLLERS.STATUS** = `I`.

7.2.2. При получении этой телеграммы прошивка:
- Сбрасывает все данные FW-USM (кроме NAME, PASSWORD, ICO_NUM контроллера);
- Сбрасывает состояние всех устройств в линии DALI к состоянию RESET (DALI-команда);
- Ставит **CONTROLLERS.STATUS** = `I`;
- Рассылает изменения всем телефонам.

7.2.3. Прошивка производит инициализацию светильников:
- Широковещательно выключает все светильники (DALI-команда);
- Выполняет поиск устройств в линии DALI;
- Присваивает каждому найденному светильнику короткий адрес;
- Добавляет светильники в FW-USM с:
  - `EXIST = T`;
  - `LOCATION_ID = -1` (без локации);
  - `GROUP_ID = -1` (без группы);
  - `DALI_ADDR` — присвоенный короткий адрес;
  - Начальными значениями VAL_BRIGHT, VAL_TW и т.д.;
  - `STATUS = A`.
- Включает светильник (DALI-команда) после присвоения адреса.

7.2.4. Прошивка инициализирует сцены 0-4:
- Сцена 0: яркость 0% (выключено);
- Сцена 1: яркость 25%;
- Сцена 2: яркость 50%;
- Сцена 3: яркость 75%;
- Сцена 4: яркость 100%;
- Для RGB-светильников: красный цвет с максимальной насыщенностью.

7.2.5. Прошивка производит инициализацию устройств управления (датчики, кнопочные панели):
- Выполняет поиск устройств в линии DALI;
- Присваивает короткие адреса;
- Добавляет в FW-USM с:
  - `EXIST = T`;
  - `LOCATION_ID = -1` (без локации);
  - `STATUS = A`;
  - Остальные поля — по умолчанию (для датчиков присутствия ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1, для кнопок ACTION_SET_SHORT_NUM = -1, ACTION_LONG_ID = -1).
- Включает светодиоды на кнопочных панелях (DALI-команда).

7.2.6. По мере инициализации прошивка рассылает телеграммы с прогрессом всем телефонам.

7.2.7. После завершения инициализации прошивка:
- Ставит **CONTROLLERS.STATUS** = `A`;
- Рассылает финальное состояние FW-USM всем телефонам.

### 7.3. Расширение линии DALI

7.3.1. Расширение стартуется телеграммой с изменением **CONTROLLERS.STATUS** = `E` (расширение).

7.3.2. Расширение производится аналогично инициализации, но **без сброса FW-USM**.

7.3.3. Прошивка:
- Выполняет поиск устройств в линии DALI;
- Находит устройства без короткого адреса (новые);
- Присваивает им адреса;
- Добавляет в свободные слоты FW-USM (где `EXIST = F`);
- Рассылает изменения телефонам.

7.3.4. Новые устройства добавляются с дефолтными параметрами без локации и группы.

### 7.4. Замена устройства в линии DALI

7.4.1. Замена стартуется телеграммой с изменением **LUMINAIRES[i].STATUS** = `C` (или **PRES_SENSORS[i].STATUS** = `C` и т.д.).

7.4.2. Прошивка выполняет расширение линии (как в п. 7.3).

7.4.3. Прошивка находит устройства того же типа без привязки (новые).

7.4.4. Если найдено одно новое устройство нужного типа:
- Прошивка копирует все настройки из записи заменяемого устройства в запись нового;
- Присваивает новому устройству короткий адрес старого (DALI-команда);
- Отправляет необходимые DALI-команды для установки параметров (MIN_LEVEL, MAX_LEVEL, FADE_TIME и т.д.);
- Ставит **STATUS** = `A`.

7.4.5. Если найдено несколько устройств нужного типа:
- Прошивка сообщает приложению о неоднозначности;
- Пользователь выбирает нужное устройство в UI;
- Приложение отправляет телеграмму с указанием конкретного устройства;
- Прошивка завершает замену.

7.4.6. Прошивка рассылает изменения всем телефонам.

### 7.5. Создание и удаление локаций, распределение по ним устройств

7.5.1. **Создание локации**: приложение отправляет телеграмму с изменением **LOCATIONS[i].EXIST** = `T` для свободного слота.

7.5.2. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.5.3. **Перемещение устройства в локацию**: приложение отправляет телеграмму с изменением **LUMINAIRES[j].LOCATION_ID** = `i`.

7.5.4. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.5.5. **Удаление локации**: приложение отправляет телеграмму с изменением **LOCATIONS[i].EXIST** = `F`.

7.5.6. Прошивка:
- Проверяет, что в локации нет устройств (или переносит их в корень);
- Обновляет FW-USM;
- Рассылает изменения телефонам.

### 7.6. Создание и удаление групп, распределение по ним устройств

7.6.1. **Создание группы**: приложение отправляет телеграмму с изменением **GROUPS[i].EXIST** = `T` и **GROUPS[i].LOCATION_ID** = `loc` (или -1 для корня).

7.6.2. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.6.3. **Добавление светильника в группу**: приложение отправляет телеграмму с изменением **LUMINAIRES[j].GROUP_ID** = `i`.

7.6.4. Прошивка:
- Проверяет, что светильник и группа в одной локации (или оба в корне);
- Отправляет DALI-команду присвоения светильника группе i;
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.6.5. **Удаление группы**: приложение отправляет телеграмму с изменением **GROUPS[i].EXIST** = `F`.

7.6.6. Прошивка:
- Убирает у всех светильников с **GROUP_ID** = `i` привязку к группе (GROUP_ID = -1);
- Отправляет соответствующие DALI-команды;
- Обновляет FW-USM;
- Рассылает изменения телефонам.

### 7.7. Именование и раздача пиктограмм контроллеру, локациям, устройствам

7.7.1. Изменение имени/иконки — это изменение интерфейсных данных в блоке IDATA.

7.7.2. Приложение отправляет телеграмму с новым блоком IDATA или его частью.

7.7.3. Прошивка:
- Обновляет блок IDATA в FW-USM;
- Записывает изменения в энергонезависимую память;
- Рассылает изменения всем телефонам.

7.7.4. Если изменилось имя или иконка контроллера:
- Прошивка обновляет имя Bluetooth-устройства;
- Новое имя формата: `[ICO]Name`.

### 7.8. Добавление поддействия в действие

7.8.1. **Создание действия**: приложение отправляет телеграмму с изменением:
- **ACTIONS[i].ACTION_SET_NUM** = `set` (номер набора действий, если действие входит в набор);
- **ACTIONS[i].POS** = `pos` (позиция в наборе для перебора).

7.8.2. **Добавление поддействия**: приложение отправляет телеграмму с заполнением записи **SUBACTIONS[j]**:
- **ACTION_ID** = `i`;
- **OBJECT_TYPE** = тип объекта (1-объект, 2-локация, 3-группа, 4-светильник);
- **OBJECT_NUM** = номер объекта;
- **VALUE** = значение (номер сцены, температура TW, флаг АВТО).

7.8.3. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.8.4. Никаких DALI-команд не отправляется, т.к. действие ещё не выполняется, а только настраивается.

### 7.9. Назначение действий на присутствие и отсутствие датчиков присутствия

7.9.1. Приложение отправляет телеграмму с изменением:
- **PRES_SENSORS[i].ACTION_OCCUPANCY_ID** = `j` (действие на присутствие);
- **PRES_SENSORS[i].ACTION_VACANCY_ID** = `k` (действие на отсутствие).

7.9.2. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.9.3. Датчик начинает отрабатывать действия при соответствующих событиях (если АВТО включено).

### 7.10. Привязка датчиков освещённости к группам светильников

7.10.1. Приложение отправляет телеграмму с изменением **BRIGHT_SENSORS[i].GROUP_ID** = `j`.

7.10.2. Прошивка проверяет, что датчик и группа в одной локации (или оба в корне).

7.10.3. Прошивка последовательно переводит группу в сцены 0-4 (DALI-команды).

7.10.4. Для каждой сцены прошивка:
- Считывает текущую освещённость с датчика (DALI-команда);
- Сохраняет значение как целевую освещённость для этой сцены.

7.10.5. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

### 7.11. Назначение действий на настенные кнопки

7.11.1. Приложение отправляет телеграмму с изменением:
- **BUTTONS[i].ACTION_SET_SHORT_NUM** = `set` (набор действий на короткое нажатие);
- **BUTTONS[i].ACTION_LONG_ID** = `j` (действие на долгое нажатие).

7.11.2. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

7.11.3. Кнопка начинает отрабатывать действия при нажатиях.

## 8. Настройка

### 8.1. Изменение параметров устройств

8.1.1. Для изменения параметров DALI-устройств приложение отправляет телеграмму с изменением соответствующих полей в FW-USM.

8.1.2. Примеры параметров:
- **MIN_LEVEL**, **MAX_LEVEL** светильников;
- **FADE_TIME** светильников;
- **DELAY** (HOLD_TIME) датчиков присутствия.

8.1.3. Прошивка:
- Отправляет DALI-команду установки параметра устройству;
- Обновляет FW-USM (если параметр хранится в USM);
- Рассылает изменения телефонам.

### 8.2. Сохранение световых сцен

8.2.1. **Сохранение сцены отдельного светильника**:
- Пользователь устанавливает нужную яркость/цвет/температуру светильника;
- Приложение отправляет команду на сохранение сцены N;
- Прошивка отправляет DALI-команду сохранения текущего состояния в сцену N;
- Прошивка обновляет таблицу **SCENE_LUMINAIRES**;
- Рассылает изменения телефонам.

8.2.2. **Сохранение сцены группы**:
- Пользователь устанавливает нужное состояние светильников группы;
- Приложение отправляет команду на сохранение сцены N для группы i;
- Прошивка отправляет групповую DALI-команду сохранения сцены N;
- Прошивка обновляет **SCENE_LUMINAIRES** для всех светильников группы;
- Рассылает изменения телефонам.

### 8.3. Формирование и активация расписания

8.3.1. **Добавление события в расписание**: приложение отправляет телеграмму с заполнением записи **EVENTS[i]**:
- **EXIST** = `T`;
- **DAYS** = маска дней недели (например, 'FFTFFFF' — только вторник);
- **TIME** = время в формате HHMM;
- **SMOOTH** = `T` (плавное изменение) или `F` (одномоментное);
- **ACTION_ID** = `j` (действие для выполнения).

8.3.2. Прошивка:
- Обновляет FW-USM;
- Рассылает изменения телефонам.

8.3.3. **Активация расписания**: приложение отправляет телеграмму с изменением **CONTROLLERS.IS_SCHEDULE** = `T`.

8.3.4. Прошивка:
- Обновляет FW-USM;
- Начинает проверку событий расписания каждую минуту;
- Рассылает изменения телефонам.

8.3.5. **Деактивация расписания**: приложение отправляет **CONTROLLERS.IS_SCHEDULE** = `F`.

## 9. Оперативное управление

### 9.1. Изменение яркости, цвета, температуры светильника

9.1.1. Приложение отправляет телеграмму с изменением полей светильника:
- **LUMINAIRES[i].VAL_BRIGHT** = значение яркости;
- **LUMINAIRES[i].VAL_TW** = температура белого;
- **LUMINAIRES[i].VAL_R**, **VAL_G**, **VAL_B**, **VAL_W** = цвета.

9.1.2. Прошивка:
- Отправляет DALI-команду установки параметров светильнику;
- Обновляет FW-USM;
- Рассылает изменения телефонам.

9.1.3. Если светильник находится в локации с включённым АВТО, оперативное управление временно переводит **LOCATIONS[loc].IS_AUTO** = `F`.

9.1.4. Возврат в режим АВТО происходит при срабатывании датчика присутствия в этой локации.

### 9.2. Включение сцены

9.2.1. Включение сцены может быть:
- У отдельного светильника;
- У группы светильников;
- У локации (всех светильников локации);
- У корня (всех светильников в корне);
- У всего объекта (всех светильников контроллера).

9.2.2. Приложение отправляет телеграмму с изменением:
- **LUMINAIRES[i].SCENE_NUM** = N (для светильника);
- **GROUPS[i].SCENE_NUM** = N (для группы);
- **LOCATIONS[i].SCENE_NUM** = N (для локации);
- **CONTROLLERS.SCENE_NUM** = N (для объекта).

9.2.3. Прошивка:
- Отправляет DALI-команду включения сцены N соответствующим устройствам;
- Обновляет поля VAL_BRIGHT, VAL_TW и т.д. из таблицы **SCENE_LUMINAIRES**;
- Обновляет SCENE_NUM;
- Рассылает изменения телефонам.

9.2.4. Если у группы есть привязанный датчик освещённости, включение сцены переводит группу в режим поддержания целевой освещённости.

### 9.3. Включение/выключение режима АВТО

9.3.1. **У локации**: приложение отправляет телеграмму с изменением **LOCATIONS[i].IS_AUTO** = `T` или `F`.

9.3.2. **У контроллера**: приложение отправляет телеграмму с изменением **CONTROLLERS.IS_AUTO** = `T` или `F`.

9.3.3. Прошивка:
- Обновляет FW-USM;
- Если АВТО выключается — датчики перестают влиять на освещение;
- Если АВТО включается — датчики начинают отрабатывать действия;
- Рассылает изменения телефонам.

## 10. Работа по датчикам

### 10.1. Датчики присутствия

10.1.1. Прошивка постоянно опрашивает датчики присутствия в линии DALI (в периоды затишья).

10.1.2. При регистрации события присутствия на датчике i:
- Прошивка проверяет **CONTROLLERS.IS_AUTO**. Если `F` — игнорирует событие.
- Прошивка проверяет, в какой локации находится датчик (**PRES_SENSORS[i].LOCATION_ID**).
- Если датчик в локации — проверяет **LOCATIONS[loc].IS_AUTO**. Если `F` — игнорирует событие.
- Если датчик в корне — событие обрабатывается при **CONTROLLERS.IS_AUTO** = `T`.
- Прошивка выполняет действие **PRES_SENSORS[i].ACTION_OCCUPANCY_ID**.

10.1.3. При регистрации события отсутствия на датчике i:
- Аналогичные проверки флагов АВТО;
- Прошивка выполняет действие **PRES_SENSORS[i].ACTION_VACANCY_ID**.

10.1.4. Действие отсутствия срабатывает через задержку **PRES_SENSORS[i].DELAY** (HOLD_TIME).

10.1.5. Если есть желание деактивировать датчик — у него убираются действия (ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1).

### 10.2. Датчики освещённости

10.2.1. Прошивка постоянно опрашивает датчики освещённости в периоды затишья.

10.2.2. Если у датчика i назначена группа (**BRIGHT_SENSORS[i].GROUP_ID** != -1):
- Прошивка проверяет флаги АВТО аналогично п. 10.1.2;
- Прошивка считывает текущую освещённость с датчика;
- Прошивка сравнивает с целевой освещённостью для текущей сцены группы;
- Если отклонение больше порога — прошивка корректирует яркость светильников группы (DALI-команды).

10.2.3. Подкрутка яркости работает только если у группы включена одна из сцен 0-4.

10.2.4. Любое изменение яркости группы, отличное от включения сцены, отключает подкрутку до следующего включения сцены.

10.2.5. Если есть желание деактивировать датчик — у него убирается привязка к группе (GROUP_ID = -1).

### 10.3. Логика режима АВТО

10.3.1. **Главный флаг АВТО** (**CONTROLLERS.IS_AUTO**):
- Если `F` — все датчики игнорируются;
- Если `T` — работают флаги АВТО локаций.

10.3.2. **Флаг АВТО локации** (**LOCATIONS[i].IS_AUTO**):
- Если `F` — датчики этой локации игнорируются;
- Если `T` — датчики локации отрабатывают действия.

10.3.3. **Устройства в корне** (без локации):
- Работают при **CONTROLLERS.IS_AUTO** = `T`.

10.3.4. **Временное отключение АВТО при оперативном управлении**:
- Оперативное управление хотя бы одним светильником в локации переводит **LOCATIONS[i].IS_AUTO** = `F`;
- Возврат в АВТО при срабатывании датчика присутствия в этой локации (событие присутствия);
- При возврате в АВТО датчик сразу отрабатывает действие на присутствие.

## 11. Работа по расписанию

### 11.1. Проверка событий

11.1.1. Если **CONTROLLERS.IS_SCHEDULE** = `T`, прошивка каждую минуту проверяет события в таблице **EVENTS**.

11.1.2. Прошивка сравнивает текущее время и день недели с данными в записях **EVENTS**.

11.1.3. Если время и день совпадают:
- Прошивка выполняет действие **EVENTS[i].ACTION_ID**.

### 11.2. Типы событий

11.2.1. **Ежедневное событие**: **EVENTS[i].DAYS** = 'FFFFFFF' (все дни F).

11.2.2. **Событие по дням недели**: **EVENTS[i].DAYS** содержит T в соответствующих днях (например, 'FFTFFFF' — вторник).

11.2.3. Если на одно время назначено ежедневное событие и событие по дням недели:
- Сначала выполняется ежедневное;
- Затем выполняется событие по дням недели.

### 11.3. Режим выполнения

11.3.1. **Одномоментное выполнение** (**EVENTS[i].SMOOTH** = `F`):
- Параметры устройств меняются сразу;
- Прошивка отправляет DALI-команды с параметрами из действия.

11.3.2. **Плавное выполнение** (**EVENTS[i].SMOOTH** = `T`):
- Параметры устройств изменяются линейно от текущих к целевым;
- Изменение производится раз в 1 минуту;
- Прошивка вычисляет шаг изменения и постепенно меняет параметры.

### 11.4. Выполнение действия

11.4.1. Действие состоит из одного или нескольких поддействий (**SUBACTIONS**).

11.4.2. Прошивка последовательно выполняет все поддействия действия:
- Включение сцены (DALI-команда + обновление FW-USM);
- Установка температуры TW (DALI-команда + обновление FW-USM);
- Переключение АВТО (обновление FW-USM).

11.4.3. После выполнения действия прошивка рассылает изменения всем телефонам.

## 12. Сброс контроллера железной кнопкой

### 12.1. Короткое нажатие

12.1.1. Короткое нажатие сбрасывает только пароль к заводскому.

12.1.2. Прошивка:
- Считывает заводской пароль из области хранения констант;
- Записывает его в **CONTROLLERS.PASSWORD**;
- Сохраняет в энергонезависимую память.

12.1.3. Остальные данные FW-USM не изменяются.

### 12.2. Долгое нажатие

12.2.1. Долгое нажатие сбрасывает все настройки прошивки (не исполняемый код) в заводское состояние.

12.2.2. Прошивка:
- Сбрасывает все данные FW-USM;
- Сбрасывает блок IDATA;
- Восстанавливает заводское имя: `SYNAPSE XXXXXXXX`;
- Восстанавливает заводской пароль;
- Восстанавливает дефолтную иконку (0);
- Сохраняет в энергонезависимую память.

12.2.3. После сброса контроллер требует инициализации линии DALI.

## 13. Индикация на контроллере

### 13.1. Нижний светодиод

13.1.1. Нижний светодиод мигает, если идёт работа с линией DALI:
- Отправка команд устройствам;
- Чтение данных с устройств;
- Инициализация линии.

13.1.2. В остальное время светодиод не горит.

### 13.2. Лесенка светодиодов

13.2.1. Лесенка светодиодов загорается вся, если есть хотя бы одно Bluetooth-соединение с телефоном.

13.2.2. Если нет подключённых телефонов — вся лесенка не горит.

13.2.3. Количество горящих светодиодов не отражает количество подключённых телефонов (только факт наличия хотя бы одного).

## 14. Вопросы

14.1. Как обрабатывать ситуацию, когда два телефона одновременно отправляют конфликтующие команды?

14.2. Нужна ли очередь команд от телефонов или обрабатывать их строго последовательно?

14.3. Как часто опрашивать датчики в линии DALI в периоды затишья?

14.4. Нужен ли режим отладки с расширенным логированием?

## 15. Идеи

15.1. Реализовать буферизацию телеграмм при кратковременных разрывах связи с телефонами.

15.2. Добавить watchdog для контроля зависания основного цикла прошивки.

15.3. Реализовать механизм обнаружения вышедших из строя устройств DALI (не отвечают на команды).

15.4. Добавить статистику работы: время работы с момента последнего сброса, количество циклов работы расписания и т.д.
