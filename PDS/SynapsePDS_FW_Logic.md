# Прошивка. Логика работы

АПК Синапс v1.0. ПО. Спецификации на разработку

**Последнее изменение:** 07.12.2025

## 1. Термины и определения

1.1. **Прошивка** — firmware в контроллере.

1.2. **Приложение** — интерфейсное мобильное приложение в телефоне.

1.3. **LLM** — Large Language Model (большая языковая модель).

1.4. **USM** (Unit System Model) — виртуальная модель системы освещения.

1.5. **USML** (Unit System Model Language) — система команд (телеграмм) для передачи данных в рамках АПК Синапс. Описано в **SynapsePDS_USML**.

1.6. **База данных прошивки** — разложенные по массивам структур Си «таблицы» с данными контроллера, светильников, датчиков и т.д. В описании логики называются таблицами, хотя и ежу понятно, что фактически формат хранения у них другой. Описано в **SynapsePDS_FW_DB**.

## 2. Взаимодействие с телефоном

2.1. С мобильным приложением прошивка работает через Bluetooth.

2.2. К контроллеру могут подключаться и параллельно работать с прошивкой до 4 телефонов. В перспективе. Пока один.

2.3. Общение между приложением и прошивкой идёт через телеграммы.

2.4. Прошивке без разницы, сколько приложений со своих телефонов подключились к контроллеру и работают с ней:
- приём телеграмм идёт как будто от одного устройства
- передача производится широковещательно

2.5. Схема взаимодействия в общих чертах:

```mermaid
flowchart TB
    SAW(Автономная<br>работа<br>контроллера<br>по датчикам<br> и расписанию)
    BC(Блютус-подключение<br>телефона<br>к контроллеру)
    WC(Работа<br>контроллера<br>по датчикам<br> и расписанию)
    DD(Загрузка USM<br>контроллера в телефон)
    P{Ввод пароля<br>пользователем}
    W(Управление<br>контроллером<br>с телефона)
    BDC(Блютус-отключение)
    EAW(Автономная<br>работа<br>контроллера<br>по датчикам<br> и расписанию)

    SAW-->BC
    BC-->DD
    BC-->WC
    DD-->P

    P -->|Угадал| W
    W-->BDC
    WC-->BDC
    P -->|Не угадал| BDC

    BDC-->EAW
```

## 3. Загрузка USM контроллера в телефон

3.1. После установки блютус-соединения ещё до проверки пользователя на знание пароля контроллер передаёт свою USM в приложение.

3.2. Передача производится USML-телегой SET().

3.3. Т.о. в приложении оказывается своя копия USM-данных контроллера.

## 4. Пуско-наладочные работы

### 4.1. Инициализация линии DALI

4.1.1. Происходит следующее:
- В USM контроллера очищается всё кроме имени, иконки и пароля контроллера.
- В линии DALI происходит полный INITIALISE светильников и устройств управления.
- Согласно набору найденных устройств создаётся новая USM.
- Световые сцены 0..4 инициализируются начальными значениями.
- Новая версия USM передаётся в приложение.

4.1.2. Никакие локации и группы при этом не создаются. Все устройства помещаются вне локаций в «корень». Их LOCATION_ID = -1.

4.1.3. Порядок инициализации:

- Прошивка получает от приложения телегу `SET.CONTROLLERS[0].STATUS(A)`.

- Сама отвечает приложению телегой `SET.CONTROLLERS[0].STATUS(A)`.

- Очищаются все таблицы кроме **CONTROLLERS** (поля EXIST выставляются в F).

- В единственной записи **CONTROLLERS** устанавливаются:
    - NAME - не меняется
    - PASSWORD - не меняется
    - ICO_NUM - не меняется
    - IS_SCHEDULE = F
    - IS_AUTO = F
    - STATUS = A
    - SCENE_NUM = -1

- Широковещательно выключаются в линии все светильники и светодиоды кнопочных панелей.

- Раздаются короткие DALI-адреса светильникам. Светильник, получивший адрес, включается на макс.

- Светильники добавляются в таблицу **LUMINAIRES** с **LOCATION_NUM = -1** (без локации, в корне).

- В светильники в линии DALI записываются значения для сцен 0..4.
    - реле (тип 7) яркость: 0 — 0%, 1..4 — 100%
    - диммируемые светодиодные (тип 6) яркости: 0, 25, 50, 75, 100% соответственно
    - RGB, RGBW (тип 8): красный цвет яркостью от 0, 25, 50, 75, 100%
    - TW (тип 8) яркости: 0, 25, 50, 75, 100% соответственно и температуру везде 4000K

- Параллельно с инициализацией сцен в линии DALI инициализируется таблица **SCENE_LUMINAIRES**.

- Раздаются короткие DALI-адреса устройствам управления.

- Устройства управления добавляются в таблицы **BUTTON_PANELS**, **BUTTONS**, **PRES_SENSORS**, **BRIGHT_SENSORS** с **LOCATION_NUM = -1** (без локации, в корне).

- Отправляется телега приложению: `SET()`.

```mermaid
sequenceDiagram
    participant Приложение
    participant Прошивка
    participant Линия DALI

    Приложение->>Прошивка:SET.CONTROLLERS[0].STATUS(A)
    Прошивка->>Приложение:SET.CONTROLLERS[0].STATUS(A)
    Прошивка->>Линия DALI:Запуск инита
    Прошивка->>Линия DALI:Инит светильников
    Прошивка->>Линия DALI:Инит световых сцен
    Прошивка->>Линия DALI:Инит устройств упр.
    Прошивка->>Приложение:SET()
```

### 4.2. Расширение линии DALI

4.2.1. Что такое

Без изменения текущей настроенной системы в неё добавляются вновь подключенные к линии DALI устройства.

### 4.3. Замена устройства в линии DALI

4.3.1. Что такое

Замена вышедшего из строя устройства на новое того же типа с сохранением всех настроек старого.

## 5. Настройка

## 6. Оперативное управление

## 7. Работа по датчикам

## 8. Работа по расписанию

## 9. Сброс контроллера железной кнопкой

## 10. Индикация на контроллере

## 11. Вопросы

## 12. Идеи
