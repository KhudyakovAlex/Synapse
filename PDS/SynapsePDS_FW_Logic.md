# Прошивка. Логика работы

АПК Синапс v1.0. ПО. Спецификации на разработку

**Последнее изменение:** 12.12.2025, 13:05 МСК

## 1. Назначение документа

Дать разработчику исчерпывающее понимание логики работы прошивки контроллера АПК Синапс.

## 2. Базовые документы

- **SynapsePDS_FW** — описание прошивки контроллера
- **SynapsePDS_FW_DB** — структура базы данных прошивки
- **SynapsePDS_USML** — протокол обмена данными

## 3. Термины и определения

3.1. **FW-USM** (Unit System Model прошивки) — виртуальная модель системы освещения в прошивке. Представляет собой набор массивов структур языка С, хранящих состояние всех устройств DALI-линии, настройки локаций, групп, действия, расписание и другие данные. Структура описана в **SynapsePDS_FW_DB**.

3.2. **APP-USM** — виртуальная модель системы освещения в приложении (SQLite). Является кэшем FW-USM для оперативного доступа UI и LLM к данным контроллера.

3.3. **USML** (Unit System Model Language) — бинарный протокол передачи данных между прошивкой и приложением.

3.4. **Телеграмма** (телега) — команда в формате USML, содержащая изменения USM.

3.5. **Рабочие данные** — данные для организации работы освещения (яркость светильников, адреса DALI, действия датчиков и т.п.). Хранятся в прошивке в виде массивов структур C.

3.6. **Интерфейсные данные** (IDATA) — данные для UI приложения (названия, номера иконок, координаты). В прошивке хранятся единым блоком размером 50000 байт.

3.7. **ACTION** — действие, состоящее из одного или нескольких поддействий (SUBACTION).

3.8. **SUBACTION** — элементарное изменение системы освещения (включение сцены у светильника/группы/локации, установка температуры TW, переключение режима АВТО).

## 4. Базовые принципы

### 4.1. Режимы работы контроллера

4.1.1. Прошивка в контроллере может работать в двух режимах:
- **Автономный режим** — контроллер обрабатывает сигналы от настенных кнопок, датчиков присутствия, датчиков освещённости, обеспечивает работу по расписанию.
- **Режим с подключением телефонов** — дополнительно к автономному режиму осуществляется ПНР, настройка и оперативное управление системой освещения.

4.1.2. К контроллеру одновременно могут быть подключены до 4 телефонов.

### 4.2. Управление через изменение данных

4.2.1. Все команды на выполнение действий передаются от телефонов контроллеру через изменение данных FW-USM.

4.2.2. Нет команд типа "запустить инициализацию". Вместо этого приложение изменяет поле **CONTROLLERS.STATUS** = `I`, что запускает соответствующую логику в прошивке.

4.2.3. То, какой код отработает в прошивке, определяется тем, какие данные в FW-USM меняются.

4.2.4. Стандартный процесс получения, обработки и ответа прошивки на команду приложения:
- Получение телеги с изменениями USM;
- Дешифровка изменений; понимание, какой код должен отработать;
- Возможные манипуляции линией DALI (могут отсутствовать; например, при переименовании светильника);
- Внесение изменений по результатам в свою FW-USM;
- Отправка телеги приложению с изменениями в FW-USM.

4.2.5. При описании логики ниже подразумевается, что прошивка при обработке команды от приложения в итоге должна внести изменения в FW-USM и отправить соответствующую телегу приложению. Поэтому отдельно в каждой команде это не пишется.

4.3.3. После любого изменения FW-USM прошивка отправляет телегу об этом всем подключённым телефонам (до 4 шт). Тем самым обеспечивается синхронизация FW-USM и APP-USM всех телефонов.

4.3.4. В телеграммах передаются только изменившиеся данные, а не весь FW-USM целиком.

4.4.5 Пример: включение светильника. Приложение отправляет команду на включение светильника 3 с яркостью 55:

1. Телеграмма с изменением `LUMINAIRES[3].VAL_BRIGHT = 55` приходит в контроллер.
2. Контроллер видит изменение яркости и отправляет DALI-команду светильнику с адресом `LUMINAIRES[3].DALI_ADDR`.
3. Контроллер обновляет `LUMINAIRES[3].VAL_BRIGHT = 55` в своём FW-USM.
4. Изменение широковещательно отправляется телеграммой всем подключённым телефонам.

## 5. Детализация логики

Подробное описание логики работы прошивки разделено на следующие документы:

- **SynapsePDS_FW_Logic_Phone** — Взаимодействие с телефоном
- **SynapsePDS_FW_Logic_PNR** — Пуско-наладочные работы
- **SynapsePDS_FW_Logic_Settings** — Настройка
- **SynapsePDS_FW_Logic_Control** — Оперативное управление
- **SynapsePDS_FW_Logic_Sensors** — Автоматическая работа по датчикам
- **SynapsePDS_FW_Logic_Schedule** — Работа по расписанию
- **SynapsePDS_FW_Logic_Case** — Корпус контроллера
