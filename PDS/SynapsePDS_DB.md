# АПК Синапс v1.0. ПО. Спецификация на разработку. База данных

**Версия документа:** 1.0  
**Дата создания:** 22.11.2025  
**Статус:** Черновик

## 1. Основные положения

1.1. Структура базы данных одинакова в приложении и в прошивке. При этом она:
- в приложении - схема в SQLite
- в прошивке - массивы структур на языке C

1.2. Часть данных в БД актуальна только для приложения и в прошивке не используется. Эти данные хранятся в прошивке только в целях передачи их между телефонами, работающими с одним контроллером. Примеры: названия светильников, номера иконок. Эти данные хранятся в отдельном блоке памяти контроллера и передаются между приложением и прошивкой единым бинарным блоком.

## 2. Таблицы

2.1. Деление данных в прошивке/приложении:
- **Рабочие** — необходимые для организации работы освещения в прошивке и приложении (помечены в таблицах ниже жирным);
- **Интерфейсные** — используемые только приложением.

2.2. Типы данных у полей: ТИП_SQLite/ТИП_С (в SQLite приложения / в структурах языка C прошивки)

2.3. CONTROLLERS — корневая таблица с информацией о контроллерах. В прошивке имеет одну запись.

- ID (INTEGER, PK) 
- SCALE (INTEGER) — 1..3 — масштаб сетки с иконками локаций
- **NAME** (TEXT/**char[20]**) — название контроллера, показываемое в приложении и списке устройств bluetoth;
- **PASSWORD** (TEXT/**char[4]**) — пароль заводской или измененный пользователем; 4 цифры; заводской на коробке (или наклейке на корпусе);
- **IS_SCHEDULE** (INTEGER/**_Bool**) — T/F — включена ли в контроллере работа по расписанию;
- **ICO_NUM** (INTEGER/**uint8_t**) — номер иконки, которую будет иметь контроллер в приложении; 0 — дефолтная.

2.4. LOCATIONS — локации

- ID (INTEGER, PK) 
- NAME (TEXT) — название локации;
- ICO_NUM (INTEGER) — номер иконки, которую будет иметь локация в приложении; 0 — дефолтная;
- SCALE (INTEGER) — 1..3 — масштаб сетки с иконками светильников;
- POS_X (INTEGER) — 1.. - позиция слева направо по X в сетке локаций контроллера
- POS_Y (INTEGER) — 1.. - позиция сверху вниз по Y в сетке локаций контроллера
- CONTROLLER_ID (INTEGER, FK)
- **NUM** (INTEGER/**uint8_t**) — локации для идентификации локации в прошивке;
- **IS_AUTO** (INTEGER/**_Bool**) — T/F — работает ли локация в автоматическом режиме по датчикам;

2.5. LUMINAIRES — светильники

- ID (INTEGER, PK)
- NAME (TEXT) — название светильника;
- ICO_NUM (INTEGER) — номер иконки, которую будет иметь светильник в приложении; 0 — дефолтная;
- POS_X (INTEGER) — 1.. - позиция слева направо по X в сетке светильников локации
- POS_Y (INTEGER) — 1.. - позиция сверху вниз по Y в сетке светильников локации
- LOCATION_ID (INTEGER, FK)
- GROUP_ID (INTEGER, FK) - NULL, если не в группе
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки в прошивке;
- **GROUP_NUM** (INTEGER/**uint8_t**) — номер группы в DALI; 255, если не в группе;

2.6. GROUPS — группы светильников

- ID (INTEGER, PK)
- NAME (TEXT) — название группы;
- LOCATION_ID (INTEGER, FK) — идентификатор локации.
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки в прошивке;
- **DALI_NUM** (INTEGER/**uint8_t**) — номер группы в DALI;

2.7. PRES_SENSORS — датчики присутствия

- ID (INTEGER, PK)
- NAME (TEXT) — название датчика;
- LOCATION_ID (INTEGER, FK)
- ACTION_YES_ID (INTEGER, FK) - NULL - не повешено действие
- ACTION_NO_ID (INTEGER, FK) - NULL - не повешено действие
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI;
- **DALI_INST** (INTEGER/**uint8_t**) — номер инстанса в DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки в прошивке;
- **ACTION_YES_NUM** (INTEGER/**uint8_t**) - 0 - не повешено действие
- **ACTION_NO_NUM** (INTEGER/**uint8_t**) - 0 - не повешено действие
- **DELAY** (INTEGER/**uint8_t**) — задержка HOLD_TIME.

2.8. BRIGHT_SENSORS — датчики освещённости

- ID (INTEGER, PK)
- NAME (TEXT) — название датчика;
- LOCATION_ID (INTEGER, FK)
- GROUP_ID (INTEGER, FK) - NULL, если не в группе
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI;
- **DALI_INST** (INTEGER/**uint8_t**) — номер инстанса в DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки в прошивке;
- **GROUP_NUM** (INTEGER/**uint8_t**) — номер группы в DALI, которой управляет датчик; 255, если не назначена группа;

2.9. BUTTON_PANELS — кнопочные панели

- ID (INTEGER, PK)
- NAME (TEXT) — название панели;
- LOCATION_ID (INTEGER, FK)
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки в прошивке;

2.10. BUTTONS — кнопки

- ID (INTEGER, PK)
- NAME (TEXT) — название кнопки на панели;
- BUTTON_PANEL_ID (INTEGER, FK)
- ACTION_SHORT_ID (INTEGER, FK) - NULL - не повешено действие по короткому нажатию
- ACTION_LONG_ID (INTEGER, FK) - NULL - не повешено действие по долгому нажатию
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI панели;
- **DALI_INST** (INTEGER/**uint8_t**) — номер инстанса в DALI;
- **ACTION_SHORT_NUM** (INTEGER/**uint8_t**) - 0 - не повешено действие по короткому нажатию
- **ACTION_LONG_NUM** (INTEGER/**uint8_t**) - 0 - не повешено действие по долгому нажатию

2.11. ACTIONS — действия с устройствами

- ID (INTEGER, PK)
- **GROUP_ID** — идентификатор группы; если действие на группу;
- **LUMINAIRE_ID** — идентификатор светильника; если действие на отдельный светильник;
- **SCENE_ID** — идентификатор сцены;
- **VAL_BRIGHT** — значение яркости;
- **VAL_TW** — значение температуры белого света;
- **VAL_R** — значение красного канала (для RGB);
- **VAL_G** — значение зеленого канала (для RGB);
- **VAL_B** — значение синего канала (для RGB);
- **VAL_W** — значение белого канала (для RGBW).

2.12. EVENTS — события расписания

- **DATE_EVERYDAY** — T/F — ежедневное событие;
- **DATE_DAYS** — 'FFTFFFF' — событие по дням недели;
- **TIME** — время события с точностью до минуты;
- **SMOOTH** — T/F — плавное изменение параметра от предыдущего значения (яркость, температура света);
- **ACTION_ID** — идентификатор действия.