# АПК Синапс v1.0. ПО. Спецификация на разработку. База данных

**Версия документа:** 1.0  
**Дата создания:** 22.11.2025  
**Статус:** Черновик

## 1. Основные положения

1.1. Структура базы данных одинакова в приложении и в прошивке. При этом она:

- в приложении в виде схемы в SQLite;
- в прошивке как массивы структур на языке C.

1.2. Часть данных в БД актуальна только для приложения и в прошивке не используется (**Интерфейсные** данные). Эти данные хранятся в прошивке только в целях передачи их между телефонами, работающими с одним контроллером. Примеры: названия светильников, номера иконок. Эти данные хранятся в отдельном блоке памяти контроллера и передаются между приложением и прошивкой единым бинарным блоком.

## 2. Таблицы

2.1. Деление данных в прошивке/приложении:

- **Рабочие** — необходимые для организации работы освещения в прошивке и приложении (помечены в таблицах ниже жирным);
- **Интерфейсные** — используемые только приложением.

2.2. Типы данных у полей ниже: (ТИП_SQLite/ТИП_С) (в SQLite приложения / в структурах языка C прошивки).

2.3. **CONTROLLERS** — корневая таблица с информацией о контроллерах. В прошивке имеет одну запись.

- ID (INTEGER, PK) — идентификатор в приложении;
- SCALE (INTEGER) — масштаб сетки с иконками локаций на странице контроллера;
- **NAME** (TEXT/**char[20]**) — название контроллера, показываемое в приложении и списке устройств Bluetooth;
- **PASSWORD** (TEXT/**char[4]**) — пароль заводской или изменённый пользователем; 4 цифры; заводской на коробке (или наклейке на корпусе);
- **IS_SCHEDULE** (INTEGER/**_Bool**) — T/F — включена ли в контроллере работа по расписанию;
- **ICO_NUM** (INTEGER/**uint8_t**) — номер иконки, которую будет иметь контроллер в приложении; 0 — дефолтная.

2.4. **LOCATIONS** — локации.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название локации;
- ICO_NUM (INTEGER) — номер иконки, которую будет иметь локация в приложении; 0 — дефолтная;
- SCALE (INTEGER) — масштаб сетки с иконками светильников на странице локации;
- POS_X (INTEGER) — позиция слева направо по X в сетке локаций контроллера;
- POS_Y (INTEGER) — позиция сверху вниз по Y в сетке локаций контроллера;
- CONTROLLER_ID (INTEGER, FK);
- **NUM** (INTEGER/**uint8_t**) — номер локации для идентификации локации в прошивке;
- **IS_AUTO** (INTEGER/**_Bool**) — работает ли локация в автоматическом режиме по датчикам (0/1).

2.5. **LUMINAIRES** — светильники.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название светильника;
- ICO_NUM (INTEGER) — номер иконки, которую будет иметь светильник в приложении; 0 — дефолтная;
- POS_X (INTEGER) — позиция слева направо по X в сетке светильников локации;
- POS_Y (INTEGER) — позиция сверху вниз по Y в сетке светильников локации;
- LOCATION_ID (INTEGER, FK);
- GROUP_ID (INTEGER, FK) — группа, в которую включён светильник; если не в группе — NULL;
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки светильника к ней в прошивке;
- **GROUP_NUM** (INTEGER/**uint8_t**) — номер группы в DALI для привязки светильника в прошивке; если светильник не в группе — 255;
- **VAL_BRIGHT** (INTEGER/**uint8_t**) — значение яркости;
- **VAL_TW** (INTEGER/**uint8_t**) — значение температуры белого света;
- **VAL_R** (INTEGER/**uint8_t**) — значение красного канала (для RGB);
- **VAL_G** (INTEGER/**uint8_t**) — значение зелёного канала (для RGB);
- **VAL_B** (INTEGER/**uint8_t**) — значение синего канала (для RGB);
- **VAL_W** (INTEGER/**uint8_t**) — значение белого канала (для RGBW).

2.6. **SCENE_LUMINAIRES** — параметры светильников в сценах.

- ID (INTEGER, PK) — идентификатор в приложении;
- LUMINAIRE_ID (INTEGER, FK) — светильник в приложении;
- **DALI_ADDR** (INTEGER/**uint8_t**) — адрес светильника в DALI;
- **SCENE_NUM** (INTEGER/**uint8_t**) — номер сцены в DALI;
- **VAL_BRIGHT** (INTEGER/**uint8_t**) — значение яркости;
- **VAL_TW** (INTEGER/**uint8_t**) — значение температуры белого света;
- **VAL_R** (INTEGER/**uint8_t**) — значение красного канала (для RGB);
- **VAL_G** (INTEGER/**uint8_t**) — значение зелёного канала (для RGB);
- **VAL_B** (INTEGER/**uint8_t**) — значение синего канала (для RGB);
- **VAL_W** (INTEGER/**uint8_t**) — значение белого канала (для RGBW).

2.7. **GROUPS** — группы светильников.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название группы;
- LOCATION_ID (INTEGER, FK) — идентификатор локации;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки группы к ней в прошивке;
- **DALI_NUM** (INTEGER/**uint8_t**) — номер группы в DALI;
- **SCENE_BRIGHT_0** (INTEGER/**uint8_t**) — целевая освещённость при сцене 0;
- **SCENE_BRIGHT_1** (INTEGER/**uint8_t**) — целевая освещённость при сцене 1;
- **SCENE_BRIGHT_2** (INTEGER/**uint8_t**) — целевая освещённость при сцене 2;
- **SCENE_BRIGHT_3** (INTEGER/**uint8_t**) — целевая освещённость при сцене 3;
- **SCENE_BRIGHT_4** (INTEGER/**uint8_t**) — целевая освещённость при сцене 4.

2.8. **PRES_SENSORS** — датчики присутствия.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название датчика;
- LOCATION_ID (INTEGER, FK);
- ACTION_YES_ID (INTEGER, FK) — действие на наличие движения; NULL — не повешено действие;
- ACTION_NO_ID (INTEGER, FK) — действие на отсутствие движения; NULL — не повешено действие;
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI датчика;
- **DALI_INST** (INTEGER/**uint8_t**) — номер инстанса датчика движения в DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки датчика к ней в прошивке;
- **ACTION_YES_NUM** (INTEGER/**uint8_t**) — номер действия для прошивки; 0 — не повешено действие;
- **ACTION_NO_NUM** (INTEGER/**uint8_t**) — номер действия для прошивки; 0 — не повешено действие;
- **DELAY** (INTEGER/**uint8_t**) — задержка HOLD_TIME.

2.9. **BRIGHT_SENSORS** — датчики освещённости.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название датчика;
- LOCATION_ID (INTEGER, FK);
- GROUP_ID (INTEGER, FK) — группа, которой управляет датчик; NULL, если группа не назначена;
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес датчика в DALI;
- **DALI_INST** (INTEGER/**uint8_t**) — номер инстанса датчика движения в DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки датчика к ней в прошивке;
- **GROUP_NUM** (INTEGER/**uint8_t**) — номер группы в DALI, которой управляет датчик; 255, если не назначена группа.

2.10. **BUTTON_PANELS** — кнопочные панели.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название панели;
- LOCATION_ID (INTEGER, FK);
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес панели в DALI;
- **LOCATION_NUM** (INTEGER/**uint8_t**) — идентификатор локации для привязки в прошивке.

2.11. **BUTTONS** — кнопки.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название кнопки на панели;
- BUTTON_PANEL_ID (INTEGER, FK);
- ACTION_SHORT_ID (INTEGER, FK) — действие по короткому нажатию; не повешено — NULL;
- ACTION_LONG_ID (INTEGER, FK) — действие по долгому нажатию; не повешено — NULL;
- **DALI_ADDR** (INTEGER/**uint8_t**) — короткий адрес DALI панели;
- **DALI_INST** (INTEGER/**uint8_t**) — номер инстанса кнопки в DALI;
- **ACTION_SHORT_NUM** (INTEGER/**uint8_t**) — действие по короткому нажатию; 0 — не повешено действие;
- **ACTION_LONG_NUM** (INTEGER/**uint8_t**) — действие по долгому нажатию; 0 — не повешено действие.

2.12. **ACTIONS** — действия с устройствами.

- ID (INTEGER, PK) — идентификатор в приложении;
- **NUM** (INTEGER/**uint8_t**) — номер действия для идентификации действия в прошивке.

2.13. **SUBACTIONS** — поддействия с устройствами.

- ID (INTEGER, PK) — идентификатор в приложении;
- ACTION_ID (INTEGER) — действие (для приложения);
- **ACTION_NUM** (INTEGER/**uint8_t**) — действие (для прошивки);
- **OBJECT_NUM** (INTEGER/**uint8_t**) — объект изменений:
    - 0 — весь объект;
    - 1–16 — локация;
    - 17–32 — группа;
    - 33–96 — светильник;
    - 100 — весь объект, меняем TW;
    - 101–116 — локация, меняем TW;
    - 117–132 — группа, меняем TW;
    - 133–196 — светильник, меняем TW;
    - 201–216 — локация, меняем АВТО.
- **VALUE** (INTEGER/**uint8_t**) — значение в зависимости от объекта:
    - 0–96 — сцена;
    - 100–196 — температура света;
    - 201–216 — 0/1 (выкл/вкл).

2.14. **EVENTS** — события расписания.

- ID (INTEGER, PK) — идентификатор в приложении;
- ACTION_ID (INTEGER) — действие (для приложения);
- **DAYS** (TEXT/**char[7]**) — 'FFTFFFF' — событие по дням недели; если все F — ежедневное;
- **TIME** (TEXT/**char[4]**) — время события с точностью до минуты в формате HHMM 24H;
- **SMOOTH** (INTEGER/**_Bool**) — плавное изменение параметров от предыдущих значений (яркость, температура света);
- **ACTION_NUM** (INTEGER/**uint8_t**) — действие (для прошивки).

## 3. Ограничения по количеству записей в таблицах (для прошивки)

3.1. **CONTROLLERS** — 1.

3.2. **LOCATIONS** — 16.

3.3. **LUMINAIRES** — 64.

3.4. **SCENE_LUMINAIRES** — 320.

3.5. **GROUPS** — 16.

3.6. **PRES_SENSORS** — 64.

3.7. **BRIGHT_SENSORS** — 64.

3.8. **BUTTON_PANELS** — 64.

3.9. **BUTTONS** — 64.

3.10. **ACTIONS** — 255.

3.11. **SUBACTIONS** — 255.

3.12. **EVENTS** — 255.

