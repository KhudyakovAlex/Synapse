# Прошивка. Логика работы. ПНР

АПК Синапс v1.0. ПО. Спецификации на разработку

**Последнее изменение:** 13.12.2025, 06:57 МСК

## 1. Сохранение IDATA

1.1. Блок интерфейсных данных IDATA хранится в энергонезависимой памяти контроллера. Он хранит все редко изменяемые ПНР-данные кроме ПНР-данных требующихся в линии DALI и полей в таблице CONTROLLERS.

1.2. При любом изменении интерфейсных данных через приложение прошивка получает телеграмму с новым блоком IDATA и записывает его в энергонезависимую память.

1.2. Часть телеграмм от приложения содержит и рабочие измененные данные и интерфейсные (в IDATA).

1.3. При инициализации линии DALI блок IDATA сбрасывается.

## 2. Изменение параметров контроллера

7.2.1. Изменение имени, иконки и пароля контроллера — это изменение полей **CONTROLLERS.NAME**, **CONTROLLERS.ICO_NUM**, **CONTROLLERS.PASSWORD** (отдельные поля, не в IDATA).

7.2.2. Приложение отправляет телеграмму с изменёнными полями контроллера.

7.2.3. Если изменилось имя или иконка контроллера:
- Прошивка обновляет имя Bluetooth-устройства;
- Новое имя формата: `[ICO]Name`.

## 2. Инициализация линии DALI

2.1. Инициализация стартуется телеграммой с изменением **CONTROLLERS.STATUS** = `I`.

2.2. При получении этой телеграммы прошивка:
- Сбрасывает все данные FW-USM (кроме NAME, PASSWORD, ICO_NUM контроллера);
- Сбрасывает состояние всех устройств в линии DALI к состоянию RESET (DALI-команда);
- Ставит в своей USM **CONTROLLERS.STATUS** = `I`.

2.3. Прошивка производит инициализацию светильников:
- Широковещательно выключает все светильники (DALI-команда);
- Выполняет поиск устройств в линии DALI;
- Присваивает каждому найденному светильнику короткий адрес;
- Добавляет светильники в FW-USM с:
  - `EXIST = T`;
  - `LOCATION_ID = -1` (без локации);
  - `GROUP_ID = -1` (без группы);
  - `DALI_ADDR` — присвоенный короткий адрес;
  - Начальными значениями VAL_BRIGHT, VAL_TW и т.д. из устройства-светильника DALI;
  - `STATUS = A`.
- Включает светильник (DALI-команда) после присвоения адреса.

2.4. Прошивка инициализирует сцены 0-4 во всех DALI-светильниках и своей USM:
- Сцена 0: яркость 0% (выключено);
- Сцена 1: яркость 25%;
- Сцена 2: яркость 50%;
- Сцена 3: яркость 75%;
- Сцена 4: яркость 100%;
- Для RGB-светильников: красный цвет с максимальной насыщенностью.

2.5. Прошивка производит инициализацию устройств управления (датчики, кнопочные панели):
- Выполняет поиск устройств в линии DALI;
- Присваивает короткие адреса;
- Добавляет в FW-USM с:
  - `EXIST = T`;
  - `LOCATION_ID = -1` (без локации);
  - `STATUS = A`;
  - Остальные поля — по умолчанию (для датчиков присутствия ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1, для кнопок ACTION_SET_SHORT_NUM = -1, ACTION_LONG_ID = -1).
- Включает светодиоды на кнопочных панелях (DALI-команда).

2.6. После завершения инициализации прошивка:
- Ставит в своей USM **CONTROLLERS.STATUS** = `A`;
- Рассылает финальное состояние FW-USM всем телефонам.

## 3. Расширение линии DALI

3.1. Расширение стартуется телеграммой с изменением **CONTROLLERS.STATUS** = `E` (расширение).

3.2. Расширение производится аналогично инициализации, но **без сброса FW-USM**.

3.3. Прошивка:
- Выполняет поиск устройств в линии DALI;
- Находит устройства без короткого адреса (новые);
- Присваивает им адреса;
- Добавляет в свободные слоты FW-USM (где `EXIST = F`).

3.4. Новые устройства добавляются с дефолтными параметрами без локации и группы.

## 4. Замена устройства в линии DALI

4.1. Замена стартуется телеграммой с изменением **LUMINAIRES[i].STATUS** = `C` (или **PRES_SENSORS[i].STATUS** = `C` и т.д.).

4.2. Прошивка выполняет расширение линии (как в разделе 3).

4.3. Прошивка находит устройства того же типа без привязки (новые).

4.4. Если найдено одно новое устройство нужного типа:
- Прошивка копирует все настройки из записи заменяемого устройства в запись нового;
- Присваивает новому устройству короткий адрес старого (DALI-команда);
- Отправляет необходимые DALI-команды для установки параметров (MIN_LEVEL, MAX_LEVEL, FADE_TIME и т.д.);
- Ставит **STATUS** = `A`.

4.5. Прошивка рассылает изменения всем телефонам.

## 5. Локации и распределение по ним устройств

5.1. **Создание локации**: приложение отправляет телеграмму с изменением **LOCATIONS[i].EXIST** = `T` для свободного слота. При этом в телеге возможны и другие изменения, в том числе в IDATA, где хранится имя локации.
Значения у IS_AUTO и SCENE_NUM устанавливаются по умолчанию.

5.2. **Помещение устройства в локацию**: приложение отправляет телеграмму с изменением **LUMINAIRES[j].LOCATION_ID** = `i`. Аналогично для кнопок и датчиков.

5.3. **Удаление локации**: приложение отправляет телеграмму с изменением **LOCATIONS[i].EXIST** = `F`. Если в локации есть устройства, всем им назначается **LOCATIONS_ID = -1**.

## 6. Группы и распределение по ним устройств

6.1. **Создание группы**: приложение отправляет телеграмму с изменением **GROUPS[i].EXIST** = `T` и **GROUPS[i].LOCATION_ID** = `loc` (или -1 для корня). При этом в телеге возможны и другие изменения, в том числе в IDATA, где хранится имя группы.

6.2. **Добавление светильника в группу**: приложение отправляет телеграмму с изменением **LUMINAIRES[j].GROUP_ID** = `i`. Прошивка отправляет DALI-команду присвоения светильника группе i.

6.3. **Удаление группы**: приложение отправляет телеграмму с изменением **GROUPS[i].EXIST** = `F`. Прошивка убирает у всех светильников с **GROUP_ID** = `i` привязку к группе (GROUP_ID = -1) и отправляет соответствующие DALI-команды.

## 8. Действия, поддействия и наборы действий

Немного теории.

8.1. **Поддействие (таблица SUBACTIONS)** — элементарное изменение системы освещения:
- Включение сцены у светильника/группы/локации/контроллера;
- Установка температуры белого света (TW);
- Переключение режима АВТО и т.п.

Со стороны пользователя поддействия создаются внутри действий и при удалении последних вместе с ними же и удаляются.

8.2. **Действие (таблица ACTIONS)** — состоит из одного или нескольких поддействий, выполняемых одним пакетом. Например, действие "Вечерний свет" может включать:
- Включение сцены 2 в гостиной;
- Включение сцены 1 в коридоре;
- Установка температуры 2700K во всех светильниках.

Навешиваются на кнопки, датчики, события расписания. Не существует какого-то справочника действий: со стороны пользователя действия создаются каждый раз как обработчики нажатий кнопок, сигналов датчиков, события в расписании.

8.3. **Набор действий (отдельной таблицы нет)** — группа действий, объединённых для перебора. Используется для привязки к кнопке нескольких действий, которые переключаются последовательно при каждом КОРОТКОМ нажатии на кнопку. Например:
- Действие 1: "Яркий свет" (позиция 1);
- Действие 2: "Средний свет" (позиция 2);
- Действие 3: "Тусклый свет" (позиция 3).

Навешиваются ТОЛЬКО на короткие нажатия кнопок. Специальной таблицы в БД с наборами нет. В поле **ACTIONS.BUTTON_SHORT_ID** нескольких действий записывается ссылка на одну и ту же кнопку. Все действия с одинаковым BUTTON_SHORT_ID образуют набор для этой кнопки. Вот и вся связь.

## 9. Добавление/удаление поддействия в/из действия

9.1. Опишем процесс добавления поддействия в действие здесь и сразу, т.к. он позже будет встречаться несколько раз.

9.2. Добавление поддействия — телега с записью **SUBACTIONS[j]**:
- **ACTION_ID** = `i`;
- **OBJECT_TYPE** = тип объекта (1-контроллер, 2-локация, 3-группа, 4-светильник);
- **OBJECT_NUM** = номер объекта;
- **VALUE** = значение (номер сцены, температура TW, флаг АВТО).

9.3. Удаление поддействия — **SUBACTIONS[j].ACTION_ID** = -1.

## 10. Назначение действий на датчики присутствия

10.1. Назначение на присутствие — **PRES_SENSORS[i].ACTION_OCCUPANCY_ID** = `j` (j - ID действия из числа свободных).

10.2. Снятие назначения на присутствие:
- **PRES_SENSORS[i].ACTION_OCCUPANCY_ID** = -1;
- Прошивка всем поддействиям с ACTION_ID = очищаемого ACTION_OCCUPANCY_ID ставит ACTION_ID = -1.

10.3. Назначение на отсутствие — **PRES_SENSORS[i].ACTION_VACANCY_ID** = `j` (j - ID действия из числа свободных).

10.4. Снятие назначения на отсутствие:
- **PRES_SENSORS[i].ACTION_VACANCY_ID** = -1;
- Прошивка всем поддействиям с ACTION_ID = очищаемого ACTION_VACANCY_ID ставит ACTION_ID = -1.

10.5. После этого пользователь добавляет в действие поддействия (см. раздел 9), но это уже отдельные телеги.

## 11. Привязка датчиков освещённости к группам светильников

11.1. Приложение отправляет телеграмму с изменением **BRIGHT_SENSORS[i].GROUP_ID** = `j`.

11.2. Прошивка последовательно переводит светильники группы в сцены 0-4 (DALI-команды).

11.3. Для каждой сцены N (0-4) прошивка:
- Считывает текущую освещённость с датчика (DALI-команда);
- Сохраняет значение в соответствующее поле **BRIGHT_SENSORS[i].SCENE_BRIGHTNESS_N**;
- Например, для сцены 0 → **SCENE_BRIGHTNESS_0**, для сцены 1 → **SCENE_BRIGHTNESS_1** и т.д.

## 12. Назначение действий на настенные кнопки

### 12.1. Короткое нажатие (набор действий)

12.1.1. Добавление действия в набор:
- **ACTIONS[j].BUTTON_SHORT_ID** = `i` (ссылка на кнопку);
- **ACTIONS[j].POS** = `pos`.

12.1.3. Пересортировка действий в наборе:
- Приложение отправляет телеграмму с изменёнными **ACTIONS[j].POS**, **ACTIONS[k].POS** и т.д. для нескольких действий одновременно;
- Прошивка обновляет позиции действий в наборе.

12.1.4. После добавления действия пользователь добавляет в действие поддействия (см. раздел 9), но это уже отдельные телеги.

12.1.5. Удаление действия из набора:
- **ACTIONS[j].BUTTON_SHORT_ID** = -1.

### 12.2. Долгое нажатие (одно действие)

12.2.1. Добавление действия на долгое нажатие:
- **ACTIONS[j].BUTTON_LONG_ID** = `i`.

12.2.2. После добавления действия пользователь добавляет в действие поддействия (см. раздел 9), но это уже отдельные телеги.

12.2.3. Удаление действия:
- **ACTIONS[j].BUTTON_LONG_ID** = -1.

