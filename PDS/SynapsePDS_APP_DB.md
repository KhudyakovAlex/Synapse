# Приложение. База данных

АПК Синапс v1.0. ПО. Спецификации на разработку

**Последнее изменение:** 04.12.2025

## 1. Термины и определения

1.1. **Рабочие** данные — необходимые для организации работы освещения и в прошивке, и в приложении. В приложении находятся в таблицах SQLite, в прошивке в виде массивов структур C.

1.2. **Интерфейсные** данные — используемые только приложением для организации пользовательского интерфейса.  Примеры: названия светильников, номера их иконок.. В приложении находятся в таблицах SQLite, в прошивке в виде единого блока где-то в постоянной памяти.

## 2. Основные положения

2.1. База данных в приложении представлена в виде схемы в SQLite.

2.5. Большинство таблиц имеет два параллельных типа идентификаторов (поскольку в прошивке ID нет):

- **ID** — для идентификации записей в приложении;
- **NUM/DALI_ADDR/DALI_NUM/DALI_INST** — для идентификации записей в прошивке.

## 3. Таблицы

3.1. **Рабочие** данные помечены в таблицах ниже жирным.

### 3.3. CONTROLLERS

Корневая таблица с информацией о контроллерах. В прошивке имеет одну запись.

- ID (INTEGER, PK) — идентификатор в приложении;
- SCALE (INTEGER) — масштаб сетки с иконками локаций на странице контроллера;
- **NAME** (TEXT*) — название контроллера, показываемое в приложении и списке устройств Bluetooth;
- **PASSWORD** (TEXT) — пароль заводской или изменённый пользователем; 4 цифры; заводской на коробке (или наклейке на корпусе);
- **IS_SCHEDULE** (INTEGER) — T/F — включена ли в контроллере работа по расписанию;
- **ICO_NUM** (INTEGER) — номер иконки, которую будет иметь контроллер в приложении; 0 — дефолтная.

### 3.4. LOCATIONS

Локации.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название локации;
- ICO_NUM (INTEGER) — номер иконки, которую будет иметь локация в приложении; 0 — дефолтная;
- SCALE (INTEGER) — масштаб сетки с иконками светильников на странице локации;
- POS_X (INTEGER) — позиция слева направо по X в сетке локаций контроллера;
- POS_Y (INTEGER) — позиция сверху вниз по Y в сетке локаций контроллера;
- CONTROLLER_ID (INTEGER, FK);
- **NUM** (INTEGER) — номер локации для идентификации локации в прошивке;
- **IS_AUTO** (INTEGER) — работает ли локация в автоматическом режиме по датчикам (0/1).

### 3.5. LUMINAIRES

Светильники.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название светильника;
- ICO_NUM (INTEGER) — номер иконки, которую будет иметь светильник в приложении; 0 — дефолтная;
- POS_X (INTEGER) — позиция слева направо по X в сетке светильников локации;
- POS_Y (INTEGER) — позиция сверху вниз по Y в сетке светильников локации;
- LOCATION_ID (INTEGER, FK);
- GROUP_ID (INTEGER, FK) — группа, в которую включён светильник; если не в группе — NULL;
- **DALI_ADDR** (INTEGER) — короткий адрес DALI;
- **LOCATION_NUM** (INTEGER) — идентификатор локации для привязки светильника к ней в прошивке;
- **GROUP_NUM** (INTEGER) — номер группы в DALI для привязки светильника в прошивке; если светильник не в группе — 255;
- **VAL_BRIGHT** (INTEGER) — значение яркости;
- **VAL_TW** (INTEGER) — значение температуры белого света;
- **VAL_R** (INTEGER) — значение красного канала (для RGB);
- **VAL_G** (INTEGER) — значение зелёного канала (для RGB);
- **VAL_B** (INTEGER) — значение синего канала (для RGB);
- **VAL_W** (INTEGER) — значение белого канала (для RGBW).

### 3.6. SCENE_LUMINAIRES

Параметры светильников в сценах.

- ID (INTEGER, PK) — идентификатор в приложении;
- LUMINAIRE_ID (INTEGER, FK) — светильник в приложении;
- **DALI_ADDR** (INTEGER) — адрес светильника в DALI;
- **SCENE_NUM** (INTEGER) — номер сцены в DALI;
- **VAL_BRIGHT** (INTEGER) — значение яркости;
- **VAL_TW** (INTEGER) — значение температуры белого света;
- **VAL_R** (INTEGER) — значение красного канала (для RGB);
- **VAL_G** (INTEGER) — значение зелёного канала (для RGB);
- **VAL_B** (INTEGER) — значение синего канала (для RGB);
- **VAL_W** (INTEGER) — значение белого канала (для RGBW).

### 3.7. GROUPS

Группы светильников.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название группы;
- LOCATION_ID (INTEGER, FK) — идентификатор локации;
- **LOCATION_NUM** (INTEGER) — идентификатор локации для привязки группы к ней в прошивке;
- **DALI_NUM** (INTEGER) — номер группы в DALI.

### 3.8. PRES_SENSORS

Датчики присутствия.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название датчика;
- LOCATION_ID (INTEGER, FK);
- ACTION_OCCUPANCY_ID (INTEGER, FK) — действие на наличие движения; NULL — не повешено действие;
- ACTION_VACANCY_ID (INTEGER, FK) — действие на отсутствие движения; NULL — не повешено действие;
- **DALI_ADDR** (INTEGER) — короткий адрес DALI датчика;
- **DALI_INST** (INTEGER) — номер инстанса датчика движения в DALI;
- **ACTION_OCCUPANCY_NUM** (INTEGER) — номер действия для прошивки; 0 — не повешено действие;
- **ACTION_VACANCY_NUM** (INTEGER) — номер действия для прошивки; 0 — не повешено действие;
- **DELAY** (INTEGER) — задержка HOLD_TIME.

### 3.9. BRIGHT_SENSORS

Датчики освещённости.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название датчика;
- LOCATION_ID (INTEGER, FK);
- GROUP_ID (INTEGER, FK) — группа, которой управляет датчик; NULL, если группа не назначена;
- **DALI_ADDR** (INTEGER) — короткий адрес датчика в DALI;
- **DALI_INST** (INTEGER) — номер инстанса датчика движения в DALI;
- **GROUP_NUM** (INTEGER) — номер группы в DALI, которой управляет датчик; 255, если не назначена группа.

### 3.10. BUTTON_PANELS

Кнопочные панели.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название панели;
- LOCATION_ID (INTEGER, FK);
- **DALI_ADDR** (INTEGER) — короткий адрес панели в DALI;

### 3.11. BUTTONS

Кнопки.

- ID (INTEGER, PK) — идентификатор в приложении;
- NAME (TEXT) — название кнопки на панели;
- BUTTON_PANEL_ID (INTEGER, FK);
- ACTION_SET_SHORT_ID (INTEGER, FK) — действие по короткому нажатию; не повешено — NULL;
- ACTION_LONG_ID (INTEGER, FK) — действие по долгому нажатию; не повешено — NULL;
- **DALI_ADDR** (INTEGER) — короткий адрес DALI панели;
- **DALI_INST** (INTEGER) — номер инстанса кнопки в DALI;
- **ACTION_SET_SHORT_NUM** (INTEGER) — действие по короткому нажатию; 0 — не повешено действие;
- **ACTION_LONG_NUM** (INTEGER) — действие по долгому нажатию; 0 — не повешено действие.

### 3.12. ACTIONS

Действия с устройствами.

- ID (INTEGER, PK) — идентификатор в приложении;
- ACTION_SET_ID  (INTEGER, FK) - привязка к набору действий; если действие не входит ни в какой набор - NULL
- **ACTION_SET_NUM** (INTEGER) — привязка к набору действий; если действие не входит ни в какой набор - 0 (для прошивки);
- **NUM** (INTEGER) — номер действия для идентификации действия в прошивке.
- **POS** (INTEGER) — номер по порядку действия (начиная с 1) в списке действий, привязанных к кнопке (случай перебора действий одной кнопкой)

### 3.13. SUBACTIONS

Поддействия с устройствами (команды для пользователя).

- ID (INTEGER, PK) — идентификатор в приложении;
- ACTION_ID (INTEGER) — действие (для приложения);
- **ACTION_NUM** (INTEGER) — действие (для прошивки);
- **OBJECT_TYPE** (INTEGER) — тип объекта изменений:
    - 1 — весь объект;
    - 2 — локация;
    - 3 — группа;
    - 4 — светильник;
- **OBJECT_NUM** (INTEGER) — номер объекта изменений:
    - 1 — сцена;
    - 2 — температура TW;
    - 3 — флаг АВТО.
- **VALUE** (INTEGER) — значение в зависимости от объекта:
    - сцена - 0..4;
    - температура TW - 0..254;
    - флаг АВТО - 0 / 1.


### 3.14. ACTION_SETS

Наборы действий для навешивания на короткие нажатия кнопок (когда перебираем действия одной кнопкой).
- ID (INTEGER, PK) — идентификатор в приложении;
- **NUM** (INTEGER) — номер набора действий для идентификации в прошивке; начинается с 1

### 3.15. EVENTS

События расписания.

- ID (INTEGER, PK) — идентификатор в приложении;
- ACTION_ID (INTEGER) — действие (для приложения);
- **DAYS** (TEXT) — 'FFTFFFF' — событие по дням недели; если все F — ежедневное;
- **TIME** (TEXT) — время события с точностью до минуты в формате HHMM 24H;
- **SMOOTH** (INTEGER) — плавное изменение параметров от предыдущих значений (яркость, температура света);
- **ACTION_NUM** (INTEGER) — действие (для прошивки).



## 5. Вопросы

5.1. Рабочие данные таки храним в Си или переносим в одну область с интерфейсными?

5.2. Как рабочие и интерфейсные данные будут попадать во флэш-память?

5.3. Не будет ли заморочным в смысле размера кода работать с бинарным блоком рабочих данных как с базой?

5.4. Как храим в БД заначения для димм., РГБ и ТВ?

## 6. Идеи
