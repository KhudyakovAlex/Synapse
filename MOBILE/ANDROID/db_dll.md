# АПК Синапс v1.0. DDL для SQLite

**Версия документа:** 1.0  
**Дата создания:** 23.11.2025  
**Статус:** Черновик

## Описание

DDL (Data Definition Language) для создания структуры базы данных SQLite в Android-приложении.

## Создание таблиц

### 1. CONTROLLERS

```sql
CREATE TABLE IF NOT EXISTS CONTROLLERS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    SCALE INTEGER DEFAULT 1,
    NAME TEXT NOT NULL,
    PASSWORD TEXT NOT NULL CHECK(length(PASSWORD) = 4),
    IS_SCHEDULE INTEGER NOT NULL DEFAULT 0 CHECK(IS_SCHEDULE IN (0, 1)),
    ICO_NUM INTEGER NOT NULL DEFAULT 0
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_controllers_name ON CONTROLLERS(NAME);
```

### 2. LOCATIONS

```sql
CREATE TABLE IF NOT EXISTS LOCATIONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    ICO_NUM INTEGER DEFAULT 0,
    SCALE INTEGER DEFAULT 1,
    POS_X INTEGER DEFAULT 0,
    POS_Y INTEGER DEFAULT 0,
    CONTROLLER_ID INTEGER NOT NULL,
    NUM INTEGER NOT NULL,
    IS_AUTO INTEGER NOT NULL DEFAULT 0 CHECK(IS_AUTO IN (0, 1)),
    FOREIGN KEY (CONTROLLER_ID) REFERENCES CONTROLLERS(ID) ON DELETE CASCADE
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_locations_controller ON LOCATIONS(CONTROLLER_ID);
CREATE INDEX IF NOT EXISTS idx_locations_num ON LOCATIONS(NUM);
```

### 3. LUMINAIRES

```sql
CREATE TABLE IF NOT EXISTS LUMINAIRES (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    ICO_NUM INTEGER DEFAULT 0,
    POS_X INTEGER DEFAULT 0,
    POS_Y INTEGER DEFAULT 0,
    LOCATION_ID INTEGER NOT NULL,
    GROUP_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    GROUP_NUM INTEGER NOT NULL DEFAULT 255,
    VAL_BRIGHT INTEGER NOT NULL DEFAULT 0 CHECK(VAL_BRIGHT >= 0 AND VAL_BRIGHT <= 255),
    VAL_TW INTEGER NOT NULL DEFAULT 0 CHECK(VAL_TW >= 0 AND VAL_TW <= 255),
    VAL_R INTEGER NOT NULL DEFAULT 0 CHECK(VAL_R >= 0 AND VAL_R <= 255),
    VAL_G INTEGER NOT NULL DEFAULT 0 CHECK(VAL_G >= 0 AND VAL_G <= 255),
    VAL_B INTEGER NOT NULL DEFAULT 0 CHECK(VAL_B >= 0 AND VAL_B <= 255),
    VAL_W INTEGER NOT NULL DEFAULT 0 CHECK(VAL_W >= 0 AND VAL_W <= 255),
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE,
    FOREIGN KEY (GROUP_ID) REFERENCES GROUPS(ID) ON DELETE SET NULL
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_luminaires_location ON LUMINAIRES(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_luminaires_group ON LUMINAIRES(GROUP_ID);
CREATE INDEX IF NOT EXISTS idx_luminaires_dali ON LUMINAIRES(DALI_ADDR);
```

### 4. SCENE_LUMINAIRES

```sql
CREATE TABLE IF NOT EXISTS SCENE_LUMINAIRES (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    LUMINAIRE_ID INTEGER NOT NULL,
    DALI_ADDR INTEGER NOT NULL,
    SCENE_NUM INTEGER NOT NULL,
    VAL_BRIGHT INTEGER NOT NULL DEFAULT 0 CHECK(VAL_BRIGHT >= 0 AND VAL_BRIGHT <= 255),
    VAL_TW INTEGER NOT NULL DEFAULT 0 CHECK(VAL_TW >= 0 AND VAL_TW <= 255),
    VAL_R INTEGER NOT NULL DEFAULT 0 CHECK(VAL_R >= 0 AND VAL_R <= 255),
    VAL_G INTEGER NOT NULL DEFAULT 0 CHECK(VAL_G >= 0 AND VAL_G <= 255),
    VAL_B INTEGER NOT NULL DEFAULT 0 CHECK(VAL_B >= 0 AND VAL_B <= 255),
    VAL_W INTEGER NOT NULL DEFAULT 0 CHECK(VAL_W >= 0 AND VAL_W <= 255),
    FOREIGN KEY (LUMINAIRE_ID) REFERENCES LUMINAIRES(ID) ON DELETE CASCADE,
    UNIQUE(LUMINAIRE_ID, SCENE_NUM)
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_scene_luminaires_luminaire ON SCENE_LUMINAIRES(LUMINAIRE_ID);
CREATE INDEX IF NOT EXISTS idx_scene_luminaires_scene ON SCENE_LUMINAIRES(SCENE_NUM);
CREATE INDEX IF NOT EXISTS idx_scene_luminaires_dali ON SCENE_LUMINAIRES(DALI_ADDR);
```

### 5. GROUPS

```sql
CREATE TABLE IF NOT EXISTS GROUPS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    DALI_NUM INTEGER NOT NULL,
    SCENE_BRIGHT_0 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_0 >= 0 AND SCENE_BRIGHT_0 <= 255),
    SCENE_BRIGHT_1 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_1 >= 0 AND SCENE_BRIGHT_1 <= 255),
    SCENE_BRIGHT_2 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_2 >= 0 AND SCENE_BRIGHT_2 <= 255),
    SCENE_BRIGHT_3 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_3 >= 0 AND SCENE_BRIGHT_3 <= 255),
    SCENE_BRIGHT_4 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_4 >= 0 AND SCENE_BRIGHT_4 <= 255),
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_groups_location ON GROUPS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_groups_dali ON GROUPS(DALI_NUM);
```

### 6. PRES_SENSORS

```sql
CREATE TABLE IF NOT EXISTS PRES_SENSORS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    ACTION_YES_ID INTEGER,
    ACTION_NO_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    DALI_INST INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    ACTION_YES_NUM INTEGER NOT NULL DEFAULT 0,
    ACTION_NO_NUM INTEGER NOT NULL DEFAULT 0,
    DELAY INTEGER NOT NULL DEFAULT 0 CHECK(DELAY >= 0 AND DELAY <= 255),
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE,
    FOREIGN KEY (ACTION_YES_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL,
    FOREIGN KEY (ACTION_NO_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_pres_sensors_location ON PRES_SENSORS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_dali ON PRES_SENSORS(DALI_ADDR, DALI_INST);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_action_yes ON PRES_SENSORS(ACTION_YES_ID);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_action_no ON PRES_SENSORS(ACTION_NO_ID);
```

### 7. BRIGHT_SENSORS

```sql
CREATE TABLE IF NOT EXISTS BRIGHT_SENSORS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    GROUP_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    DALI_INST INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    GROUP_NUM INTEGER NOT NULL DEFAULT 255,
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE,
    FOREIGN KEY (GROUP_ID) REFERENCES GROUPS(ID) ON DELETE SET NULL
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_bright_sensors_location ON BRIGHT_SENSORS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_bright_sensors_group ON BRIGHT_SENSORS(GROUP_ID);
CREATE INDEX IF NOT EXISTS idx_bright_sensors_dali ON BRIGHT_SENSORS(DALI_ADDR, DALI_INST);
```

### 8. BUTTON_PANELS

```sql
CREATE TABLE IF NOT EXISTS BUTTON_PANELS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    DALI_ADDR INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_button_panels_location ON BUTTON_PANELS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_button_panels_dali ON BUTTON_PANELS(DALI_ADDR);
```

### 9. BUTTONS

```sql
CREATE TABLE IF NOT EXISTS BUTTONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    BUTTON_PANEL_ID INTEGER NOT NULL,
    ACTION_SHORT_ID INTEGER,
    ACTION_LONG_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    DALI_INST INTEGER NOT NULL,
    ACTION_SHORT_NUM INTEGER NOT NULL DEFAULT 0,
    ACTION_LONG_NUM INTEGER NOT NULL DEFAULT 0,
    FOREIGN KEY (BUTTON_PANEL_ID) REFERENCES BUTTON_PANELS(ID) ON DELETE CASCADE,
    FOREIGN KEY (ACTION_SHORT_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL,
    FOREIGN KEY (ACTION_LONG_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_buttons_panel ON BUTTONS(BUTTON_PANEL_ID);
CREATE INDEX IF NOT EXISTS idx_buttons_dali ON BUTTONS(DALI_ADDR, DALI_INST);
CREATE INDEX IF NOT EXISTS idx_buttons_action_short ON BUTTONS(ACTION_SHORT_ID);
CREATE INDEX IF NOT EXISTS idx_buttons_action_long ON BUTTONS(ACTION_LONG_ID);
```

### 10. ACTIONS

```sql
CREATE TABLE IF NOT EXISTS ACTIONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NUM INTEGER NOT NULL UNIQUE
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_actions_num ON ACTIONS(NUM);
```

### 11. SUBACTIONS

```sql
CREATE TABLE IF NOT EXISTS SUBACTIONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    ACTION_ID INTEGER NOT NULL,
    ACTION_NUM INTEGER NOT NULL,
    OBJECT_NUM INTEGER NOT NULL CHECK(OBJECT_NUM >= 0 AND OBJECT_NUM <= 255),
    VALUE INTEGER NOT NULL CHECK(VALUE >= 0 AND VALUE <= 255),
    FOREIGN KEY (ACTION_ID) REFERENCES ACTIONS(ID) ON DELETE CASCADE
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_subactions_action ON SUBACTIONS(ACTION_ID);
CREATE INDEX IF NOT EXISTS idx_subactions_action_num ON SUBACTIONS(ACTION_NUM);
```

### 12. EVENTS

```sql
CREATE TABLE IF NOT EXISTS EVENTS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    ACTION_ID INTEGER NOT NULL,
    DAYS TEXT NOT NULL CHECK(length(DAYS) = 7),
    TIME TEXT NOT NULL CHECK(length(TIME) = 4),
    SMOOTH INTEGER NOT NULL DEFAULT 0 CHECK(SMOOTH IN (0, 1)),
    ACTION_NUM INTEGER NOT NULL,
    FOREIGN KEY (ACTION_ID) REFERENCES ACTIONS(ID) ON DELETE CASCADE
);

-- Индексы
CREATE INDEX IF NOT EXISTS idx_events_action ON EVENTS(ACTION_ID);
CREATE INDEX IF NOT EXISTS idx_events_time ON EVENTS(TIME);
CREATE INDEX IF NOT EXISTS idx_events_action_num ON EVENTS(ACTION_NUM);
```

## Представления (Views)

### Светильники с информацией о локации и группе

```sql
CREATE VIEW IF NOT EXISTS v_luminaires_full AS
SELECT 
    l.ID,
    l.NAME,
    l.ICO_NUM,
    l.POS_X,
    l.POS_Y,
    l.DALI_ADDR,
    l.VAL_BRIGHT,
    l.VAL_TW,
    l.VAL_R,
    l.VAL_G,
    l.VAL_B,
    l.VAL_W,
    loc.ID AS LOCATION_ID,
    loc.NAME AS LOCATION_NAME,
    loc.NUM AS LOCATION_NUM,
    g.ID AS GROUP_ID,
    g.NAME AS GROUP_NAME,
    g.DALI_NUM AS GROUP_DALI_NUM
FROM LUMINAIRES l
INNER JOIN LOCATIONS loc ON l.LOCATION_ID = loc.ID
LEFT JOIN GROUPS g ON l.GROUP_ID = g.ID;
```

### Датчики присутствия с действиями

```sql
CREATE VIEW IF NOT EXISTS v_pres_sensors_full AS
SELECT 
    ps.ID,
    ps.NAME,
    ps.DALI_ADDR,
    ps.DALI_INST,
    ps.DELAY,
    loc.ID AS LOCATION_ID,
    loc.NAME AS LOCATION_NAME,
    loc.NUM AS LOCATION_NUM,
    a_yes.ID AS ACTION_YES_ID,
    a_yes.NUM AS ACTION_YES_NUM,
    a_no.ID AS ACTION_NO_ID,
    a_no.NUM AS ACTION_NO_NUM
FROM PRES_SENSORS ps
INNER JOIN LOCATIONS loc ON ps.LOCATION_ID = loc.ID
LEFT JOIN ACTIONS a_yes ON ps.ACTION_YES_ID = a_yes.ID
LEFT JOIN ACTIONS a_no ON ps.ACTION_NO_ID = a_no.ID;
```

### Кнопки с действиями

```sql
CREATE VIEW IF NOT EXISTS v_buttons_full AS
SELECT 
    b.ID,
    b.NAME,
    b.DALI_ADDR,
    b.DALI_INST,
    bp.ID AS PANEL_ID,
    bp.NAME AS PANEL_NAME,
    loc.ID AS LOCATION_ID,
    loc.NAME AS LOCATION_NAME,
    a_short.ID AS ACTION_SHORT_ID,
    a_short.NUM AS ACTION_SHORT_NUM,
    a_long.ID AS ACTION_LONG_ID,
    a_long.NUM AS ACTION_LONG_NUM
FROM BUTTONS b
INNER JOIN BUTTON_PANELS bp ON b.BUTTON_PANEL_ID = bp.ID
INNER JOIN LOCATIONS loc ON bp.LOCATION_ID = loc.ID
LEFT JOIN ACTIONS a_short ON b.ACTION_SHORT_ID = a_short.ID
LEFT JOIN ACTIONS a_long ON b.ACTION_LONG_ID = a_long.ID;
```

### События расписания с действиями

```sql
CREATE VIEW IF NOT EXISTS v_events_full AS
SELECT 
    e.ID,
    e.DAYS,
    e.TIME,
    e.SMOOTH,
    a.ID AS ACTION_ID,
    a.NUM AS ACTION_NUM,
    GROUP_CONCAT(
        sa.OBJECT_NUM || ':' || sa.VALUE, 
        ','
    ) AS SUBACTIONS
FROM EVENTS e
INNER JOIN ACTIONS a ON e.ACTION_ID = a.ID
LEFT JOIN SUBACTIONS sa ON a.ID = sa.ACTION_ID
GROUP BY e.ID;
```

## Триггеры

### Автоматическое обновление NUM в ACTIONS

```sql
CREATE TRIGGER IF NOT EXISTS trg_actions_insert
AFTER INSERT ON ACTIONS
WHEN NEW.NUM IS NULL
BEGIN
    UPDATE ACTIONS 
    SET NUM = (SELECT COALESCE(MAX(NUM), 0) + 1 FROM ACTIONS WHERE ID != NEW.ID)
    WHERE ID = NEW.ID;
END;
```

### Проверка уникальности DALI адресов светильников

```sql
CREATE TRIGGER IF NOT EXISTS trg_luminaires_dali_unique
BEFORE INSERT ON LUMINAIRES
BEGIN
    SELECT RAISE(ABORT, 'DALI address already exists')
    WHERE EXISTS (
        SELECT 1 FROM LUMINAIRES 
        WHERE DALI_ADDR = NEW.DALI_ADDR 
        AND ID != NEW.ID
    );
END;
```

### Каскадное удаление поддействий при удалении действия

```sql
-- Уже реализовано через FOREIGN KEY ON DELETE CASCADE
```

## Начальные данные

### Контроллер по умолчанию

```sql
INSERT OR IGNORE INTO CONTROLLERS (ID, NAME, PASSWORD, IS_SCHEDULE, ICO_NUM, SCALE)
VALUES (1, 'Контроллер 1', '0000', 0, 0, 1);
```

## Версионирование базы данных

```sql
-- Таблица для хранения версии схемы БД
CREATE TABLE IF NOT EXISTS db_version (
    version INTEGER PRIMARY KEY,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Текущая версия
INSERT OR REPLACE INTO db_version (version) VALUES (1);
```

## Полный скрипт создания БД

```sql
-- Включаем поддержку внешних ключей
PRAGMA foreign_keys = ON;

-- Создание всех таблиц в правильном порядке
-- (сначала родительские, потом дочерние)

-- 1. CONTROLLERS
CREATE TABLE IF NOT EXISTS CONTROLLERS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    SCALE INTEGER DEFAULT 1,
    NAME TEXT NOT NULL,
    PASSWORD TEXT NOT NULL CHECK(length(PASSWORD) = 4),
    IS_SCHEDULE INTEGER NOT NULL DEFAULT 0 CHECK(IS_SCHEDULE IN (0, 1)),
    ICO_NUM INTEGER NOT NULL DEFAULT 0
);

-- 2. LOCATIONS
CREATE TABLE IF NOT EXISTS LOCATIONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    ICO_NUM INTEGER DEFAULT 0,
    SCALE INTEGER DEFAULT 1,
    POS_X INTEGER DEFAULT 0,
    POS_Y INTEGER DEFAULT 0,
    CONTROLLER_ID INTEGER NOT NULL,
    NUM INTEGER NOT NULL,
    IS_AUTO INTEGER NOT NULL DEFAULT 0 CHECK(IS_AUTO IN (0, 1)),
    FOREIGN KEY (CONTROLLER_ID) REFERENCES CONTROLLERS(ID) ON DELETE CASCADE
);

-- 3. GROUPS
CREATE TABLE IF NOT EXISTS GROUPS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    DALI_NUM INTEGER NOT NULL,
    SCENE_BRIGHT_0 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_0 >= 0 AND SCENE_BRIGHT_0 <= 255),
    SCENE_BRIGHT_1 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_1 >= 0 AND SCENE_BRIGHT_1 <= 255),
    SCENE_BRIGHT_2 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_2 >= 0 AND SCENE_BRIGHT_2 <= 255),
    SCENE_BRIGHT_3 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_3 >= 0 AND SCENE_BRIGHT_3 <= 255),
    SCENE_BRIGHT_4 INTEGER NOT NULL DEFAULT 0 CHECK(SCENE_BRIGHT_4 >= 0 AND SCENE_BRIGHT_4 <= 255),
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE
);

-- 4. LUMINAIRES
CREATE TABLE IF NOT EXISTS LUMINAIRES (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    ICO_NUM INTEGER DEFAULT 0,
    POS_X INTEGER DEFAULT 0,
    POS_Y INTEGER DEFAULT 0,
    LOCATION_ID INTEGER NOT NULL,
    GROUP_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    GROUP_NUM INTEGER NOT NULL DEFAULT 255,
    VAL_BRIGHT INTEGER NOT NULL DEFAULT 0 CHECK(VAL_BRIGHT >= 0 AND VAL_BRIGHT <= 255),
    VAL_TW INTEGER NOT NULL DEFAULT 0 CHECK(VAL_TW >= 0 AND VAL_TW <= 255),
    VAL_R INTEGER NOT NULL DEFAULT 0 CHECK(VAL_R >= 0 AND VAL_R <= 255),
    VAL_G INTEGER NOT NULL DEFAULT 0 CHECK(VAL_G >= 0 AND VAL_G <= 255),
    VAL_B INTEGER NOT NULL DEFAULT 0 CHECK(VAL_B >= 0 AND VAL_B <= 255),
    VAL_W INTEGER NOT NULL DEFAULT 0 CHECK(VAL_W >= 0 AND VAL_W <= 255),
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE,
    FOREIGN KEY (GROUP_ID) REFERENCES GROUPS(ID) ON DELETE SET NULL
);

-- 5. SCENE_LUMINAIRES
CREATE TABLE IF NOT EXISTS SCENE_LUMINAIRES (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    LUMINAIRE_ID INTEGER NOT NULL,
    DALI_ADDR INTEGER NOT NULL,
    SCENE_NUM INTEGER NOT NULL,
    VAL_BRIGHT INTEGER NOT NULL DEFAULT 0 CHECK(VAL_BRIGHT >= 0 AND VAL_BRIGHT <= 255),
    VAL_TW INTEGER NOT NULL DEFAULT 0 CHECK(VAL_TW >= 0 AND VAL_TW <= 255),
    VAL_R INTEGER NOT NULL DEFAULT 0 CHECK(VAL_R >= 0 AND VAL_R <= 255),
    VAL_G INTEGER NOT NULL DEFAULT 0 CHECK(VAL_G >= 0 AND VAL_G <= 255),
    VAL_B INTEGER NOT NULL DEFAULT 0 CHECK(VAL_B >= 0 AND VAL_B <= 255),
    VAL_W INTEGER NOT NULL DEFAULT 0 CHECK(VAL_W >= 0 AND VAL_W <= 255),
    FOREIGN KEY (LUMINAIRE_ID) REFERENCES LUMINAIRES(ID) ON DELETE CASCADE,
    UNIQUE(LUMINAIRE_ID, SCENE_NUM)
);

-- 6. ACTIONS
CREATE TABLE IF NOT EXISTS ACTIONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NUM INTEGER NOT NULL UNIQUE
);

-- 7. SUBACTIONS
CREATE TABLE IF NOT EXISTS SUBACTIONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    ACTION_ID INTEGER NOT NULL,
    ACTION_NUM INTEGER NOT NULL,
    OBJECT_NUM INTEGER NOT NULL CHECK(OBJECT_NUM >= 0 AND OBJECT_NUM <= 255),
    VALUE INTEGER NOT NULL CHECK(VALUE >= 0 AND VALUE <= 255),
    FOREIGN KEY (ACTION_ID) REFERENCES ACTIONS(ID) ON DELETE CASCADE
);

-- 8. PRES_SENSORS
CREATE TABLE IF NOT EXISTS PRES_SENSORS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    ACTION_YES_ID INTEGER,
    ACTION_NO_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    DALI_INST INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    ACTION_YES_NUM INTEGER NOT NULL DEFAULT 0,
    ACTION_NO_NUM INTEGER NOT NULL DEFAULT 0,
    DELAY INTEGER NOT NULL DEFAULT 0 CHECK(DELAY >= 0 AND DELAY <= 255),
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE,
    FOREIGN KEY (ACTION_YES_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL,
    FOREIGN KEY (ACTION_NO_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL
);

-- 9. BRIGHT_SENSORS
CREATE TABLE IF NOT EXISTS BRIGHT_SENSORS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    GROUP_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    DALI_INST INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    GROUP_NUM INTEGER NOT NULL DEFAULT 255,
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE,
    FOREIGN KEY (GROUP_ID) REFERENCES GROUPS(ID) ON DELETE SET NULL
);

-- 10. BUTTON_PANELS
CREATE TABLE IF NOT EXISTS BUTTON_PANELS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    LOCATION_ID INTEGER NOT NULL,
    DALI_ADDR INTEGER NOT NULL,
    LOCATION_NUM INTEGER NOT NULL,
    FOREIGN KEY (LOCATION_ID) REFERENCES LOCATIONS(ID) ON DELETE CASCADE
);

-- 11. BUTTONS
CREATE TABLE IF NOT EXISTS BUTTONS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    NAME TEXT NOT NULL,
    BUTTON_PANEL_ID INTEGER NOT NULL,
    ACTION_SHORT_ID INTEGER,
    ACTION_LONG_ID INTEGER,
    DALI_ADDR INTEGER NOT NULL,
    DALI_INST INTEGER NOT NULL,
    ACTION_SHORT_NUM INTEGER NOT NULL DEFAULT 0,
    ACTION_LONG_NUM INTEGER NOT NULL DEFAULT 0,
    FOREIGN KEY (BUTTON_PANEL_ID) REFERENCES BUTTON_PANELS(ID) ON DELETE CASCADE,
    FOREIGN KEY (ACTION_SHORT_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL,
    FOREIGN KEY (ACTION_LONG_ID) REFERENCES ACTIONS(ID) ON DELETE SET NULL
);

-- 12. EVENTS
CREATE TABLE IF NOT EXISTS EVENTS (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    ACTION_ID INTEGER NOT NULL,
    DAYS TEXT NOT NULL CHECK(length(DAYS) = 7),
    TIME TEXT NOT NULL CHECK(length(TIME) = 4),
    SMOOTH INTEGER NOT NULL DEFAULT 0 CHECK(SMOOTH IN (0, 1)),
    ACTION_NUM INTEGER NOT NULL,
    FOREIGN KEY (ACTION_ID) REFERENCES ACTIONS(ID) ON DELETE CASCADE
);

-- Создание всех индексов
CREATE INDEX IF NOT EXISTS idx_controllers_name ON CONTROLLERS(NAME);
CREATE INDEX IF NOT EXISTS idx_locations_controller ON LOCATIONS(CONTROLLER_ID);
CREATE INDEX IF NOT EXISTS idx_locations_num ON LOCATIONS(NUM);
CREATE INDEX IF NOT EXISTS idx_luminaires_location ON LUMINAIRES(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_luminaires_group ON LUMINAIRES(GROUP_ID);
CREATE INDEX IF NOT EXISTS idx_luminaires_dali ON LUMINAIRES(DALI_ADDR);
CREATE INDEX IF NOT EXISTS idx_scene_luminaires_luminaire ON SCENE_LUMINAIRES(LUMINAIRE_ID);
CREATE INDEX IF NOT EXISTS idx_scene_luminaires_scene ON SCENE_LUMINAIRES(SCENE_NUM);
CREATE INDEX IF NOT EXISTS idx_scene_luminaires_dali ON SCENE_LUMINAIRES(DALI_ADDR);
CREATE INDEX IF NOT EXISTS idx_groups_location ON GROUPS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_groups_dali ON GROUPS(DALI_NUM);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_location ON PRES_SENSORS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_dali ON PRES_SENSORS(DALI_ADDR, DALI_INST);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_action_yes ON PRES_SENSORS(ACTION_YES_ID);
CREATE INDEX IF NOT EXISTS idx_pres_sensors_action_no ON PRES_SENSORS(ACTION_NO_ID);
CREATE INDEX IF NOT EXISTS idx_bright_sensors_location ON BRIGHT_SENSORS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_bright_sensors_group ON BRIGHT_SENSORS(GROUP_ID);
CREATE INDEX IF NOT EXISTS idx_bright_sensors_dali ON BRIGHT_SENSORS(DALI_ADDR, DALI_INST);
CREATE INDEX IF NOT EXISTS idx_button_panels_location ON BUTTON_PANELS(LOCATION_ID);
CREATE INDEX IF NOT EXISTS idx_button_panels_dali ON BUTTON_PANELS(DALI_ADDR);
CREATE INDEX IF NOT EXISTS idx_buttons_panel ON BUTTONS(BUTTON_PANEL_ID);
CREATE INDEX IF NOT EXISTS idx_buttons_dali ON BUTTONS(DALI_ADDR, DALI_INST);
CREATE INDEX IF NOT EXISTS idx_buttons_action_short ON BUTTONS(ACTION_SHORT_ID);
CREATE INDEX IF NOT EXISTS idx_buttons_action_long ON BUTTONS(ACTION_LONG_ID);
CREATE INDEX IF NOT EXISTS idx_actions_num ON ACTIONS(NUM);
CREATE INDEX IF NOT EXISTS idx_subactions_action ON SUBACTIONS(ACTION_ID);
CREATE INDEX IF NOT EXISTS idx_subactions_action_num ON SUBACTIONS(ACTION_NUM);
CREATE INDEX IF NOT EXISTS idx_events_action ON EVENTS(ACTION_ID);
CREATE INDEX IF NOT EXISTS idx_events_time ON EVENTS(TIME);
CREATE INDEX IF NOT EXISTS idx_events_action_num ON EVENTS(ACTION_NUM);

-- Версионирование
CREATE TABLE IF NOT EXISTS db_version (
    version INTEGER PRIMARY KEY,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT OR REPLACE INTO db_version (version) VALUES (1);

-- Начальные данные
INSERT OR IGNORE INTO CONTROLLERS (ID, NAME, PASSWORD, IS_SCHEDULE, ICO_NUM, SCALE)
VALUES (1, 'Контроллер 1', '0000', 0, 0, 1);
```

## Примеры использования

### Добавление локации

```sql
INSERT INTO LOCATIONS (NAME, ICO_NUM, CONTROLLER_ID, NUM, IS_AUTO)
VALUES ('Гостиная', 1, 1, 1, 0);
```

### Добавление светильника

```sql
INSERT INTO LUMINAIRES (NAME, LOCATION_ID, DALI_ADDR, LOCATION_NUM, GROUP_NUM)
VALUES ('Люстра', 1, 10, 1, 255);
```

### Добавление действия с поддействиями

```sql
-- Создаём действие
INSERT INTO ACTIONS (NUM) VALUES (1);
SET @action_id = last_insert_rowid();

-- Добавляем поддействия
INSERT INTO SUBACTIONS (ACTION_ID, ACTION_NUM, OBJECT_NUM, VALUE)
VALUES 
    (@action_id, 1, 33, 50),  -- Светильник 33, яркость 50
    (@action_id, 1, 34, 75);  -- Светильник 34, яркость 75
```

### Добавление события расписания

```sql
INSERT INTO EVENTS (ACTION_ID, DAYS, TIME, SMOOTH, ACTION_NUM)
VALUES (1, 'TTTTTFF', '0800', 1, 1);
```

### Выборка всех светильников локации с группами

```sql
SELECT * FROM v_luminaires_full
WHERE LOCATION_ID = 1
ORDER BY POS_Y, POS_X;
```

## Примечания

1. **Внешние ключи**: Обязательно включайте `PRAGMA foreign_keys = ON;` при открытии соединения с БД.

2. **Транзакции**: Используйте транзакции для групповых операций:
   ```sql
   BEGIN TRANSACTION;
   -- ваши операции
   COMMIT;
   ```

3. **Производительность**: Индексы созданы для всех внешних ключей и часто используемых полей поиска.

4. **Ограничения**: CHECK constraints обеспечивают валидацию данных на уровне БД.

5. **Каскадное удаление**: При удалении родительской записи автоматически удаляются связанные дочерние записи.

