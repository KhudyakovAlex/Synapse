<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 11.12.2025, 19:50 МСК</p>
<h2 id="1-назначение-документа">1. Назначение документа</h2>
<p>Спецификация для разработчиков прошивки контроллера АПК Синапс. Документ описывает аппаратную часть, архитектуру системы, логику работы контроллера, структуры данных, взаимодействие с DALI-устройствами и мобильным приложением.</p>
<h2 id="2-термины-и-определения">2. Термины и определения</h2>
<p>2.1. <strong>АПК</strong> — аппаратно-программный комплекс.</p>
<p>2.2. <strong>Контроллер</strong> — устройство на базе микроконтроллера GD32F103RBT6, работающее с устройствами DALI.</p>
<p>2.3. <strong>Устройство</strong> — DALI-устройство в линии: светильник, датчик, кнопочная панель.</p>
<p>2.4. <strong>Прошивка</strong> — firmware в контроллере.</p>
<p>2.5. <strong>Телефон</strong> — мобильное устройство, обеспечивающее пользовательский интерфейс АПК.</p>
<p>2.6. <strong>Приложение</strong> — интерфейсное мобильное приложение в телефоне.</p>
<p>2.7. <strong>DALI</strong> (Digital Addressable Lighting Interface) — цифровой протокол управления освещением, который позволяет интегрировать осветительные устройства в единую систему.</p>
<p>2.8. <strong>Локация</strong> — помещение или часть помещения с отдельно от других частей объекта организованной работой освещения. В АПК все локации одного уровня. Иерархия локаций не предусмотрена.</p>
<p>2.9. <strong>Действие (ACTION)</strong> — изменение состояния системы освещения. Действие — произвольный набор из команд (SUBACTION):</p>
<ul>
  <li>включений сцен светильников, сцен групп, сцен локаций, сцен всего объекта;
  </li>
  <li>установка температуры TW у отдельного светильника, группы, локации или всего объекта;
  </li>
  <li>включений и выключений режима АВТО в локациях.
  </li>
</ul>
<p>Действия навешиваются на нажатия кнопок, сработки датчиков присутствия, события в расписании.</p>
<p>2.10. <strong>Режим АВТО</strong> — изменение освещения в локации на основе сигналов от датчиков. Включается/выключается тумблером на странице локации в приложении.</p>
<h2 id="3-аппаратная-часть">3. Аппаратная часть</h2>
<p>3.1. Микроконтроллер: <strong>GD32F103RBT6</strong>.</p>
<p>3.2. Интерфейсы:</p>
<ul>
  <li>1 линия DALI для управления устройствами;
  </li>
  <li>Bluetooth для связи с мобильными приложениями.
  </li>
</ul>
<p>3.3. Индикация: лесенка светодиодов + нижний светодиод.</p>
<p>3.4. Программная кнопка для сброса настроек.</p>
<h2 id="4-архитектура-системы">4. Архитектура системы</h2>
<div class="mermaid" data-diagram-url="SynapsePDS_FW_diagram_0.html">flowchart LR
    MOB1(Телефон 1)
    MOB2(Телефон 2)
    CON(Контроллер)
    DALI{{DALI-линия}}
    LUM((Светильник))
    SEN((Датчик))
    BUT((Кнопка))

    MOB1 <--Bluetooth--> CON
    MOB2 <--Bluetooth--> CON
    CON --- DALI
    DALI <---> LUM
    DALI <---> SEN
    DALI <---> BUT

    style MOB1 fill:#FA0,stroke:#A50
    style MOB2 fill:#FA0,stroke:#A50
    style CON fill:#FA0,stroke:#A50
</div>
<p>4.1. Телефоны подключаются к контроллеру по Bluetooth.</p>
<p>4.2. С контроллером одновременно могут работать (быть подключены) несколько телефонов - до 4 шт.</p>
<p>4.3. К контроллеру подключается 1 линия DALI, устройствами в которой управляет АПК.</p>
<h2 id="5-контроллер">5. Контроллер</h2>
<h3 id="51-константы-неизменяемые">5.1. Константы (неизменяемые)</h3>
<ul>
<li>Серийник: XXXXXXXX (8 цифр);</li>
<li>Название в Bluetooth: SYNAPSE XXXXXXXX.</li>
</ul>
<h3 id="52-переменные-меняются-через-приложение">5.2. Переменные (меняются через приложение)</h3>
<ul>
<li>Пароль: YYYY (4 цифры);</li>
<li>Название, под которым контроллер значится в приложении (по умолчанию SYNAPSE XXXXXXXX);</li>
<li>Номер иконки (по умолчанию дефолт — 0);</li>
<li>Флаг АВТО — главный выключатель автоматического режима (по умолчанию выкл);</li>
<li>Текущие дата и время для расписания (обновляются из приложения при каждом подключении телефона).</li>
</ul>
<h3 id="53-индикация-светодиодами">5.3. Индикация светодиодами</h3>
<ul>
<li><strong>Нижний светодиод</strong> мигает, если идет работа с линией DALI.</li>
<li><strong>Лесенка светодиодов</strong> загорается вся, если есть хотя бы одно Bluetooth-соединение с телефоном. Иначе вся лесенка не горит.</li>
</ul>
<h3 id="54-программная-кнопка">5.4. Программная кнопка</h3>
<ul>
<li><strong>Долгое нажатие</strong> — сброс настроек прошивки (не исполняемый код) в заводское состояние.</li>
<li><strong>Короткое нажатие</strong> — сброс только пароля в заводской.</li>
</ul>
<h2 id="6-структура-данных">6. Структура данных</h2>
<p>6.1. Данные в контроллере делятся на:</p>
<ul>
<li><strong>Рабочие</strong> — для работы с оборудованием DALI; хранятся в структурах языка С; передаются в командах между прошивкой и приложением.</li>
<li><strong>Интерфейсные</strong> — для формирования интерфейса приложения (названия, номера иконок, расположение иконок и т. п.); хранятся единым блоком; передаются бинарным блоком между прошивкой и приложением.</li>
</ul>
<h2 id="7-локации">7. Локации</h2>
<p>7.1. Устройства могут находиться в локациях или быть без локации (в корне контроллера).</p>
<p>7.2. При инициализации все найденные в линии DALI устройства помещаются в корень (без локации).</p>
<p>7.3. Создание локаций и распределение устройств по ним происходит по командам от приложения.</p>
<p>7.4. Количество локаций: до 16.</p>
<p>7.5. Все локации находятся на одном уровне, никакой многоуровневой иерархии не предусмотрено.</p>
<p>7.6. У контроллера есть общий флаг АВТО (главный выключатель автоматического режима). Если АВТО контроллера = выкл, сигналы от всех датчиков (присутствия и освещённости) игнорируются. Если АВТО контроллера = вкл, работают флаги АВТО отдельных локаций.</p>
<p>7.7. У каждой локации есть свой флаг АВТО. Если АВТО локации = выкл, сигналы от датчиков, действующие на устройства в данной локации, игнорируются (при условии, что АВТО контроллера = вкл).</p>
<p>7.8. Устройства без локации (в корне) работают в автоматическом режиме, если АВТО контроллера = вкл.</p>
<h2 id="8-светильники">8. Светильники</h2>
<p>8.1. Количество светильников ограничено емкостью линии DALI: 64 шт.</p>
<p>8.2. Поддерживаемые типы светильников:</p>
<ul>
  <li>Реле (тип 7);
  </li>
  <li>Диммируемые светодиодные (тип 6);
  </li>
  <li>RGB, RGBW, TW (все три последние - тип 8).
  </li>
</ul>
<p>8.3. Светильник может находиться в одной из локаций или быть без локации (в корне контроллера).</p>
<h2 id="9-световые-сцены">9. Световые сцены</h2>
<p>9.1. Световые (цветовые) сцены в АПК соответствуют DALI-сценам и используют DALI-механизм сцен.</p>
<p>9.2. 5 сквозных сцен (DALI-сцены 0–4) распространяются на все светильники.</p>
<p>9.3. По умолчанию в сценах 0–4 светильники имеют:</p>
<ul>
  <li>яркость: 0, 25, 50, 75, 100%;
  </li>
  <li>цвет: красный с максимальной насыщенностью.
  </li>
</ul>
<p>9.4. Состояние светильников в сцены может сохраняться:</p>
<ul>
  <li>отдельным светильником;
  </li>
  <li>группой светильников.
  </li>
</ul>
<p>9.5. Команда на включение сцены может быть отдана приложением:</p>
<ul>
  <li>отдельному светильнику;
  </li>
  <li>группе светильников;
  </li>
  <li>всем светильникам локации;
  </li>
  <li>всем светильникам контроллера.
  </li>
</ul>
<h2 id="10-группы-светильников">10. Группы светильников</h2>
<p>10.1. Группа может быть привязана к локации или быть без локации (в корне контроллера). Группа без локации может содержать только светильники без локации. Группа с локацией может содержать только светильники из этой же локации.</p>
<p>10.2. Группы в АПК соответствуют DALI-группам и используют DALI-механизм групп.</p>
<p>10.3. Общее максимальное количество групп (включая группы в корне и во всех локациях) — 16.</p>
<p>10.4. Светильник может входить только в одну группу или быть вне групп (чтобы отдельные светильники не занимали DALI-группы, которых на всех не хватит).</p>
<p>10.5. Светильники, объединённые в группу, получают возможность группового управления.</p>
<p>10.6. У светильников в группе остаётся возможность индивидуального управления и настройки.</p>
<h2 id="11-кнопочные-панели">11. Кнопочные панели</h2>
<p>11.1. Количество устройств управления ограничено емкостью линии DALI: 64 шт.</p>
<p>11.2. Кнопочные панели — основной инструмент пользователя для оперативного управления освещением.</p>
<p>11.3. На <strong>короткое нажатие</strong> кнопки может быть повешено одно или несколько действий (ACTIONS):</p>
<ul>
  <li>Если действие одно — при нажатии на кнопку оно и случается;
  </li>
  <li>Если действий несколько — они выполняются перебором.
  </li>
</ul>
<p>11.4. На <strong>долгое нажатие</strong> можно повесить только одно действие (ACTION). При нажатии и удержании вкл/выкл АВТО-режима производится сразу, яркость светильников плавно меняется в направлении целевой сцены.</p>
<p>11.5. Действия можно вешать и на короткое, и на длинное нажатия одновременно.</p>
<h2 id="12-датчики-присутствия">12. Датчики присутствия</h2>
<p>12.1. На датчик навешиваются два действия (ACTIONS): на присутствие / на отсутствие.</p>
<p>12.2. Действие на отсутствие срабатывает, когда датчик регистрирует отсутствие присутствия.</p>
<p>12.3. Если есть желание деактивировать конкретный датчик присутствия — убираем у него действия.</p>
<p>12.4. Действие всех датчиков на отдельно взятую локацию может быть активировано/деактивировано:</p>
<ul>
  <li>тумблером АВТО у этой локации в приложении;
  </li>
  <li>настенной кнопкой с соответствующим ACTION Локация.Авто = OFF;
  </li>
  <li>через расписание.
  </li>
</ul>
<p>12.5. Оперативное управление хотя бы одним светильником в локации временно переводит режим АВТО в этой локации в выключенное состояние. Возврат в режим Локация.Авто = ON: любой датчик присутствия данной локации регистрирует присутствие (и при этом сразу отрабатывает действие, повешенное на присутствие в этом датчике).</p>
<h2 id="13-датчики-освещенности">13. Датчики освещенности</h2>
<p>13.1. К датчику может быть привязана одна и только одна группа светильников. Датчик и группа должны находиться в одной локации, либо оба должны быть без локации (в корне).</p>
<p>13.2. Группа светильников может быть привязана только к одному датчику.</p>
<p>13.3. Если есть желание деактивировать конкретный датчик освещённости — убираем у него привязку к группе.</p>
<p>13.4. Действие датчиков активируется/деактивируется:</p>
<ul>
  <li>для датчиков в локации — тумблером АВТО локации (при условии АВТО контроллера = вкл);
  </li>
  <li>для датчиков в корне — тумблером АВТО контроллера;
  </li>
  <li>через настенную кнопку или расписание.
  </li>
</ul>
<p>13.5. Датчик по команде из приложения запоминает текущую освещённость как целевую для каждой из 5 сцен группы в момент сохранения каждой из сцен.</p>
<p>13.6. При привязке датчика освещенности к группе группа последовательно переводится в каждую из 5 сцен. В момент работы каждой сцены сохраняется её целевая освещённость (начальная установка).</p>
<p>13.7. Если при сохранении сцены (и, соответственно, задания целевой освещённости) светильник полностью выключен, он в подкрутке освещённости по датчику участвовать не будет.</p>
<p>13.8. Любое изменение яркости светильников в группе, отличное от включения одной из её 5 сцен, отключает подкрутку яркости в ней по датчику освещённости.</p>
<p>13.9. Включение у группы любым способом одной из её сцен переводит группу в режим поддержания целевой освещённости.</p>
<h2 id="14-действия-action">14. Действия (ACTION)</h2>
<p>14.1. Действие (ACTION) — набор из команд (SUBACTIONS):</p>
<ul>
  <li>включение сцены у отдельного светильника, группы, локации, корня или всего объекта;
  </li>
  <li>установка температуры TW у отдельного светильника, группы, локации, корня или всего объекта;
  </li>
  <li>включение/выключение режима АВТО у локации или контроллера.
  </li>
</ul>
<p>14.2. Навешиваются на нажатия кнопок, срабатывание датчиков присутствия, события расписания.</p>
<p>14.3. Действие может распространяться на любые локации и весь объект независимо от расположения инициирующего устройства.</p>
<h2 id="15-расписание">15. Расписание</h2>
<p>15.1. Расписание задается в виде набора событий (EVENTS), при возникновении каждого из которых выполняется действие (ACTION).</p>
<p>15.2. События могут быть ежедневными или назначаться на определённые дни недели.</p>
<p>15.3. Расписание одно для всего контроллера.</p>
<p>15.4. Расписание может быть активировано/деактивировано.</p>
<p>15.5. Необходимость действий (ACTIONS) по событиям расписания (EVENTS) проверяется контроллером раз в 1 минуту.</p>
<p>15.6. Если на одно время назначено и ежедневное событие и событие на день недели, сначала выполняется первое, затем второе.</p>
<p>15.7. На одно и то же время нельзя назначить два ежедневных событий и/или два события по дням недели.</p>
<p>15.8. Действие может производиться одномоментно (EVENTS.SMOOTH = F), когда параметры меняются шагово, и плавно (EVENTS.SMOOTH = T), когда параметры, меняемые у устройств, линейно изменяются от предыдущих значений к значениям, заданным в ACTIONS.</p>
<p>15.9. При плавном изменении параметров (SMOOTH = T) изменение производится раз в 1 минуту.</p>
<h2 id="16-автоматическая-работа">16. Автоматическая работа</h2>
<p>16.1. Автоматическая работа по датчикам и расписанию при соответствующих флагах, выставленных в локациях.</p>
<p>16.2. Опрос текущего состояния устройств в периоды затишья.</p>
<p>16.3. При отправке устройствам команд на изменение состояния последующий опрос того, подействовали ли эти команды, не предполагается. Выстрелили сообразно стандартам DALI и забыли. Сказали светильнику включиться на 33, считаем, что он включился на 33.</p>
<h2 id="17-bluetooth-взаимодействие-с-приложением">17. Bluetooth-взаимодействие с приложением</h2>
<p>17.1. С контроллером одновременно могут работать несколько телефонов.</p>
<p>17.2. Структура данных в контроллере синхронизируется с приложением через Bluetooth.</p>
<p>17.3. Рабочие данные передаются в командах между прошивкой и приложением.</p>
<p>17.4. Интерфейсные данные передаются бинарным блоком между прошивкой и приложением.</p>
<p>17.5. Протокол Bluetooth описан в отдельном документе: <strong><a href="../PDS/SynapsePDS_FW_Bluetooth.html">SynapsePDS_FW_Bluetooth</a>.md</strong>.</p>
<h2 id="18-пнр">18. ПНР</h2>
<h3 id="181-инициализация-линии-dali">18.1. Инициализация линии DALI</h3>
<p>18.1.1. Инициализация по команде от приложения линии DALI со сбросом настроек устройств к состоянию RESET.</p>
<p>18.1.2. При инициализации кроме DALI-настроек удаляются все локации (и создаётся одна, в которую все вновь найденные устройства складируются), устройства, группы, расписание.</p>
<p>18.1.3. Передача в приложение текущего статуса инициализации устройств для информирования пользователя о ходе процесса.</p>
<p>18.1.4. Перед инициализацией все светильники широковещательно выключаются (у кнопок выключаются светодиоды). После успешной выдачи устройству короткого адреса DALI: светильник включается (у кнопок включаются светодиоды).</p>
<h3 id="182-добавление-новых-устройств">18.2. Добавление новых устройств</h3>
<p>18.2.1. Добавление новых устройств в линию без пересбора линии.</p>
<h3 id="183-замена-устройств">18.3. Замена устройств</h3>
<p>18.3.1. Замена вышедших из строя устройств без пересбора линии:</p>
<ul>
  <li>подключение новых устройств к линии;
  </li>
  <li>поиск устройств;
  </li>
  <li>сопоставление их вышедшим из строя;
  </li>
  <li>перенос старых настроек в новые устройства (название, короткий адрес DALI, FADETIME и т. д.).
  </li>
</ul>
<h2 id="19-обновление-прошивки">19. Обновление прошивки</h2>
<p>19.1. Возможность обновления прошивки с помощью приложения через Bluetooth.</p>
<h2 id="20-вопросы">20. Вопросы</h2>
<p>20.1. Каким образом будет обновляться прошивка? (детали протокола обновления)</p>
<p>20.2. Должна ли температура света включаться в сцены (сейчас не включена)?</p>
<h2 id="21-идеи">21. <a href="../PRD/Идеи.html">Идеи</a></h2>
<p>22.1. Долгим нажатием на настенную кнопку сохранять сцену.</p>
<p>22.2. Должна ли прошивка работать с LLM?</p>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
