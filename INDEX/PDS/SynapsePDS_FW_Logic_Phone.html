<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка. Логика работы. Взаимодействие с телефоном - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW_Logic_Phone.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка. Логика работы. Взаимодействие с телефоном</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 12.12.2025, 11:43 МСК</p>
<h2 id="1-назначение-документа">1. Назначение документа</h2>
<p>Описать логику взаимодействия прошивки контроллера с мобильными приложениями через Bluetooth.</p>
<h2 id="2-базовые-документы">2. Базовые документы</h2>
<ul>
<li><strong><a href="../PDS/SynapsePDS_FW_Logic.html">SynapsePDS_FW_Logic</a></strong> — базовые принципы логики работы прошивки</li>
<li><strong><a href="../PDS/SynapsePDS_FW_DB.html">SynapsePDS_FW_DB</a></strong> — структура базы данных прошивки</li>
<li><strong><a href="../PDS/SynapsePDS_USML.html">SynapsePDS_USML</a></strong> — протокол обмена данными</li>
<li><strong><a href="../PDS/SynapsePDS_FW_Bluetooth.html">SynapsePDS_FW_Bluetooth</a></strong> — Bluetooth-соединение</li>
</ul>
<h2 id="3-взаимодействие-с-телефоном">3. Взаимодействие с телефоном</h2>
<h3 id="31-bluetooth-подключение">3.1. Bluetooth-подключение</h3>
<p>3.1.1. Контроллер работает как периферийное устройство (Peripheral).</p>
<p>3.1.2. Телефоны работают как центральные устройства (Central).</p>
<p>3.1.3. К контроллеру могут одновременно подключиться до 4 телефонов.</p>
<p>3.1.4. Если подключено 4 телефона, контроллер не выдаёт в эфир адвертайзных сигналов.</p>
<p>3.1.5. Имя Bluetooth-устройства:</p>
<ul>
  <li>По умолчанию: <code>SYNAPSE XXXXXXXX</code> (XXXXXXXX — серийный номер);
  </li>
  <li>После изменения имени/иконки: <code>[ICO]Name</code> (ICO — номер иконки в квадратных скобках; строка парсится в приложении и пользователю показывается иконка и имя без <code>[ICO]</code>).
  </li>
</ul>
<h3 id="32-протокол-обмена-телеграммами">3.2. Протокол обмена телеграммами</h3>
<p>3.2.1. Телеграммы передаются в бинарном формате USML.</p>
<p>3.2.2. Структура USML-телеграммы:</p>
<ul>
  <li><strong>Реестр</strong> — битовая маска, определяющая, какие таблицы/записи/поля содержатся в телеграмме;
  </li>
  <li><strong>Данные</strong> — последовательность байтов значений полей в порядке, определённом реестром.
  </li>
</ul>
<p>3.2.3. При получении телеги от телефона прошивка должна отправить подтверждение успешного получения.</p>
<p>3.2.4. При отправке телеги телефону прошивка должна получить подтверждение. При отсутствии подтверждения — повторная отправка 2 дополнительных раза с интервалом 1 сек. Если ответа нет, считаем связь потеранной и отключаем телефон.</p>
<p>3.2.5. Телеги от прошивки отправляются широковещательно ВСЕМ подключённым телефонам.</p>
<h3 id="33-обновление-даты-и-времени">3.3. Обновление даты и времени</h3>
<p>3.3.1. При каждом подключении телефона к контроллеру приложение отправляет телеграмму с изменением <strong>CONTROLLERS.TIMESTAMP</strong>.</p>
<p>3.3.2. Значение передаётся в формате Unix timestamp (uint32_t) — количество секунд с 01.01.1970 00:00:00 UTC.</p>
<p>3.3.3. Прошивка обновляет свои внутренние часы для работы расписания.</p>
<h2 id="4-загрузка-usm-контроллера-в-телефон">4. Загрузка USM контроллера в телефон</h2>
<h3 id="41-первое-подключение-к-контроллеру">4.1. Первое подключение к контроллеру</h3>
<p>4.1.1. При первом подключении телефона к контроллеру прошивка сразу отправляет полный дамп FW-USM.</p>
<p>4.1.2. Дамп включает:</p>
<ul>
  <li>Рабочие данные (все таблицы FW-USM);
  </li>
  <li>Интерфейсные данные (блок IDATA).
  </li>
</ul>
<p>4.1.3. Приложение создаёт запись в таблице <strong>CONTROLLERS</strong> своей APP-USM и распаковывает полученные данные.</p>
<p>4.1.4. Приложение проверяет пароль и при неверном пароле блокирует работу с контроллером.</p>
<h3 id="42-повторное-подключение">4.2. Повторное подключение</h3>
<p>4.2.1. Прошивка отправляет полный дамп FW-USM для синхронизации с APP-USM телефона.</p>
<p>4.2.2. Приложение обновляет свою APP-USM данными из FW-USM.</p>
<h3 id="43-восстановление-связи-после-разрыва">4.3. Восстановление связи после разрыва</h3>
<p>4.3.1. При кратковременном разрыве связи приложение пытается восстановить соединение.</p>
<p>4.3.2. Приложение делает 3 попытки восстановления связи с интервалом 1 секунда между попытками.</p>
<p>4.3.3. После неудачных попыток приложение выкидывает пользователя в список контроллеров.</p>
<p>4.3.4. Прошивка отправляет актуальное состояние FW-USM для синхронизации.</p>
<h3 id="44-одновременная-работа-нескольких-телефонов">4.4. Одновременная работа нескольких телефонов</h3>
<p>4.4.1. Все телеграммы от контроллера отправляются одновременно всем подключённым телефонам.</p>
<p>4.4.2. При подключении второго/третьего/четвёртого телефона прошивка отправляет им текущий полный дамп FW-USM.</p>
<p>4.4.3. Все изменения FW-USM, вызванные действиями любого из телефонов, рассылаются всем подключённым телефонам.</p>
<p>4.4.4. Каждое приложение обновляет свой APP-USM при получении телеграмм от прошивки.</p>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
