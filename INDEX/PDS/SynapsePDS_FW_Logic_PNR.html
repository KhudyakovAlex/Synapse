<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка. Логика работы. ПНР - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW_Logic_PNR.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка. Логика работы. ПНР</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 12.12.2025, 12:26 МСК</p>
<h2 id="1-назначение-документа">1. Назначение документа</h2>
<p>Описать логику выполнения пуско-наладочных работ прошивкой контроллера.</p>
<h2 id="2-базовые-документы">2. Базовые документы</h2>
<ul>
<li><strong><a href="../PDS/SynapsePDS_FW_Logic.html">SynapsePDS_FW_Logic</a></strong> — базовые принципы логики работы прошивки</li>
<li><strong><a href="../PDS/SynapsePDS_FW_DB.html">SynapsePDS_FW_DB</a></strong> — структура базы данных прошивки</li>
<li><strong><a href="../PDS/SynapsePDS_USML.html">SynapsePDS_USML</a></strong> — протокол обмена данными</li>
</ul>
<h2 id="3-пуско-наладочные-работы">3. Пуско-наладочные работы</h2>
<h3 id="31-сохранение-idata">3.1. Сохранение IDATA</h3>
<p>3.1.1. Блок интерфейсных данных IDATA хранится в энергонезависимой памяти контроллера. Он хранит все редко изменяемые ПНР-данные кроме ПНР-данных в таблице CONTROLLERS.</p>
<p>3.1.2. При любом изменении интерфейсных данных через приложение прошивка:</p>
<ul>
  <li>Получает телеграмму с новым блоком IDATA;
  </li>
  <li>Записывает его в энергонезависимую память.
  </li>
</ul>
<p>3.1.3. При инициализации линии DALI блок IDATA сбрасывается.</p>
<h3 id="32-инициализация-линии-dali">3.2. Инициализация линии DALI</h3>
<p>3.2.1. Инициализация стартуется телеграммой с изменением <strong>CONTROLLERS.STATUS</strong> = <code>I</code>.</p>
<p>3.2.2. При получении этой телеграммы прошивка:</p>
<ul>
  <li>Сбрасывает все данные FW-USM (кроме NAME, PASSWORD, ICO_NUM контроллера);
  </li>
  <li>Сбрасывает состояние всех устройств в линии DALI к состоянию RESET (DALI-команда);
  </li>
  <li>Ставит в своей USM <strong>CONTROLLERS.STATUS</strong> = <code>I</code>.
  </li>
</ul>
<p>3.2.3. Прошивка производит инициализацию светильников:</p>
<ul>
  <li>Широковещательно выключает все светильники (DALI-команда);
  </li>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Присваивает каждому найденному светильнику короткий адрес;
  </li>
  <li>Добавляет светильники в FW-USM с:
<ul>
  <li><code>EXIST = T</code>;
  </li>
  <li><code>LOCATION_ID = -1</code> (без локации);
  </li>
  <li><code>GROUP_ID = -1</code> (без группы);
  </li>
  <li><code>DALI_ADDR</code> — присвоенный короткий адрес;
  </li>
  <li>Начальными значениями VAL_BRIGHT, VAL_TW и т.д. из устройства-свтильника DALI;
  </li>
  <li><code>STATUS = A</code>.
  </li>
</ul>
  </li>
  <li>Включает светильник (DALI-команда) после присвоения адреса.
  </li>
</ul>
<p>3.2.4. Прошивка инициализирует сцены 0-4 во всех DALI-светильниках и своей USM:</p>
<ul>
  <li>Сцена 0: яркость 0% (выключено);
  </li>
  <li>Сцена 1: яркость 25%;
  </li>
  <li>Сцена 2: яркость 50%;
  </li>
  <li>Сцена 3: яркость 75%;
  </li>
  <li>Сцена 4: яркость 100%;
  </li>
  <li>Для RGB-светильников: красный цвет с максимальной насыщенностью.
  </li>
</ul>
<p>3.2.5. Прошивка производит инициализацию устройств управления (датчики, кнопочные панели):</p>
<ul>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Присваивает короткие адреса;
  </li>
  <li>Добавляет в FW-USM с:
<ul>
  <li><code>EXIST = T</code>;
  </li>
  <li><code>LOCATION_ID = -1</code> (без локации);
  </li>
  <li><code>STATUS = A</code>;
  </li>
  <li>Остальные поля — по умолчанию (для датчиков присутствия ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1, для кнопок ACTION_SET_SHORT_NUM = -1, ACTION_LONG_ID = -1).
  </li>
</ul>
  </li>
  <li>Включает светодиоды на кнопочных панелях (DALI-команда).
  </li>
</ul>
<p>3.2.7. После завершения инициализации прошивка:</p>
<ul>
  <li>Ставит в своей USM <strong>CONTROLLERS.STATUS</strong> = <code>A</code>;
  </li>
  <li>Рассылает финальное состояние FW-USM всем телефонам.
  </li>
</ul>
<h3 id="33-расширение-линии-dali">3.3. Расширение линии DALI</h3>
<p>3.3.1. Расширение стартуется телеграммой с изменением <strong>CONTROLLERS.STATUS</strong> = <code>E</code> (расширение).</p>
<p>3.3.2. Расширение производится аналогично инициализации, но <strong>без сброса FW-USM</strong>.</p>
<p>3.3.3. Прошивка:</p>
<ul>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Находит устройства без короткого адреса (новые);
  </li>
  <li>Присваивает им адреса;
  </li>
  <li>Добавляет в свободные слоты FW-USM (где <code>EXIST = F</code>).
  </li>
</ul>
<p>3.3.4. Новые устройства добавляются с дефолтными параметрами без локации и группы.</p>
<h3 id="34-замена-устройства-в-линии-dali">3.4. Замена устройства в линии DALI</h3>
<p>3.4.1. Замена стартуется телеграммой с изменением <strong>LUMINAIRES[i].STATUS</strong> = <code>C</code> (или <strong>PRES_SENSORS[i].STATUS</strong> = <code>C</code> и т.д.).</p>
<p>3.4.2. Прошивка выполняет расширение линии (как в п. 3.3).</p>
<p>3.4.3. Прошивка находит устройства того же типа без привязки (новые).</p>
<p>3.4.4. Если найдено одно новое устройство нужного типа:</p>
<ul>
  <li>Прошивка копирует все настройки из записи заменяемого устройства в запись нового;
  </li>
  <li>Присваивает новому устройству короткий адрес старого (DALI-команда);
  </li>
  <li>Отправляет необходимые DALI-команды для установки параметров (MIN_LEVEL, MAX_LEVEL, FADE_TIME и т.д.);
  </li>
  <li>Ставит <strong>STATUS</strong> = <code>A</code>.
  </li>
</ul>
<p>3.4.6. Прошивка рассылает изменения всем телефонам.</p>
<h3 id="35-локации-и-распределение-по-ним-устройств">3.5. Локации и распределение по ним устройств</h3>
<p>3.5.1. <strong>Создание локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].EXIST</strong> = <code>T</code> для свободного слота. при этом в телеге возможны и другие изменения в том числе в idata  где хранится имя локации</p>
<p>3.5.3. <strong>Перемещение устройства в локацию</strong>: приложение отправляет телеграмму с изменением <strong>LUMINAIRES[j].LOCATION_ID</strong> = <code>i</code>.
аналогично для кнопок и датчиков</p>
<p>3.5.5. <strong>Удаление локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].EXIST</strong> = <code>F</code>.</p>
<ul>
  <li>Если в локации есть устройства, всем им назначается <strong>LOCATIONS_ID = -1</strong>;
  </li>
</ul>
<h3 id="36-группы-и-распределение-по-ним-устройств">3.6. Группы и распределение по ним устройств</h3>
<p>3.6.1. <strong>Создание группы</strong>: приложение отправляет телеграмму с изменением <strong>GROUPS[i].EXIST</strong> = <code>T</code> и <strong>GROUPS[i].LOCATION_ID</strong> = <code>loc</code> (или -1 для корня). при этом в телеге возможны и другие изменения в том числе в idata  где хранится имя группы</p>
<p>3.6.3. <strong>Добавление светильника в группу</strong>: приложение отправляет телеграмму с изменением <strong>LUMINAIRES[j].GROUP_ID</strong> = <code>i</code>.</p>
<ul>
  <li>Прошивка отправляет DALI-команду присвоения светильника группе i;
  </li>
</ul>
<p>3.6.5. <strong>Удаление группы</strong>: приложение отправляет телеграмму с изменением <strong>GROUPS[i].EXIST</strong> = <code>F</code>.</p>
<ul>
  <li>Прошивка убирает у всех светильников с <strong>GROUP_ID</strong> = <code>i</code> привязку к группе (GROUP_ID = -1);
  </li>
  <li>Отправляет соответствующие DALI-команды;
  </li>
</ul>
<h3 id="37-именование-и-назначение-пиктограмм-контроллеру-локациям-устройствам">3.7. Именование и назначение пиктограмм контроллеру, локациям, устройствам</h3>
<h4>3.7.1. Изменение имени и иконки локаций и устройств</h4>
<p>3.7.1.1. Изменение имени/иконки локациям и устройствам — это изменение интерфейсных данных в блоке IDATA.</p>
<p>3.7.1.2. Приложение отправляет телеграмму с новым блоком IDATA.</p>
<h4>3.7.2. Изменение имени, иконки и пароля контроллера</h4>
<p>3.7.2.1. Изменение имени, иконки и пароля контроллера — это изменение полей <strong>CONTROLLERS.NAME</strong>, <strong>CONTROLLERS.ICO_NUM</strong>, <strong>CONTROLLERS.PASSWORD</strong> (отдельные поля, не в IDATA).</p>
<p>3.7.2.2. Приложение отправляет телеграмму с изменёнными полями контроллера.</p>
<p>3.7.2.4. Если изменилось имя или иконка контроллера:</p>
<ul>
  <li>Прошивка обновляет имя Bluetooth-устройства;
  </li>
  <li>Новое имя формата: <code>[ICO]Name</code>.
  </li>
</ul>
<h3 id="38-действия-поддействия-и-наборы-действий">3.8. Действия, поддействия и наборы действий</h3>
<p>Немного теории.</p>
<p>3.8.1. <strong>Поддействие (таблица SUBACTIONS)</strong> — элементарное изменение системы освещения:</p>
<ul>
  <li>Включение сцены у светильника/группы/локации/контроллера;
  </li>
  <li>Установка температуры белого света (TW);
  </li>
  <li>Переключение режима АВТО.
  </li>
</ul>
<p>и т.п. Со стороны пользователя поддействаия создаются внутри действий и при удалении последних вместе с ними же и удаляются.</p>
<p>3.8.2. <strong>Действие (таблица ACTIONS)</strong> — состоит из одного или нескольких поддействий, выполняемых одним пакетом. Например, действие "Вечерний свет" может включать:</p>
<ul>
  <li>Включение сцены 2 в гостиной;
  </li>
  <li>Включение сцены 1 в коридоре;
  </li>
  <li>Установка температуры 2700K во всех светильниках.
  </li>
</ul>
<p>Навешиваются на кнопки, датчики, события расписания. Не существует какого-то спрвочника действий: со сороны пользователя действия создаются каждый раз как обработчики нажатий кнопок, сигналов датчиков, события в расписании.</p>
<p>3.8.3. <strong>Набор действий (отдельной таблицы нет)</strong> — группа действий, объединённых для перебора. Используется для привязки к кнопке нескольких действий, которые переключаются последовательно при каждом КОРОТКОМ нажатии на кнопку. Например:</p>
<ul>
  <li>Действие 1: "Яркий свет" (позиция 1);
  </li>
  <li>Действие 2: "Средний свет" (позиция 2);
  </li>
  <li>Действие 3: "Тусклый свет" (позиция 3).
  </li>
</ul>
<p>Навешиваются ТОЛЬКО на короткие нажатия кнопок. Специальной таблицы в БД с наборами нет. В поле <strong>BUTTONS.ACTION_SET_SHORT_NUM</strong>кнопки устанвливается число, аналогичное число записываем в поля <strong>ACTIONS.ACTION_SET_NUM</strong> одного или нескольких действий. Вот и вся связь.</p>
<h3 id="39-добавлениеудвление-поддействия-виз-действие">3.9. Добавление/удвление поддействия в/из действие</h3>
<p>3.9.1. опишем процесс добавления поддействия в действие здесь и сразу т.к. он позже будет встечаться несколько раз</p>
<p>3.9.2. Добавление поддействия</p>
<ul>
  <li>Телега с записью <strong>SUBACTIONS[j]</strong>:
<ul>
  <li><strong>ACTION_ID</strong> = <code>i</code>;
  </li>
  <li><strong>OBJECT_TYPE</strong> = тип объекта (1-контроллер, 2-локация, 3-группа, 4-светильник);
  </li>
  <li><strong>OBJECT_NUM</strong> = номер объекта;
  </li>
  <li><strong>VALUE</strong> = значение (номер сцены, температура TW, флаг АВТО).
  </li>
</ul>
  </li>
</ul>
<p>3.9.3. Удаление поддействия</p>
<ul>
  <li><strong>SUBACTIONS[j].ACTION_ID</strong> = -1
  </li>
</ul>
<h3 id="310-назначение-действий-на-датчики-присутствия">3.10. Назначение действий на датчики присутствия</h3>
<p>3.10.1. Назначение на присутствие</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_OCCUPANCY_ID</strong> = <code>j</code> (j - ID действия из числа свободных);
  </li>
</ul>
<p>3.10.1. Снятие назначения на присутствие</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_OCCUPANCY_ID</strong> = -1
  </li>
  <li>Прошивка всем поддействиям с ACTION_ID = очищаемому ACTION_OCCUPANCY_ID ставит ACTION_ID = -1
  </li>
</ul>
<p>3.10.2. Назначение на отсутствие</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_VACANCY_ID</strong> = <code>j</code> (j - ID действия из числа свободных).
  </li>
</ul>
<p>3.10.1. Снятие назначения на отсутствие</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_VACANCY_ID</strong> = -1
  </li>
  <li>Прошивка всем поддействиям с ACTION_ID = очищаемому ACTION_OCCUPANCY_ID ставит ACTION_ID = -1
  </li>
</ul>
<p>3.10.3. После этого пользователь добавляет в действие поддействия (см. 3.9. Добавление поддействий в действия), но это уже отдельные телеги.</p>
<h3 id="311-привязка-датчиков-освещённости-к-группам-светильников">3.11. Привязка датчиков освещённости к группам светильников</h3>
<p>3.11.1. Приложение отправляет телеграмму с изменением <strong>BRIGHT_SENSORS[i].GROUP_ID</strong> = <code>j</code>.</p>
<p>3.11.2. Прошивка последовательно переводит светильники группы в сцены 0-4 (DALI-команды).</p>
<p>3.11.3. Для каждой сцены N (0-4) прошивка:</p>
<ul>
  <li>Считывает текущую освещённость с датчика (DALI-команда);
  </li>
  <li>Сохраняет значение в соответствующее поле <strong>BRIGHT_SENSORS[i].SCENE_BRIGHTNESS_N</strong>;
  </li>
  <li>Например, для сцены 0 → <strong>SCENE_BRIGHTNESS_0</strong>, для сцены 1 → <strong>SCENE_BRIGHTNESS_1</strong> и т.д.
  </li>
</ul>
<h3 id="312-назначение-действий-на-настенные-кнопки">3.12. Назначение действий на настенные кнопки</h3>
<p>3.12.1. Приложение отправляет телеграмму с изменением:</p>
<ul>
  <li><strong>BUTTONS[i].ACTION_SET_SHORT_NUM</strong> = <code>set</code> (набор действий на короткое нажатие);
  </li>
  <li><strong>BUTTONS[i].ACTION_LONG_ID</strong> = <code>j</code> (действие на долгое нажатие).
  </li>
</ul>
<p>3.12.2. Кнопка начинает отрабатывать действия при нажатиях.</p>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
