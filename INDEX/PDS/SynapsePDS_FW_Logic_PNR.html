<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка. Логика работы. ПНР - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW_Logic_PNR.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка. Логика работы. ПНР</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 13.12.2025, 11:30 МСК</p>
<p>В данном документе речь идёт только об изменениях данных USM, относящихся к ПНР. Остальные данные рассматриваются в других документах:</p>
<ul>
  <li><strong>CONTROLLERS.NAME</strong> - тут
  </li>
  <li><strong>CONTROLLERS.TIMESTAMP</strong> - в Взаимодействие с телефоном
  </li>
  <li><strong>CONTROLLERS.IS_AUTO</strong> - в Оперативное управление
  </li>
</ul>
<h2 id="1-изменение-пнр-параметров-контроллера">1. Изменение ПНР-параметров контроллера</h2>
<p>1.1. Изменение имени, иконки и пароля контроллера — это изменение полей <strong>CONTROLLERS.NAME</strong>, <strong>CONTROLLERS.ICO_NUM</strong>, <strong>CONTROLLERS.PASSWORD</strong> (отдельные поля, не в IDATA).</p>
<p>1.2. Приложение отправляет телеграмму с изменёнными полями контроллера.</p>
<p>1.3. Если изменилось имя или иконка контроллера:</p>
<ul>
  <li>Прошивка обновляет имя Bluetooth-устройства;
  </li>
  <li>Новое имя формата: <code>[ICO]Name</code>.
  </li>
</ul>
<p>1.4. Про изменение других полей <strong>CONTROLLERS</strong> — в других разделах описания логики.</p>
<h2 id="2-инициализация-линии-dali">2. Инициализация линии DALI</h2>
<p>2.1. Инициализация стартуется телеграммой с изменением <strong>CONTROLLERS.STATUS</strong> = <code>I</code>.</p>
<p>2.2. При получении этой телеграммы прошивка:</p>
<ul>
  <li>Сбрасывает все данные FW-USM в начальные значения (кроме NAME, PASSWORD, ICO_NUM контроллера); IDATA сбрасывает в 0;
  </li>
  <li>Сбрасывает состояние всех устройств в линии DALI к состоянию RESET;
  </li>
  <li>Ставит в своей USM <strong>CONTROLLERS.STATUS</strong> = <code>I</code> (и отправляет об этом телегу телефону).
  </li>
</ul>
<p>2.3. Прошивка производит инициализацию светильников:</p>
<ul>
  <li>Широковещательно выключает все светильники (DALI-команда);
  </li>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Присваивает каждому найденному светильнику короткий адрес;
  </li>
  <li>Добавляет светильники в FW-USM с:
<ul>
  <li><code>EXIST = T</code>;
  </li>
  <li><code>LOCATION_ID = -1</code> (без локации);
  </li>
  <li><code>GROUP_ID = -1</code> (без группы);
  </li>
  <li><code>DALI_ADDR</code> — присвоенный короткий адрес;
  </li>
  <li>Начальными значениями VAL_BRIGHT, VAL_TW и т.д. из устройства-светильника DALI;
  </li>
  <li><code>STATUS = A</code>.
  </li>
</ul>
  </li>
  <li>Включает светильник (DALI-команда) после присвоения адреса.
  </li>
</ul>
<p>2.4. Прошивка инициализирует сцены 0-4 во всех DALI-светильниках и своей USM:</p>
<ul>
  <li>Сцена 0: яркость 0% (выключено);
  </li>
  <li>Сцена 1: яркость 25%;
  </li>
  <li>Сцена 2: яркость 50%;
  </li>
  <li>Сцена 3: яркость 75%;
  </li>
  <li>Сцена 4: яркость 100%;
  </li>
  <li>Для RGB-светильников: красный цвет с максимальной насыщенностью.
  </li>
</ul>
<p>2.5. Прошивка производит инициализацию устройств управления (датчики, кнопочные панели):</p>
<ul>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Присваивает короткие адреса;
  </li>
  <li>Добавляет в FW-USM с:
<ul>
  <li><code>EXIST = T</code>;
  </li>
  <li><code>LOCATION_ID = -1</code> (без локации);
  </li>
  <li><code>STATUS = A</code>;
  </li>
  <li>Остальные поля — по умолчанию (для датчиков присутствия ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1, для кнопок ACTION_SET_SHORT_NUM = -1, ACTION_LONG_ID = -1).
  </li>
</ul>
  </li>
  <li>Включает светодиоды на кнопочных панелях (DALI-команда).
  </li>
</ul>
<p>2.6. После завершения инициализации прошивка:</p>
<ul>
  <li>Ставит в своей USM <strong>CONTROLLERS.STATUS</strong> = <code>A</code>;
  </li>
  <li>Рассылает финальное состояние FW-USM всем телефонам.
  </li>
</ul>
<h2 id="3-расширение-линии-dali">3. Расширение линии DALI</h2>
<p>3.1. Расширение стартуется телеграммой с изменением <strong>CONTROLLERS.STATUS</strong> = <code>E</code> (расширение).</p>
<p>3.2. Расширение производится аналогично инициализации, но <strong>без сброса FW-USM</strong>.</p>
<p>3.3. Прошивка:</p>
<ul>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Находит устройства без короткого адреса (новые);
  </li>
  <li>Присваивает им адреса;
  </li>
  <li>Добавляет в свободные слоты FW-USM (где <code>EXIST = F</code>).
  </li>
</ul>
<p>3.4. Новые устройства добавляются с дефолтными параметрами без локации и группы.</p>
<h2 id="4-замена-устройства-в-линии-dali">4. Замена устройства в линии DALI</h2>
<p>4.1. Вышедшие из строя устройства заменяются поштучно:</p>
<ul>
  <li>Устройство физически заменяется на новое в линии DALI.
  </li>
  <li>Пользователь жмёт кнопку Заменить у устройства в приложении.
  </li>
</ul>
<p>4.2. Замена стартуется телеграммой с изменением <strong>LUMINAIRES[i].STATUS</strong> = <code>C</code> (или <strong>PRES_SENSORS[i].STATUS</strong> = <code>C</code> и т.д.).</p>
<p>4.3. Прошивка находит устройства того же типа без привязки (новые).</p>
<p>4.4. Если найдено одно новое устройство нужного типа:</p>
<ul>
  <li>Прошивка копирует все настройки из записи заменяемого устройства в запись нового;
  </li>
  <li>Присваивает новому устройству короткий адрес старого (DALI-команда);
  </li>
  <li>Отправляет необходимые DALI-команды для установки параметров (MIN_LEVEL, MAX_LEVEL, FADE_TIME и т.д.);
  </li>
  <li>Устройство проверяется на работоспособность:
<ul>
  <li>Если всё нормально, ставится <strong>STATUS</strong> = <code>A</code> у устройства.
  </li>
  <li>Иначе <strong>STATUS</strong> = <code>F</code>.
  </li>
</ul>
  </li>
</ul>
<p>4.5. Если устройство не найдено, у него ставится статус <code>F</code>.</p>
<p>4.6. Прошивка рассылает изменения всем телефонам.</p>
<h2 id="5-изменение-параметров-устройств">5. Изменение параметров устройств</h2>
<h3 id="51-светильники">5.1. Светильники</h3>
<p>5.1.1. Рабочие: MAX_LEVEL, MIN_LEVEL, FADE_TIME.</p>
<p>5.1.2. IDATA: имя, иконка, позиция.</p>
<h3 id="52-датчики-присутствия">5.2. Датчики присутствия</h3>
<p>5.2.1. Рабочие: HOLD_TIME.</p>
<p>5.2.2. IDATA: имя.</p>
<h3 id="53-датчики-освещённости">5.3. Датчики освещённости</h3>
<p>5.3.1. IDATA: имя.</p>
<h3 id="54-кнопочные-панели-и-кнопки">5.4. Кнопочные панели и кнопки</h3>
<p>5.4.1. IDATA: имя.</p>
<h2 id="6-локации-и-распределение-по-ним-устройств">6. Локации и распределение по ним устройств</h2>
<p>6.1. <strong>Создание локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].EXIST</strong> = <code>1</code> для свободного слота. При этом в телеге возможны и другие изменения, в том числе в IDATA, где хранится имя локации.
Значения у IS_AUTO и SCENE_NUM устанавливаются по умолчанию.</p>
<p>6.2. <strong>Помещение устройства в локацию</strong>: приложение отправляет телеграмму с изменением <strong>LUMINAIRES[j].LOCATION_ID</strong> = <code>i</code>. Аналогично для кнопок и датчиков.</p>
<p>6.3. <strong>Удаление локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].EXIST</strong> = <code>0</code>. Если в локации есть устройства, всем им назначается <strong>LOCATIONS_ID = -1</strong>.</p>
<h2 id="7-группы-и-распределение-по-ним-устройств">7. Группы и распределение по ним устройств</h2>
<p>7.1. <strong>Создание группы</strong>: приложение отправляет телеграмму с изменением <strong>GROUPS[i].EXIST</strong> = <code>1</code> и <strong>GROUPS[i].LOCATION_ID</strong> = <code>loc</code> (или -1 для корня). При этом в телеге возможны и другие изменения, в том числе в IDATA, где хранится имя группы.</p>
<p>7.2. <strong>Добавление светильника в группу</strong>: приложение отправляет телеграмму с изменением <strong>LUMINAIRES[j].GROUP_ID</strong> = <code>i</code>. Прошивка отправляет DALI-команду присвоения светильника группе i.</p>
<p>7.3. <strong>Удаление группы</strong>: приложение отправляет телеграмму с изменением <strong>GROUPS[i].EXIST</strong> = <code>0</code>. Прошивка убирает у всех светильников с <strong>GROUP_ID</strong> = <code>i</code> привязку к группе (GROUP_ID = -1) и отправляет соответствующие DALI-команды.</p>
<h2 id="8-добавлениеудаление-поддействия-виз-действия">8. Добавление/удаление поддействия в/из действия</h2>
<p>8.1. Опишем процесс добавления поддействия в действие здесь и сразу, т.к. он позже будет встречаться несколько раз.</p>
<p>8.2. Добавление поддействия — телега с записью <strong>SUBACTIONS[j]</strong>:</p>
<ul>
  <li><strong>ACTION_ID</strong> = <code>i</code>;
  </li>
  <li><strong>OBJECT_TYPE</strong> = тип объекта (1-контроллер, 2-локация, 3-группа, 4-светильник);
  </li>
  <li><strong>OBJECT_NUM</strong> = номер объекта;
  </li>
  <li><strong>VALUE</strong> = значение (номер сцены, температура TW, флаг АВТО).
  </li>
</ul>
<p>8.3. Удаление поддействия — <strong>SUBACTIONS[j].ACTION_ID</strong> = -1.</p>
<h2 id="9-назначение-действий-на-датчики-присутствия">9. Назначение действий на датчики присутствия</h2>
<p>9.1. Назначение на присутствие — <strong>PRES_SENSORS[i].ACTION_OCCUPANCY_ID</strong> = <code>j</code> (j — ID действия из числа свободных).</p>
<p>9.2. Снятие назначения на присутствие:</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_OCCUPANCY_ID</strong> = -1;
  </li>
  <li>Прошивка всем поддействиям с ACTION_ID = очищаемого ACTION_OCCUPANCY_ID ставит ACTION_ID = -1.
  </li>
</ul>
<p>9.3. Назначение на отсутствие — <strong>PRES_SENSORS[i].ACTION_VACANCY_ID</strong> = <code>j</code> (j — ID действия из числа свободных).</p>
<p>9.4. Снятие назначения на отсутствие:</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_VACANCY_ID</strong> = -1;
  </li>
  <li>Прошивка всем поддействиям с ACTION_ID = очищаемого ACTION_VACANCY_ID ставит ACTION_ID = -1.
  </li>
</ul>
<p>9.5. После этого пользователь добавляет в действие поддействия (см. раздел 8), но это уже отдельные телеги.</p>
<h2 id="10-привязка-датчиков-освещённости-к-группам-светильников">10. Привязка датчиков освещённости к группам светильников</h2>
<p>10.1. Приложение отправляет телеграмму с изменением <strong>BRIGHT_SENSORS[i].GROUP_ID</strong> = <code>j</code>.</p>
<p>10.2. Прошивка последовательно переводит светильники группы в сцены 0-4 (DALI-команды).</p>
<p>10.3. Для каждой сцены N (0-4) прошивка:</p>
<ul>
  <li>Считывает текущую освещённость с датчика (DALI-команда);
  </li>
  <li>Сохраняет значение в соответствующее поле <strong>BRIGHT_SENSORS[i].SCENE_BRIGHTNESS_N</strong>;
  </li>
  <li>Например, для сцены 0 → <strong>SCENE_BRIGHTNESS_0</strong>, для сцены 1 → <strong>SCENE_BRIGHTNESS_1</strong> и т.д.
  </li>
</ul>
<h2 id="11-назначение-действий-на-настенные-кнопки">11. Назначение действий на настенные кнопки</h2>
<h3 id="111-короткое-нажатие-набор-действий">11.1. Короткое нажатие (набор действий)</h3>
<p>11.1.1. Добавление действия в набор:</p>
<ul>
  <li><strong>ACTIONS[j].BUTTON_SHORT_ID</strong> = <code>i</code> (ссылка на кнопку);
  </li>
  <li><strong>ACTIONS[j].POS</strong> = <code>pos</code>.
  </li>
</ul>
<p>11.1.2. Пересортировка действий в наборе:</p>
<ul>
  <li>Приложение отправляет телеграмму с изменёнными <strong>ACTIONS[j].POS</strong>, <strong>ACTIONS[k].POS</strong> и т.д. для нескольких действий одновременно;
  </li>
  <li>Прошивка обновляет позиции действий в наборе.
  </li>
</ul>
<p>11.1.3. После добавления действия пользователь добавляет в действие поддействия (см. раздел 8), но это уже отдельные телеги.</p>
<p>11.1.4. Удаление действия из набора:</p>
<ul>
  <li><strong>ACTIONS[j].BUTTON_SHORT_ID</strong> = -1.
  </li>
</ul>
<h3 id="112-долгое-нажатие-одно-действие">11.2. Долгое нажатие (одно действие)</h3>
<p>11.2.1. Добавление действия на долгое нажатие:</p>
<ul>
  <li><strong>ACTIONS[j].BUTTON_LONG_ID</strong> = <code>i</code>.
  </li>
</ul>
<p>11.2.2. После добавления действия пользователь добавляет в действие поддействия (см. раздел 8), но это уже отдельные телеги.</p>
<p>11.2.3. Удаление действия:</p>
<ul>
  <li><strong>ACTIONS[j].BUTTON_LONG_ID</strong> = -1.
  </li>
</ul>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
