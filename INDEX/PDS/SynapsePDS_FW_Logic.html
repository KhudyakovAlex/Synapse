<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка. Логика работы - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW_Logic.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка. Логика работы</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 11.12.2025, 19:20 МСК</p>
<h2 id="1-назначение-документа">1. Назначение документа</h2>
<p>Дать разработчику исчерпывающее понимание логики работы прошивки контроллера АПК Синапс.</p>
<h2 id="2-базовые-документы">2. Базовые документы</h2>
<ul>
<li><strong><a href="../PDS/SynapsePDS_FW.html">SynapsePDS_FW</a></strong> — описание прошивки контроллера</li>
<li><strong><a href="../PDS/SynapsePDS_FW_DB.html">SynapsePDS_FW_DB</a></strong> — структура базы данных прошивки</li>
<li><strong><a href="../PDS/SynapsePDS_USML.html">SynapsePDS_USML</a></strong> — протокол обмена данными</li>
</ul>
<h2 id="3-термины-и-определения">3. Термины и определения</h2>
<p>3.1. <strong>FW-USM</strong> (Unit System Model прошивки) — виртуальная модель системы освещения в прошивке. Представляет собой набор массивов структур языка С, хранящих состояние всех устройств DALI-линии, настройки локаций, групп, действия, расписание и другие данные. Структура описана в <strong><a href="../PDS/SynapsePDS_FW_DB.html">SynapsePDS_FW_DB</a></strong>.</p>
<p>3.2. <strong>APP-USM</strong> — виртуальная модель системы освещения в приложении (SQLite). Является кэшем FW-USM для оперативного доступа UI и LLM к данным контроллера.</p>
<p>3.3. <strong>USML</strong> (Unit System Model Language) — бинарный протокол передачи данных между прошивкой и приложением.</p>
<p>3.4. <strong>Телеграмма</strong> (телега) — команда в формате USML, содержащая изменения USM.</p>
<p>3.5. <strong>Рабочие данные</strong> — данные для организации работы освещения (яркость светильников, адреса DALI, действия датчиков и т.п.). Хранятся в прошивке в виде массивов структур C.</p>
<p>3.6. <strong>Интерфейсные данные</strong> (IDATA) — данные для UI приложения (названия, номера иконок, координаты). В прошивке хранятся единым блоком размером 50000 байт.</p>
<p>3.7. <strong>ACTION</strong> — действие, состоящее из одного или нескольких поддействий (SUBACTION).</p>
<p>3.8. <strong>SUBACTION</strong> — элементарное изменение системы освещения (включение сцены у светильника/группы/локации, установка температуры TW, переключение режима АВТО).</p>
<h2 id="4-базовые-принципы">4. Базовые принципы</h2>
<h3 id="41-режимы-работы-контроллера">4.1. Режимы работы контроллера</h3>
<p>4.1.1. Прошивка в контроллере может работать в двух режимах:</p>
<ul>
  <li><strong>Автономный режим</strong> — контроллер обрабатывает сигналы от настенных кнопок, датчиков присутствия, датчиков освещённости, обеспечивает работу по расписанию.
  </li>
  <li><strong>Режим с подключением телефонов</strong> — дополнительно к автономному режиму осуществляется ПНР, настройка и оперативное управление системой освещения.
  </li>
</ul>
<p>4.1.2. К контроллеру одновременно могут быть подключены до 4 телефонов.</p>
<h3 id="42-управление-через-изменение-данных">4.2. Управление через изменение данных</h3>
<p>4.2.1. Все команды на выполнение действий передаются от телефонов контроллеру через изменение данных FW-USM.</p>
<p>4.2.2. Нет команд типа "запустить инициализацию". Вместо этого приложение изменяет поле <strong>CONTROLLERS.STATUS</strong> = <code>I</code>, что запускает соответствующую логику в прошивке.</p>
<p>4.2.3. То, какой код отработает в прошивке, определяется тем, какие данные в FW-USM меняются.</p>
<h3 id="43-синхронизация-usm">4.3. Синхронизация USM</h3>
<p>4.3.1. В телеграммах от приложения к прошивке передаются изменения, которые пользователь хочет внести в систему освещения.</p>
<p>4.3.2. Получив телеграмму с изменениями, прошивка:</p>
<ul>
  <li>Анализирует, какие данные изменились;
  </li>
  <li>Выполняет соответствующие действия (отправка команд в DALI, изменение внутреннего состояния);
  </li>
  <li>Обновляет свой FW-USM;
  </li>
  <li>Отправляет телеграмму с изменениями всем подключённым телефонам (широковещательно).
  </li>
</ul>
<p>4.3.3. После любого изменения FW-USM прошивка отправляет телегу об этом всем подключённым телефонам (до 4 шт). Тем самым обеспечивается синхронизация FW-USM и APP-USM всех телефонов.</p>
<p>4.3.4. В телеграммах передаются только изменившиеся данные, а не весь FW-USM целиком.</p>
<h3 id="44-пример-включение-светильника">4.4. Пример: включение светильника</h3>
<p>Приложение отправляет команду на включение светильника 3 с яркостью 55:</p>
<ol>
<li>Телеграмма с изменением <code>LUMINAIRES[3].VAL_BRIGHT = 55</code> приходит в контроллер.</li>
<li>Контроллер видит изменение яркости и отправляет DALI-команду светильнику с адресом <code>LUMINAIRES[3].DALI_ADDR</code>.</li>
<li>Контроллер обновляет <code>LUMINAIRES[3].VAL_BRIGHT = 55</code> в своём FW-USM.</li>
<li>Изменение широковещательно отправляется телеграммой всем подключённым телефонам.</li>
</ol>
<h2 id="5-взаимодействие-с-телефоном">5. Взаимодействие с телефоном</h2>
<h3 id="51-bluetooth-подключение">5.1. Bluetooth-подключение</h3>
<p>5.1.1. Контроллер работает как периферийное устройство (Peripheral).</p>
<p>5.1.2. Телефоны работают как центральные устройства (Central).</p>
<p>5.1.3. К контроллеру могут одновременно подключиться до 4 телефонов.</p>
<p>5.1.4. Если подключено 4 телефона, контроллер не выдаёт в эфир адвертайзных сигналов.</p>
<p>5.1.5. Имя Bluetooth-устройства:</p>
<ul>
  <li>По умолчанию: <code>SYNAPSE XXXXXXXX</code> (XXXXXXXX — серийный номер);
  </li>
  <li>После изменения имени/иконки: <code>[ICO]Name</code> (ICO — номер иконки в квадратных скобках; строка парсится в приложении и пользователю показывается иконка и имя без <code>[ICO]</code>).
  </li>
</ul>
<h3 id="52-протокол-обмена-телеграммами">5.2. Протокол обмена телеграммами</h3>
<p>5.2.1. Телеграммы передаются в бинарном формате USML.</p>
<p>5.2.2. Структура USML-телеграммы:</p>
<ul>
  <li><strong>Реестр</strong> — битовая маска, определяющая, какие таблицы/записи/поля содержатся в телеграмме;
  </li>
  <li><strong>Данные</strong> — последовательность байтов значений полей в порядке, определённом реестром.
  </li>
</ul>
<p>5.2.3. При получении телеги от телефона прошивка должна отправить подтверждение успешного получения.</p>
<p>5.2.4. При отправке телеги телефону прошивка должна получить подтверждение. При отсутствии подтверждения — повторная отправка 2 дополнительных раза с интервалом 1 сек. Если ответа нет, считаем связь потеранной и отключаем телефон.</p>
<p>5.2.5. Телеги от прошивки отправляются широковещательно ВСЕМ подключённым телефонам.</p>
<h3 id="53-обновление-даты-и-времени">5.3. Обновление даты и времени</h3>
<p>5.3.1. При каждом подключении телефона к контроллеру приложение отправляет телеграмму с изменением <strong>CONTROLLERS.TIMESTAMP</strong>.</p>
<p>5.3.2. Значение передаётся в формате Unix timestamp (uint32_t) — количество секунд с 01.01.1970 00:00:00 UTC.</p>
<p>5.3.3. Прошивка обновляет свои внутренние часы для работы расписания.</p>
<h2 id="6-загрузка-usm-контроллера-в-телефон">6. Загрузка USM контроллера в телефон</h2>
<h3 id="61-первое-подключение-к-контроллеру">6.1. Первое подключение к контроллеру</h3>
<p>6.1.1. При первом подключении телефона к контроллеру прошивка сразу отправляет полный дамп FW-USM.</p>
<p>6.1.2. Дамп включает:</p>
<ul>
  <li>Рабочие данные (все таблицы FW-USM);
  </li>
  <li>Интерфейсные данные (блок IDATA).
  </li>
</ul>
<p>6.1.3. Приложение создаёт запись в таблице <strong>CONTROLLERS</strong> своей APP-USM и распаковывает полученные данные.</p>
<p>6.1.4. Приложение проверяет пароль и при неверном пароле блокирует работу с контроллером.</p>
<h3 id="62-повторное-подключение">6.2. Повторное подключение</h3>
<p>6.2.1. Прошивка отправляет полный дамп FW-USM для синхронизации с APP-USM телефона.</p>
<p>6.2.2. Приложение обновляет свою APP-USM данными из FW-USM.</p>
<h3 id="63-восстановление-связи-после-разрыва">6.3. Восстановление связи после разрыва</h3>
<p>6.3.1. При кратковременном разрыве связи приложение пытается восстановить соединение.</p>
<p>6.3.2. Приложение делает 3 попытки восстановления связи с интервалом 1 секунда между попытками.</p>
<p>6.3.3. После неудачных попыток приложение выкидывает пользователя в список контроллеров.</p>
<p>6.3.4. Прошивка отправляет актуальное состояние FW-USM для синхронизации.</p>
<h3 id="64-одновременная-работа-нескольких-телефонов">6.4. Одновременная работа нескольких телефонов</h3>
<p>6.4.1. Все телеграммы от контроллера отправляются одновременно всем подключённым телефонам.</p>
<p>6.4.2. При подключении второго/третьего/четвёртого телефона прошивка отправляет им текущий полный дамп FW-USM.</p>
<p>6.4.3. Все изменения FW-USM, вызванные действиями любого из телефонов, рассылаются всем подключённым телефонам.</p>
<p>6.4.4. Каждое приложение обновляет свой APP-USM при получении телеграмм от прошивки.</p>
<h2 id="7-пуско-наладочные-работы">7. Пуско-наладочные работы</h2>
<h3 id="71-сохранение-idata">7.1. Сохранение IDATA</h3>
<p>7.1.1. Блок интерфейсных данных IDATA хранится в энергонезависимой памяти контроллера. Он хранит все редко изменяемые ПНР-данные кроме ПНР-данных в таблице CONTROLLERS.</p>
<p>7.1.2. При любом изменении интерфейсных данных через приложение прошивка:</p>
<ul>
  <li>Получает телеграмму с новым блоком IDATA;
  </li>
  <li>Записывает его в энергонезависимую память;
  </li>
  <li>Рассылает изменения всем подключённым телефонам.
  </li>
</ul>
<p>7.1.3. При инициализации линии DALI блок IDATA сбрасывается.</p>
<h3 id="72-инициализация-линии-dali">7.2. Инициализация линии DALI</h3>
<p>7.2.1. Инициализация стартуется телеграммой с изменением <strong>CONTROLLERS.STATUS</strong> = <code>I</code>.</p>
<p>7.2.2. При получении этой телеграммы прошивка:</p>
<ul>
  <li>Сбрасывает все данные FW-USM (кроме NAME, PASSWORD, ICO_NUM контроллера);
  </li>
  <li>Сбрасывает состояние всех устройств в линии DALI к состоянию RESET (DALI-команда);
  </li>
  <li>Ставит в своей USM <strong>CONTROLLERS.STATUS</strong> = <code>I</code>;
  </li>
  <li>Рассылает изменения всем телефонам.
  </li>
</ul>
<p>7.2.3. Прошивка производит инициализацию светильников:</p>
<ul>
  <li>Широковещательно выключает все светильники (DALI-команда);
  </li>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Присваивает каждому найденному светильнику короткий адрес;
  </li>
  <li>Добавляет светильники в FW-USM с:
<ul>
  <li><code>EXIST = T</code>;
  </li>
  <li><code>LOCATION_ID = -1</code> (без локации);
  </li>
  <li><code>GROUP_ID = -1</code> (без группы);
  </li>
  <li><code>DALI_ADDR</code> — присвоенный короткий адрес;
  </li>
  <li>Начальными значениями VAL_BRIGHT, VAL_TW и т.д. из устройства-свтильника DALI;
  </li>
  <li><code>STATUS = A</code>.
  </li>
</ul>
  </li>
  <li>Включает светильник (DALI-команда) после присвоения адреса.
  </li>
</ul>
<p>7.2.4. Прошивка инициализирует сцены 0-4 во всех DALI-светильниках и своей USM:</p>
<ul>
  <li>Сцена 0: яркость 0% (выключено);
  </li>
  <li>Сцена 1: яркость 25%;
  </li>
  <li>Сцена 2: яркость 50%;
  </li>
  <li>Сцена 3: яркость 75%;
  </li>
  <li>Сцена 4: яркость 100%;
  </li>
  <li>Для RGB-светильников: красный цвет с максимальной насыщенностью.
  </li>
</ul>
<p>7.2.5. Прошивка производит инициализацию устройств управления (датчики, кнопочные панели):</p>
<ul>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Присваивает короткие адреса;
  </li>
  <li>Добавляет в FW-USM с:
<ul>
  <li><code>EXIST = T</code>;
  </li>
  <li><code>LOCATION_ID = -1</code> (без локации);
  </li>
  <li><code>STATUS = A</code>;
  </li>
  <li>Остальные поля — по умолчанию (для датчиков присутствия ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1, для кнопок ACTION_SET_SHORT_NUM = -1, ACTION_LONG_ID = -1).
  </li>
</ul>
  </li>
  <li>Включает светодиоды на кнопочных панелях (DALI-команда).
  </li>
</ul>
<p>7.2.7. После завершения инициализации прошивка:</p>
<ul>
  <li>Ставит в своей USM <strong>CONTROLLERS.STATUS</strong> = <code>A</code>;
  </li>
  <li>Рассылает финальное состояние FW-USM всем телефонам.
  </li>
</ul>
<h3 id="73-расширение-линии-dali">7.3. Расширение линии DALI</h3>
<p>7.3.1. Расширение стартуется телеграммой с изменением <strong>CONTROLLERS.STATUS</strong> = <code>E</code> (расширение).</p>
<p>7.3.2. Расширение производится аналогично инициализации, но <strong>без сброса FW-USM</strong>.</p>
<p>7.3.3. Прошивка:</p>
<ul>
  <li>Выполняет поиск устройств в линии DALI;
  </li>
  <li>Находит устройства без короткого адреса (новые);
  </li>
  <li>Присваивает им адреса;
  </li>
  <li>Добавляет в свободные слоты FW-USM (где <code>EXIST = F</code>);
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.3.4. Новые устройства добавляются с дефолтными параметрами без локации и группы.</p>
<h3 id="74-замена-устройства-в-линии-dali">7.4. Замена устройства в линии DALI</h3>
<p>7.4.1. Замена стартуется телеграммой с изменением <strong>LUMINAIRES[i].STATUS</strong> = <code>C</code> (или <strong>PRES_SENSORS[i].STATUS</strong> = <code>C</code> и т.д.).</p>
<p>7.4.2. Прошивка выполняет расширение линии (как в п. 7.3).</p>
<p>7.4.3. Прошивка находит устройства того же типа без привязки (новые).</p>
<p>7.4.4. Если найдено одно новое устройство нужного типа:</p>
<ul>
  <li>Прошивка копирует все настройки из записи заменяемого устройства в запись нового;
  </li>
  <li>Присваивает новому устройству короткий адрес старого (DALI-команда);
  </li>
  <li>Отправляет необходимые DALI-команды для установки параметров (MIN_LEVEL, MAX_LEVEL, FADE_TIME и т.д.);
  </li>
  <li>Ставит <strong>STATUS</strong> = <code>A</code>.
  </li>
</ul>
<p>7.4.5. Если найдено несколько устройств нужного типа:</p>
<ul>
  <li>Прошивка сообщает приложению о неоднозначности;
  </li>
  <li>Пользователь выбирает нужное устройство в UI;
  </li>
  <li>Приложение отправляет телеграмму с указанием конкретного устройства;
  </li>
  <li>Прошивка завершает замену.
  </li>
</ul>
<p>7.4.6. Прошивка рассылает изменения всем телефонам.</p>
<h3 id="75-создание-изменение-и-удаление-локаций-распределение-по-ним-устройств">7.5. Создание, изменение и удаление локаций, распределение по ним устройств</h3>
<p>7.5.1. <strong>Создание локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].EXIST</strong> = <code>T</code> для свободного слота.</p>
<p>7.5.2. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.5.3. <strong>Перемещение устройства в локацию</strong>: приложение отправляет телеграмму с изменением <strong>LUMINAIRES[j].LOCATION_ID</strong> = <code>i</code>.</p>
<p>7.5.4. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.5.5. <strong>Удаление локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].EXIST</strong> = <code>F</code>.</p>
<p>7.5.6. Прошивка:</p>
<ul>
  <li>Проверяет, что в локации нет устройств (или переносит их в корень);
  </li>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<h3 id="76-создание-изменение-и-удаление-групп-распределение-по-ним-устройств">7.6. Создание, изменение и удаление групп, распределение по ним устройств</h3>
<p>7.6.1. <strong>Создание группы</strong>: приложение отправляет телеграмму с изменением <strong>GROUPS[i].EXIST</strong> = <code>T</code> и <strong>GROUPS[i].LOCATION_ID</strong> = <code>loc</code> (или -1 для корня).</p>
<p>7.6.2. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.6.3. <strong>Добавление светильника в группу</strong>: приложение отправляет телеграмму с изменением <strong>LUMINAIRES[j].GROUP_ID</strong> = <code>i</code>.</p>
<p>7.6.4. Прошивка:</p>
<ul>
  <li>Проверяет, что светильник и группа в одной локации (или оба в корне);
  </li>
  <li>Отправляет DALI-команду присвоения светильника группе i;
  </li>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.6.5. <strong>Удаление группы</strong>: приложение отправляет телеграмму с изменением <strong>GROUPS[i].EXIST</strong> = <code>F</code>.</p>
<p>7.6.6. Прошивка:</p>
<ul>
  <li>Убирает у всех светильников с <strong>GROUP_ID</strong> = <code>i</code> привязку к группе (GROUP_ID = -1);
  </li>
  <li>Отправляет соответствующие DALI-команды;
  </li>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<h3 id="77-именование-и-раздача-пиктограмм-контроллеру-локациям-устройствам">7.7. Именование и раздача пиктограмм контроллеру, локациям, устройствам</h3>
<p>7.7.1. Изменение имени/иконки — это изменение интерфейсных данных в блоке IDATA.</p>
<p>7.7.2. Приложение отправляет телеграмму с новым блоком IDATA или его частью.</p>
<p>7.7.3. Прошивка:</p>
<ul>
  <li>Обновляет блок IDATA в FW-USM;
  </li>
  <li>Записывает изменения в энергонезависимую память;
  </li>
  <li>Рассылает изменения всем телефонам.
  </li>
</ul>
<p>7.7.4. Если изменилось имя или иконка контроллера:</p>
<ul>
  <li>Прошивка обновляет имя Bluetooth-устройства;
  </li>
  <li>Новое имя формата: <code>[ICO]Name</code>.
  </li>
</ul>
<h3 id="78-добавление-поддействия-в-действие">7.8. Добавление поддействия в действие</h3>
<p>7.8.1. <strong>Создание действия</strong>: приложение отправляет телеграмму с изменением:</p>
<ul>
  <li><strong>ACTIONS[i].ACTION_SET_NUM</strong> = <code>set</code> (номер набора действий, если действие входит в набор);
  </li>
  <li><strong>ACTIONS[i].POS</strong> = <code>pos</code> (позиция в наборе для перебора).
  </li>
</ul>
<p>7.8.2. <strong>Добавление поддействия</strong>: приложение отправляет телеграмму с заполнением записи <strong>SUBACTIONS[j]</strong>:</p>
<ul>
  <li><strong>ACTION_ID</strong> = <code>i</code>;
  </li>
  <li><strong>OBJECT_TYPE</strong> = тип объекта (1-объект, 2-локация, 3-группа, 4-светильник);
  </li>
  <li><strong>OBJECT_NUM</strong> = номер объекта;
  </li>
  <li><strong>VALUE</strong> = значение (номер сцены, температура TW, флаг АВТО).
  </li>
</ul>
<p>7.8.3. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.8.4. Никаких DALI-команд не отправляется, т.к. действие ещё не выполняется, а только настраивается.</p>
<h3 id="79-назначение-действий-на-присутствие-и-отсутствие-датчиков-присутствия">7.9. Назначение действий на присутствие и отсутствие датчиков присутствия</h3>
<p>7.9.1. Приложение отправляет телеграмму с изменением:</p>
<ul>
  <li><strong>PRES_SENSORS[i].ACTION_OCCUPANCY_ID</strong> = <code>j</code> (действие на присутствие);
  </li>
  <li><strong>PRES_SENSORS[i].ACTION_VACANCY_ID</strong> = <code>k</code> (действие на отсутствие).
  </li>
</ul>
<p>7.9.2. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.9.3. Датчик начинает отрабатывать действия при соответствующих событиях (если АВТО включено).</p>
<h3 id="710-привязка-датчиков-освещённости-к-группам-светильников">7.10. Привязка датчиков освещённости к группам светильников</h3>
<p>7.10.1. Приложение отправляет телеграмму с изменением <strong>BRIGHT_SENSORS[i].GROUP_ID</strong> = <code>j</code>.</p>
<p>7.10.2. Прошивка проверяет, что датчик и группа в одной локации (или оба в корне).</p>
<p>7.10.3. Прошивка последовательно переводит группу в сцены 0-4 (DALI-команды).</p>
<p>7.10.4. Для каждой сцены прошивка:</p>
<ul>
  <li>Считывает текущую освещённость с датчика (DALI-команда);
  </li>
  <li>Сохраняет значение как целевую освещённость для этой сцены.
  </li>
</ul>
<p>7.10.5. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<h3 id="711-назначение-действий-на-настенные-кнопки">7.11. Назначение действий на настенные кнопки</h3>
<p>7.11.1. Приложение отправляет телеграмму с изменением:</p>
<ul>
  <li><strong>BUTTONS[i].ACTION_SET_SHORT_NUM</strong> = <code>set</code> (набор действий на короткое нажатие);
  </li>
  <li><strong>BUTTONS[i].ACTION_LONG_ID</strong> = <code>j</code> (действие на долгое нажатие).
  </li>
</ul>
<p>7.11.2. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>7.11.3. Кнопка начинает отрабатывать действия при нажатиях.</p>
<h2 id="8-настройка">8. Настройка</h2>
<h3 id="81-изменение-параметров-устройств">8.1. Изменение параметров устройств</h3>
<p>8.1.1. Для изменения параметров DALI-устройств приложение отправляет телеграмму с изменением соответствующих полей в FW-USM.</p>
<p>8.1.2. Примеры параметров:</p>
<ul>
  <li><strong>MIN_LEVEL</strong>, <strong>MAX_LEVEL</strong> светильников;
  </li>
  <li><strong>FADE_TIME</strong> светильников;
  </li>
  <li><strong>DELAY</strong> (HOLD_TIME) датчиков присутствия.
  </li>
</ul>
<p>8.1.3. Прошивка:</p>
<ul>
  <li>Отправляет DALI-команду установки параметра устройству;
  </li>
  <li>Обновляет FW-USM (если параметр хранится в USM);
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<h3 id="82-сохранение-световых-сцен">8.2. Сохранение световых сцен</h3>
<p>8.2.1. <strong>Сохранение сцены отдельного светильника</strong>:</p>
<ul>
  <li>Пользователь устанавливает нужную яркость/цвет/температуру светильника;
  </li>
  <li>Приложение отправляет команду на сохранение сцены N;
  </li>
  <li>Прошивка отправляет DALI-команду сохранения текущего состояния в сцену N;
  </li>
  <li>Прошивка обновляет таблицу <strong>SCENE_LUMINAIRES</strong>;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>8.2.2. <strong>Сохранение сцены группы</strong>:</p>
<ul>
  <li>Пользователь устанавливает нужное состояние светильников группы;
  </li>
  <li>Приложение отправляет команду на сохранение сцены N для группы i;
  </li>
  <li>Прошивка отправляет групповую DALI-команду сохранения сцены N;
  </li>
  <li>Прошивка обновляет <strong>SCENE_LUMINAIRES</strong> для всех светильников группы;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<h3 id="83-формирование-и-активация-расписания">8.3. Формирование и активация расписания</h3>
<p>8.3.1. <strong>Добавление события в расписание</strong>: приложение отправляет телеграмму с заполнением записи <strong>EVENTS[i]</strong>:</p>
<ul>
  <li><strong>EXIST</strong> = <code>T</code>;
  </li>
  <li><strong>DAYS</strong> = маска дней недели (например, 'FFTFFFF' — только вторник);
  </li>
  <li><strong>TIME</strong> = время в формате HHMM;
  </li>
  <li><strong>SMOOTH</strong> = <code>T</code> (плавное изменение) или <code>F</code> (одномоментное);
  </li>
  <li><strong>ACTION_ID</strong> = <code>j</code> (действие для выполнения).
  </li>
</ul>
<p>8.3.2. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>8.3.3. <strong>Активация расписания</strong>: приложение отправляет телеграмму с изменением <strong>CONTROLLERS.IS_SCHEDULE</strong> = <code>T</code>.</p>
<p>8.3.4. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Начинает проверку событий расписания каждую минуту;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>8.3.5. <strong>Деактивация расписания</strong>: приложение отправляет <strong>CONTROLLERS.IS_SCHEDULE</strong> = <code>F</code>.</p>
<h2 id="9-оперативное-управление">9. Оперативное управление</h2>
<h3 id="91-изменение-яркости-цвета-температуры-светильника">9.1. Изменение яркости, цвета, температуры светильника</h3>
<p>9.1.1. Приложение отправляет телеграмму с изменением полей светильника:</p>
<ul>
  <li><strong>LUMINAIRES[i].VAL_BRIGHT</strong> = значение яркости;
  </li>
  <li><strong>LUMINAIRES[i].VAL_TW</strong> = температура белого;
  </li>
  <li><strong>LUMINAIRES[i].VAL_R</strong>, <strong>VAL_G</strong>, <strong>VAL_B</strong>, <strong>VAL_W</strong> = цвета.
  </li>
</ul>
<p>9.1.2. Прошивка:</p>
<ul>
  <li>Отправляет DALI-команду установки параметров светильнику;
  </li>
  <li>Обновляет FW-USM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>9.1.3. Если светильник находится в локации с включённым АВТО, оперативное управление временно переводит <strong>LOCATIONS[loc].IS_AUTO</strong> = <code>F</code>.</p>
<p>9.1.4. Возврат в режим АВТО происходит при срабатывании датчика присутствия в этой локации.</p>
<h3 id="92-включение-сцены">9.2. Включение сцены</h3>
<p>9.2.1. Включение сцены может быть:</p>
<ul>
  <li>У отдельного светильника;
  </li>
  <li>У группы светильников;
  </li>
  <li>У локации (всех светильников локации);
  </li>
  <li>У корня (всех светильников в корне);
  </li>
  <li>У всего объекта (всех светильников контроллера).
  </li>
</ul>
<p>9.2.2. Приложение отправляет телеграмму с изменением:</p>
<ul>
  <li><strong>LUMINAIRES[i].SCENE_NUM</strong> = N (для светильника);
  </li>
  <li><strong>GROUPS[i].SCENE_NUM</strong> = N (для группы);
  </li>
  <li><strong>LOCATIONS[i].SCENE_NUM</strong> = N (для локации);
  </li>
  <li><strong>CONTROLLERS.SCENE_NUM</strong> = N (для объекта).
  </li>
</ul>
<p>9.2.3. Прошивка:</p>
<ul>
  <li>Отправляет DALI-команду включения сцены N соответствующим устройствам;
  </li>
  <li>Обновляет поля VAL_BRIGHT, VAL_TW и т.д. из таблицы <strong>SCENE_LUMINAIRES</strong>;
  </li>
  <li>Обновляет SCENE_NUM;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<p>9.2.4. Если у группы есть привязанный датчик освещённости, включение сцены переводит группу в режим поддержания целевой освещённости.</p>
<h3 id="93-включениевыключение-режима-авто">9.3. Включение/выключение режима АВТО</h3>
<p>9.3.1. <strong>У локации</strong>: приложение отправляет телеграмму с изменением <strong>LOCATIONS[i].IS_AUTO</strong> = <code>T</code> или <code>F</code>.</p>
<p>9.3.2. <strong>У контроллера</strong>: приложение отправляет телеграмму с изменением <strong>CONTROLLERS.IS_AUTO</strong> = <code>T</code> или <code>F</code>.</p>
<p>9.3.3. Прошивка:</p>
<ul>
  <li>Обновляет FW-USM;
  </li>
  <li>Если АВТО выключается — датчики перестают влиять на освещение;
  </li>
  <li>Если АВТО включается — датчики начинают отрабатывать действия;
  </li>
  <li>Рассылает изменения телефонам.
  </li>
</ul>
<h2 id="10-работа-по-датчикам">10. Работа по датчикам</h2>
<h3 id="101-датчики-присутствия">10.1. Датчики присутствия</h3>
<p>10.1.1. Прошивка постоянно опрашивает датчики присутствия в линии DALI (в периоды затишья).</p>
<p>10.1.2. При регистрации события присутствия на датчике i:</p>
<ul>
  <li>Прошивка проверяет <strong>CONTROLLERS.IS_AUTO</strong>. Если <code>F</code> — игнорирует событие.
  </li>
  <li>Прошивка проверяет, в какой локации находится датчик (<strong>PRES_SENSORS[i].LOCATION_ID</strong>).
  </li>
  <li>Если датчик в локации — проверяет <strong>LOCATIONS[loc].IS_AUTO</strong>. Если <code>F</code> — игнорирует событие.
  </li>
  <li>Если датчик в корне — событие обрабатывается при <strong>CONTROLLERS.IS_AUTO</strong> = <code>T</code>.
  </li>
  <li>Прошивка выполняет действие <strong>PRES_SENSORS[i].ACTION_OCCUPANCY_ID</strong>.
  </li>
</ul>
<p>10.1.3. При регистрации события отсутствия на датчике i:</p>
<ul>
  <li>Аналогичные проверки флагов АВТО;
  </li>
  <li>Прошивка выполняет действие <strong>PRES_SENSORS[i].ACTION_VACANCY_ID</strong>.
  </li>
</ul>
<p>10.1.4. Действие отсутствия срабатывает через задержку <strong>PRES_SENSORS[i].DELAY</strong> (HOLD_TIME).</p>
<p>10.1.5. Если есть желание деактивировать датчик — у него убираются действия (ACTION_OCCUPANCY_ID = -1, ACTION_VACANCY_ID = -1).</p>
<h3 id="102-датчики-освещённости">10.2. Датчики освещённости</h3>
<p>10.2.1. Прошивка постоянно опрашивает датчики освещённости в периоды затишья.</p>
<p>10.2.2. Если у датчика i назначена группа (<strong>BRIGHT_SENSORS[i].GROUP_ID</strong> != -1):</p>
<ul>
  <li>Прошивка проверяет флаги АВТО аналогично п. 10.1.2;
  </li>
  <li>Прошивка считывает текущую освещённость с датчика;
  </li>
  <li>Прошивка сравнивает с целевой освещённостью для текущей сцены группы;
  </li>
  <li>Если отклонение больше порога — прошивка корректирует яркость светильников группы (DALI-команды).
  </li>
</ul>
<p>10.2.3. Подкрутка яркости работает только если у группы включена одна из сцен 0-4.</p>
<p>10.2.4. Любое изменение яркости группы, отличное от включения сцены, отключает подкрутку до следующего включения сцены.</p>
<p>10.2.5. Если есть желание деактивировать датчик — у него убирается привязка к группе (GROUP_ID = -1).</p>
<h3 id="103-логика-режима-авто">10.3. Логика режима АВТО</h3>
<p>10.3.1. <strong>Главный флаг АВТО</strong> (<strong>CONTROLLERS.IS_AUTO</strong>):</p>
<ul>
  <li>Если <code>F</code> — все датчики игнорируются;
  </li>
  <li>Если <code>T</code> — работают флаги АВТО локаций.
  </li>
</ul>
<p>10.3.2. <strong>Флаг АВТО локации</strong> (<strong>LOCATIONS[i].IS_AUTO</strong>):</p>
<ul>
  <li>Если <code>F</code> — датчики этой локации игнорируются;
  </li>
  <li>Если <code>T</code> — датчики локации отрабатывают действия.
  </li>
</ul>
<p>10.3.3. <strong>Устройства в корне</strong> (без локации):</p>
<ul>
  <li>Работают при <strong>CONTROLLERS.IS_AUTO</strong> = <code>T</code>.
  </li>
</ul>
<p>10.3.4. <strong>Временное отключение АВТО при оперативном управлении</strong>:</p>
<ul>
  <li>Оперативное управление хотя бы одним светильником в локации переводит <strong>LOCATIONS[i].IS_AUTO</strong> = <code>F</code>;
  </li>
  <li>Возврат в АВТО при срабатывании датчика присутствия в этой локации (событие присутствия);
  </li>
  <li>При возврате в АВТО датчик сразу отрабатывает действие на присутствие.
  </li>
</ul>
<h2 id="11-работа-по-расписанию">11. Работа по расписанию</h2>
<h3 id="111-проверка-событий">11.1. Проверка событий</h3>
<p>11.1.1. Если <strong>CONTROLLERS.IS_SCHEDULE</strong> = <code>T</code>, прошивка каждую минуту проверяет события в таблице <strong>EVENTS</strong>.</p>
<p>11.1.2. Прошивка сравнивает текущее время и день недели с данными в записях <strong>EVENTS</strong>.</p>
<p>11.1.3. Если время и день совпадают:</p>
<ul>
  <li>Прошивка выполняет действие <strong>EVENTS[i].ACTION_ID</strong>.
  </li>
</ul>
<h3 id="112-типы-событий">11.2. Типы событий</h3>
<p>11.2.1. <strong>Ежедневное событие</strong>: <strong>EVENTS[i].DAYS</strong> = 'FFFFFFF' (все дни F).</p>
<p>11.2.2. <strong>Событие по дням недели</strong>: <strong>EVENTS[i].DAYS</strong> содержит T в соответствующих днях (например, 'FFTFFFF' — вторник).</p>
<p>11.2.3. Если на одно время назначено ежедневное событие и событие по дням недели:</p>
<ul>
  <li>Сначала выполняется ежедневное;
  </li>
  <li>Затем выполняется событие по дням недели.
  </li>
</ul>
<h3 id="113-режим-выполнения">11.3. Режим выполнения</h3>
<p>11.3.1. <strong>Одномоментное выполнение</strong> (<strong>EVENTS[i].SMOOTH</strong> = <code>F</code>):</p>
<ul>
  <li>Параметры устройств меняются сразу;
  </li>
  <li>Прошивка отправляет DALI-команды с параметрами из действия.
  </li>
</ul>
<p>11.3.2. <strong>Плавное выполнение</strong> (<strong>EVENTS[i].SMOOTH</strong> = <code>T</code>):</p>
<ul>
  <li>Параметры устройств изменяются линейно от текущих к целевым;
  </li>
  <li>Изменение производится раз в 1 минуту;
  </li>
  <li>Прошивка вычисляет шаг изменения и постепенно меняет параметры.
  </li>
</ul>
<h3 id="114-выполнение-действия">11.4. Выполнение действия</h3>
<p>11.4.1. Действие состоит из одного или нескольких поддействий (<strong>SUBACTIONS</strong>).</p>
<p>11.4.2. Прошивка последовательно выполняет все поддействия действия:</p>
<ul>
  <li>Включение сцены (DALI-команда + обновление FW-USM);
  </li>
  <li>Установка температуры TW (DALI-команда + обновление FW-USM);
  </li>
  <li>Переключение АВТО (обновление FW-USM).
  </li>
</ul>
<p>11.4.3. После выполнения действия прошивка рассылает изменения всем телефонам.</p>
<h2 id="12-сброс-контроллера-железной-кнопкой">12. Сброс контроллера железной кнопкой</h2>
<h3 id="121-короткое-нажатие">12.1. Короткое нажатие</h3>
<p>12.1.1. Короткое нажатие сбрасывает только пароль к заводскому.</p>
<p>12.1.2. Прошивка:</p>
<ul>
  <li>Считывает заводской пароль из области хранения констант;
  </li>
  <li>Записывает его в <strong>CONTROLLERS.PASSWORD</strong>;
  </li>
  <li>Сохраняет в энергонезависимую память.
  </li>
</ul>
<p>12.1.3. Остальные данные FW-USM не изменяются.</p>
<h3 id="122-долгое-нажатие">12.2. Долгое нажатие</h3>
<p>12.2.1. Долгое нажатие сбрасывает все настройки прошивки (не исполняемый код) в заводское состояние.</p>
<p>12.2.2. Прошивка:</p>
<ul>
  <li>Сбрасывает все данные FW-USM;
  </li>
  <li>Сбрасывает блок IDATA;
  </li>
  <li>Восстанавливает заводское имя: <code>SYNAPSE XXXXXXXX</code>;
  </li>
  <li>Восстанавливает заводской пароль;
  </li>
  <li>Восстанавливает дефолтную иконку (0);
  </li>
  <li>Сохраняет в энергонезависимую память.
  </li>
</ul>
<p>12.2.3. После сброса контроллер требует инициализации линии DALI.</p>
<h2 id="13-индикация-на-контроллере">13. Индикация на контроллере</h2>
<h3 id="131-нижний-светодиод">13.1. Нижний светодиод</h3>
<p>13.1.1. Нижний светодиод мигает, если идёт работа с линией DALI:</p>
<ul>
  <li>Отправка команд устройствам;
  </li>
  <li>Чтение данных с устройств;
  </li>
  <li>Инициализация линии.
  </li>
</ul>
<p>13.1.2. В остальное время светодиод не горит.</p>
<h3 id="132-лесенка-светодиодов">13.2. Лесенка светодиодов</h3>
<p>13.2.1. Лесенка светодиодов загорается вся, если есть хотя бы одно Bluetooth-соединение с телефоном.</p>
<p>13.2.2. Если нет подключённых телефонов — вся лесенка не горит.</p>
<p>13.2.3. Количество горящих светодиодов не отражает количество подключённых телефонов (только факт наличия хотя бы одного).</p>
<h2 id="14-вопросы">14. Вопросы</h2>
<p>14.1. Как обрабатывать ситуацию, когда два телефона одновременно отправляют конфликтующие команды?</p>
<p>14.2. Нужна ли очередь команд от телефонов или обрабатывать их строго последовательно?</p>
<p>14.3. Как часто опрашивать датчики в линии DALI в периоды затишья?</p>
<p>14.4. Нужен ли режим отладки с расширенным логированием?</p>
<h2 id="15-идеи">15. <a href="../PRD/Идеи.html">Идеи</a></h2>
<p>15.1. Реализовать буферизацию телеграмм при кратковременных разрывах связи с телефонами.</p>
<p>15.2. Добавить watchdog для контроля зависания основного цикла прошивки.</p>
<p>15.3. Реализовать механизм обнаружения вышедших из строя устройств DALI (не отвечают на команды).</p>
<p>15.4. Добавить статистику работы: время работы с момента последнего сброса, количество циклов работы расписания и т.д.</p>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
