<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка. Логика работы - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script defer src="../assets/js/mermaid.min.js"></script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW_Logic.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка. Логика работы</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 04.12.2025</p>
<h2 id="1-термины-и-определения">1. Термины и определения</h2>
<p>1.1. <strong>Прошивка</strong> — firmware в контроллере.</p>
<p>1.2. <strong>Приложение</strong> — интерфейсное мобильное приложение в телефоне.</p>
<p>1.3. <strong>LLM</strong> — Large Language Model (большая языковая модель).</p>
<p>1.4. <strong>USML</strong> (Unit System Model Language) — система команд (телеграмм) для передачи данных в рамках АПК Синапс. Предназначен для общения LLM, мобильного приложения и прошивки контроллера. Описано в <a href="../PDS/SynapsePDS_USML.html">SynapsePDS_USML.md</a>.</p>
<p>1.5. <strong>База данных прошивки</strong> — разложенные по массивам структур Си «таблицы» с данными контроллера, светильников, датчиков и т.д. В описании логики называются таблицами, хотя и ежу понятно, что фактически формат хранения у них другой. Описано в <a href="../PDS/SynapsePDS_FW_DB.html">SynapsePDS_FW_DB.md</a>.</p>
<h2 id="2-взаимодействие-с-телефоном">2. Взаимодействие с телефоном</h2>
<p>2.1. С мобильным приложением прошивка работает через Bluetooth.</p>
<p>2.2. К контроллеру могут подключаться и параллельно работать с прошивкой до 4 телефонов.</p>
<p>2.3. Общение между приложением и прошивкой идёт через телеграммы.</p>
<p>2.4. Телеграммы, имеющие хождение в комплексе Синапс, бывают двух видов:</p>
<ul>
  <li><strong>софт-телеги</strong> (понимаемые приложением, LLM и нормальными людьми) — внутри приложения и между приложением и LLM
  </li>
  <li><strong>хард-телеги</strong> (понимаемые прошивкой и электронщиками) — между приложением и прошивкой
  </li>
</ul>
<p>2.5. На стыке между приложением и прошивкой подмножество софт-телег, которое имеет смысл в прошивке, конвертируется в хард-телеги и наоборот.</p>
<p>2.6. Стык (конвертер) находится на стороне приложения.</p>
<p>2.7. Формат телеграмм, соответствие софт-телег и хард-телег и язык USML в целом описаны в <a href="../PDS/SynapsePDS_USML.html">SynapsePDS_USML.md</a>.</p>
<p>2.8. При описании логики работы прошивки используются софт-версии телег.</p>
<p>2.9. Прошивке без разницы, сколько приложений со своих телефонов подключились к контроллеру и работают с ней:</p>
<ul>
  <li>приём телеграмм идёт как будто от одного устройства
  </li>
  <li>передача производится широковещательно
  </li>
</ul>
<p>2.10. Телеграммы можно разделить на:</p>
<ul>
  <li>телеги от приложения на запрос данных — в ответ на них прошивка отправляет запрошенные данные, при этом состояние данных прошивки не меняется
  </li>
  <li>телеги от приложения с командами на изменение данных в контроллере и/или отправку команд устройствам DALI — это команды на изменение имени контроллера, иконки, блока интерфейсных данных, расписания, яркости светильников, параметров светильников и датчиков и т.п.; прошивка при получении выполняет команду и отправляет телегу с новыми значениями всем подключённым телефонам, тем самым обеспечивая синхронизацию
  </li>
  <li>телеги от прошивки к приложениям, инициируемые самой прошивкой — это телеги об изменениях, произведённых самой прошивкой (отработка расписания, подстройка яркости по датчикам и т.п.), или пришедшие из линии DALI (нажатие кнопок, сработка датчиков)
  </li>
</ul>
<h2 id="3-данные-контроллера">3. Данные контроллера</h2>
<p>3.1. Данные, которые контроллер хранит в постоянной памяти:</p>
<ul>
  <li>NAME — имя контроллера (строка)
  </li>
  <li>PASSWORD — пароль (4 цифры) (строка)
  </li>
  <li>IS_SCHEDULE — флаг включена ли работа по расписанию (T/F)
  </li>
  <li>ICO_NUM — номер иконки контроллера (целое, значения 100..199)
  </li>
  <li>INTERFACE_DATA — интерфейсные данные (энное количество байтов; см. ниже)
  </li>
</ul>
<p>3.2. Все эти данные хранятся в единственной записи в таблице <strong><a href="SynapsePDS_FW_DB.md">CONTROLLERS</a></strong>.</p>
<p>3.2. Часть данных, которые контроллер хранит в постоянной памяти, являются интерфейсными — используемыми только приложениями. Их прошивка хранит единым блоком для синхронизации между несколькими телефонами. Единым блоком эти данные попадают в прошивку, единым блоком она приложению их и отдаёт. </p>
<p>3.3. Передача данных от приложения контроллеру (здесь и далее изменение названия):
<a href="../PDS/SynapsePDS_USML.html#42-contr-работа-с-контроллером" title="См. 4.2. CONTR_ в USML"><code>[FW.CONTR_SET_NAME(...)]</code></a></p>
<p>3.4. Передача данных от контроллера приложению:
<a href="../PDS/SynapsePDS_USML.html#42-contr-работа-с-контроллером" title="См. 4.2. CONTR_ в USML"><code>[USM.CONTR_SET_NAME(...)]</code></a></p>
<p>3.5. Запрос от приложения контроллеру:
<a href="../PDS/SynapsePDS_USML.html#42-contr-работа-с-контроллером" title="См. 4.2. CONTR_ в USML"><code>[FW.CONTR_GET_NAME()]</code></a> — запрос данных контроллера.
В ответ на эту телегу прошивка должна ответить телегой <a href="../PDS/SynapsePDS_USML.html#42-contr-работа-с-контроллером" title="См. 4.2. CONTR_ в USML"><code>[USM.CONTR_SET_NAME(...)]</code></a>.</p>
<div class="mermaid" data-diagram-url="SynapsePDS_FW_Logic_diagram_0.html">sequenceDiagram
    participant Приложение
    participant Прошивка

    Приложение->>Прошивка:[FW.CONTR_GET_NAME()]
    Прошивка->>Приложение:[USM.CONTR_SET_NAME(...)]
</div>
<h2 id="4-пуско-наладочные-работы">4. Пуско-наладочные работы</h2>
<h3 id="41-инициализация-линии-dali">4.1. Инициализация линии DALI</h3>
<p>4.1.1. Что такое</p>
<p>Удаляется из базы данных контроллера всё, что было настроено непосильным трудом (если что-то настраивалось), кроме настроек самого контроллера (имя, иконка, пароль). Инициализируются все светильники и устройства управления линии DALI, начиная с раздачи рандомных адресов и заканчивая сбросом всех настроек устройств в состояние RESET.</p>
<p>4.1.2. Порядок инициализации:</p>
<ul>
<li>
<p>Прошивка получает от приложения телегу <a href="../PDS/SynapsePDS_USML.html#41-dali-работа-с-линией-dali" title="См. 4.1. DALI_ в USML"><code>[FW.DALI_INIT()]</code></a>.</p>
</li>
<li>
<p>Отправляется телега приложению: <a href="../PDS/SynapsePDS_USML.html#41-dali-работа-с-линией-dali" title="См. 4.1. DALI_ в USML"><code>[FW.DALI_INIT_STATUS(START)]</code></a>.</p>
</li>
<li>
<p>Очищаются все таблицы кроме <strong><a href="SynapsePDS_FW_DB.md">CONTROLLERS</a></strong>. Устанавливается <strong><a href="SynapsePDS_FW_DB.md">CONTROLLERS</a></strong>.IS_SCHEDULE = F.</p>
</li>
<li>
<p>Широковещательно выключаются в линии все светильники и светодиоды кнопочных панелей.</p>
</li>
<li>
<p>Раздаются короткие DALI-адреса светильникам. Светильник, получивший адрес, включается на макс.</p>
</li>
<li>
<p>Светильники добавляются в таблицу <strong><a href="SynapsePDS_FW_DB.md">LUMINAIRES</a></strong>.</p>
</li>
<li>
<p>Отправляется телега приложению: <a href="../PDS/SynapsePDS_USML.html#41-dali-работа-с-линией-dali" title="См. 4.1. DALI_ в USML"><code>[FW.DALI_INIT_STATUS(LUM_CREATED)]</code></a>.</p>
</li>
<li>
<p>В светильники в линии DALI записываются значения для сцен 0..4.  </p>
<ul>
<li>реле (тип 7) яркость: 0 - 0%, 1..4 - 100%</li>
<li>диммируемые светодиодные (тип 6) яркости: 0, 25, 50, 75, 100% соответственно</li>
<li>RGB, RGBW (тип 8): красный цвет яркостью от 0, 25, 50, 75, 100%</li>
<li>TW (тип 8) яркости: 0, 25, 50, 75, 100% соответственно и температуру везде 4000K</li>
</ul>
</li>
<li>
<p>Отправляется телега приложению: <a href="../PDS/SynapsePDS_USML.html#41-dali-работа-с-линией-dali" title="См. 4.1. DALI_ в USML"><code>[FW.DALI_INIT_STATUS(LUM_READY)]</code></a>.</p>
</li>
<li>
<p>Раздаются короткие DALI-адреса устройствам управления.</p>
</li>
<li>
<p>Устройства управления добавляются в таблицы <strong><a href="SynapsePDS_FW_DB.md">BUTTON_PANELS</a></strong>, <strong><a href="SynapsePDS_FW_DB.md">BUTTONS</a></strong>, <strong><a href="SynapsePDS_FW_DB.md">PRES_SENSORS</a></strong>, <strong><a href="SynapsePDS_FW_DB.md">BRIGHT_SENSORS</a></strong>.</p>
</li>
<li>
<p>Отправляется телега приложению: <a href="../PDS/SynapsePDS_USML.html#41-dali-работа-с-линией-dali" title="См. 4.1. DALI_ в USML"><code>[FW.DALI_INIT_STATUS(FINISH)]</code></a>.</p>
</li>
</ul>
<div class="mermaid" data-diagram-url="SynapsePDS_FW_Logic_diagram_1.html">sequenceDiagram
    participant Приложение
    participant Прошивка
    participant Линия DALI

    Приложение->>Прошивка:[FW.DALI_INIT()]
    Прошивка->>Линия DALI:Запуск инита
    Прошивка->>Приложение:[FW.DALI_INIT_STATUS(START)]
    Прошивка->>Линия DALI:Инит светильников
    Прошивка->>Приложение:[FW.DALI_INIT_STATUS(LUM_CREATED)]
    Прошивка->>Линия DALI:Инит световых сцен
    Прошивка->>Приложение:[FW.DALI_INIT_STATUS(LUM_READY)]
    Прошивка->>Линия DALI:Инит устройств упр.
    Прошивка->>Приложение:[FW.DALI_INIT_STATUS(FINISH)]
</div>
<p>(Хотелось бы получать текущий статус инициализации более детализированно, поскольку процесс показывается пользователю в виде прогресс-бара.)</p>
<h3 id="42-расширение-линии-dali">4.2. Расширение линии DALI</h3>
<h3 id="43-замена-устройства-в-линии-dali">4.3. Замена устройства в линии DALI</h3>
<h2 id="5-настройка">5. Настройка</h2>
<h2 id="6-оперативное-управление">6. Оперативное управление</h2>
<h2 id="7-работа-по-датчикам">7. Работа по датчикам</h2>
<h2 id="8-работа-по-расписанию">8. Работа по расписанию</h2>
<h2 id="9-вопросы">9. Вопросы</h2>
<h2 id="10-идеи">10. Идеи</h2>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
