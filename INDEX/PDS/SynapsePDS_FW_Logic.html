<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прошивка. Логика работы - Synapse Documentation</title>
    <link rel="icon" type="image/png" href="../assets/img/Synapse_ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script>
        window.mermaid = {
            startOnLoad: true,
            theme: "default",
            securityLevel: "loose"
        };
    </script>
    <script defer src="../assets/js/mermaid.min.js"></script>
</head>
<body>
    <!-- Logo Bar -->
    <div class="header" style="background: var(--accent-primary); padding: 20px 0; margin-bottom: 0;">
        <div class="header-container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" style="margin-left: 10px;">
                <img src="../assets/img/Synapse_black.png" alt="Synapse" style="height: 50px; display: block;">
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="https://t.me/+az-cc3wBJssxNzcy" target="_blank" style="display: flex; align-items: center; color: white; text-decoration: none; transition: opacity 0.2s ease;">
                    <img src="../assets/img/telegram.svg" alt="Telegram" style="width: 24px; height: 24px; display: block;">
                </a>
                <a href="https://github.com/KhudyakovAlex/Synapse/blob/master/PDS\SynapsePDS_FW_Logic.md" target="_blank" style="color: white; text-decoration: none; font-weight: 500; font-size: 1.1em; transition: opacity 0.2s ease; margin-right: 10px;">GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="page-title-container" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px 20px 20px;">
        <h1 style="color: var(--accent-primary); font-size: 2.25em; margin: 0; padding-bottom: 15px; border-bottom: 3px solid var(--accent-primary); font-weight: normal;">Прошивка. Логика работы</h1>
    </div>

    <!-- Main Container -->
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 20px 60px 20px;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Содержание</h3>
            <ul>
                <!-- TOC will be auto-generated by JS -->
            </ul>
        </aside>

        <!-- Content -->
        <main class="content">
            
<p>АПК Синапс v1.0. ПО. Спецификации на разработку</p>
<p><strong>Последнее изменение:</strong> 08.12.2025</p>
<h2 id="1-термины-и-определения">1. Термины и определения</h2>
<p>1.1. <strong>Прошивка</strong> — firmware в контроллере.</p>
<p>1.2. <strong>Приложение</strong> — интерфейсное мобильное приложение в телефоне.</p>
<p>1.3. <strong>LLM</strong> — Large Language Model (большая языковая модель).</p>
<p>1.4. <strong>USM</strong> (Unit System Model) — виртуальная модель системы освещения.</p>
<p>1.5. <strong>USML</strong> (Unit System Model Language) — система команд (телеграмм) для передачи данных в рамках АПК Синапс. Описано в SynapsePDS_USML.</p>
<p>1.6. <strong>База данных прошивки</strong> — разложенные по массивам структур Си «таблицы» с данными контроллера, светильников, датчиков и т.д. В описании логики называются таблицами, хотя и ежу понятно, что фактически формат хранения у них другой. Описано в SynapsePDS_FW_DB.</p>
<h2 id="2-взаимодействие-с-телефоном">2. Взаимодействие с телефоном</h2>
<p>2.1. С мобильным приложением прошивка работает через Bluetooth.</p>
<p>2.2. К контроллеру могут подключаться и параллельно работать с прошивкой до 4 телефонов. В перспективе. Пока один.</p>
<p>2.3. Общение между приложением и прошивкой идёт через телеграммы.</p>
<p>2.4. Прошивке без разницы, сколько приложений со своих телефонов подключились к контроллеру и работают с ней:</p>
<ul>
  <li>приём телеграмм идёт как будто от одного устройства
  </li>
  <li>передача производится широковещательно
  </li>
</ul>
<p>2.5. Схема взаимодействия в общих чертах:</p>
<div class="mermaid" data-diagram-url="SynapsePDS_FW_Logic_diagram_0.html">flowchart TB
    SAW(Автономная<br>работа<br>контроллера<br>по датчикам<br> и расписанию)
    BC(Блютус-подключение<br>телефона<br>к контроллеру)
    WC(Работа<br>контроллера<br>по датчикам<br> и расписанию)
    DD(Загрузка USM<br>контроллера в телефон)
    P{Ввод пароля<br>пользователем}
    W(Управление<br>контроллером<br>с телефона)
    BDC(Блютус-отключение)
    EAW(Автономная<br>работа<br>контроллера<br>по датчикам<br> и расписанию)

    SAW-->BC
    BC-->DD
    BC-->WC
    DD-->P

    P -->|Угадал| W
    W-->BDC
    WC-->BDC
    P -->|Не угадал| BDC

    BDC-->EAW
</div>
<h2 id="3-загрузка-usm-контроллера-в-телефон">3. Загрузка USM контроллера в телефон</h2>
<p>3.1. После установки блютус-соединения ещё до проверки пользователя на знание пароля контроллер передаёт свою USM в приложение.</p>
<p>3.2. Передача производится USML-телегой <code>SET()</code>.</p>
<p>3.3. Т.о. в приложении оказывается своя копия USM-данных контроллера.</p>
<h2 id="4-пуско-наладочные-работы">4. Пуско-наладочные работы</h2>
<h3 id="41-сохранение-idata">4.1. Сохранение IDATA</h3>
<p>4.1.1. Передача интерфейсных данных с телефона на контроллер производится телегой <code>SET.CONTROLLERS[0].IDATA(...)</code>.</p>
<p>4.1.2. При получении её прошивка сохраняет данные в память и шлёт ту же телегу назад.</p>
<h3 id="42-инициализация-линии-dali">4.2. Инициализация линии DALI</h3>
<p>4.2.1. Происходит следующее:</p>
<ul>
  <li>В USM контроллера очищается всё кроме имени, иконки и пароля контроллера.
  </li>
  <li>В линии DALI происходит полный INITIALISE светильников и устройств управления.
  </li>
  <li>Согласно набору найденных устройств создаётся новая USM.
  </li>
  <li>Световые сцены 0..4 инициализируются начальными значениями.
  </li>
  <li>Новая версия USM передаётся в приложение.
  </li>
</ul>
<p>4.2.2. Никакие локации и группы при этом не создаются. Все устройства помещаются вне локаций в «корень». Их LOCATION_ID = -1.</p>
<p>4.2.3. Порядок инициализации:</p>
<ul>
<li>
<p>Прошивка получает от приложения телегу <code>SET.CONTROLLERS[0].STATUS(I)</code>.</p>
</li>
<li>
<p>Сама отвечает приложению телегой <code>SET.CONTROLLERS[0].STATUS(I)</code>.</p>
</li>
<li>
<p>Очищаются все таблицы кроме <strong>CONTROLLERS</strong> (поля EXIST выставляются в F). Все байты в IDATA сбрасываются в 0.</p>
</li>
<li>
<p>В единственной записи <strong>CONTROLLERS</strong> устанавливаются:</p>
<ul>
<li>NAME - не меняется</li>
<li>PASSWORD - не меняется</li>
<li>ICO_NUM - не меняется</li>
<li>IS_SCHEDULE = F</li>
<li>IS_AUTO = F</li>
<li>STATUS = A</li>
<li>SCENE_NUM = -1</li>
</ul>
</li>
<li>
<p>Широковещательно выключаются в линии все светильники и светодиоды кнопочных панелей.</p>
</li>
<li>
<p>Все устройства в линии DALI сбрасываются в состояние RESET.</p>
</li>
<li>
<p>Раздаются короткие DALI-адреса светильникам. Светильник, получивший адрес, включается на макс.</p>
</li>
<li>
<p>Светильники добавляются в таблицу <strong>LUMINAIRES</strong> с <strong>LOCATION_NUM = -1</strong> (без локации, в корне).</p>
</li>
<li>
<p>В светильники в линии DALI записываются значения для сцен 0..4.</p>
<ul>
<li>реле (тип 7) яркость: 0 — 0%, 1..4 — 100%</li>
<li>диммируемые светодиодные (тип 6) яркости: 0, 25, 50, 75, 100% соответственно</li>
<li>RGB, RGBW (тип 8): красный цвет яркостью от 0, 25, 50, 75, 100%</li>
<li>TW (тип 8) яркости: 0, 25, 50, 75, 100% соответственно и температуру везде 4000K</li>
</ul>
</li>
<li>
<p>Параллельно с инициализацией сцен в линии DALI инициализируется таблица <strong>SCENE_LUMINAIRES</strong>.</p>
</li>
<li>
<p>Раздаются короткие DALI-адреса устройствам управления.</p>
</li>
<li>
<p>Устройства управления добавляются в таблицы <strong>BUTTON_PANELS</strong>, <strong>BUTTONS</strong>, <strong>PRES_SENSORS</strong>, <strong>BRIGHT_SENSORS</strong> с <strong>LOCATION_NUM = -1</strong> (без локации, в корне).</p>
</li>
<li>
<p>Статус в CONTROLLERS.STATUS устанавливается в A.</p>
</li>
<li>
<p>Отправляется телега приложению: <code>SET()</code>.</p>
</li>
</ul>
<div class="mermaid" data-diagram-url="SynapsePDS_FW_Logic_diagram_1.html">sequenceDiagram
    participant Приложение
    participant Прошивка
    participant Линия DALI

    Приложение->>Прошивка:SET.CONTROLLERS[0].STATUS(A)
    Прошивка->>Приложение:SET.CONTROLLERS[0].STATUS(A)
    Прошивка->>Линия DALI:Запуск инита
    Прошивка->>Линия DALI:Инит светильников
    Прошивка->>Линия DALI:Инит световых сцен
    Прошивка->>Линия DALI:Инит устройств упр.
    Прошивка->>Приложение:SET()
</div>
<h3 id="43-расширение-линии-dali">4.3. Расширение линии DALI</h3>
<p>4.3.1. Производится аналогично инициализации, только без сброса текущих настроек.</p>
<p>4.3.2. Новые устройства добавляются с LOCATION_ID = -1, т.е. без локации, в «корень».</p>
<h3 id="44-замена-устройства-в-линии-dali">4.4. Замена устройства в линии DALI</h3>
<p>4.4.1. Замена вышедшего из строя устройства на новое того же типа с сохранением всех настроек старого.</p>
<p>4.4.2. Порядок замены:</p>
<ul>
  <li>От приложения в прошивку приходит телега <code>SET.&lt;TBLNAME&gt;[&lt;DEVID&gt;].STATUS("C")</code>.
  </li>
  <li>Контроллер отправляет приложению телегу <code>SET.CONTROLLER[0].STATUS(I)</code>.
  </li>
  <li>Контроллер проводит магический обряд по замене.
  </li>
  <li>Контроллер отправляет приложению телегу <code>SET.&lt;TBLNAME&gt;[&lt;DEVID&gt;].STATUS(A)</code>.
  </li>
  <li>Контроллер отправляет приложению телегу <code>SET.CONTROLLER[0].STATUS(A)</code>.
  </li>
</ul>
<h3 id="45-создание-и-удаление-локаций-распределение-по-ним-устройств">4.5. Создание и удаление локаций, распределение по ним устройств</h3>
<p>4.5.1. Создание и удаление локации производится по одной и той же телеге: <code>SET.LOCATIONS[&lt;LOCID&gt;].EXIST(...)</code>. Прошивка производит изменения у себя в USM и отправляет телеги об изменениях приложению.</p>
<p>4.5.2. Помещение устройств в локацию производится поштучно телегами <code>SET.&lt;TBL&gt;[&lt;DEVID&gt;].LOCATION_ID(&lt;LOCID&gt;)</code>.</p>
<p>4.5.3. Перемещение из локации в корень: &lt;LOCID&gt; = -1.</p>
<h3 id="46-создание-и-удаление-групп-распределение-по-ним-устройств">4.6. Создание и удаление групп, распределение по ним устройств</h3>
<p>4.6.1. Создание и удаление групп производится по одной и той же телеге: <code>SET.GROUPS[&lt;GRPID&gt;].EXIST(...)</code>. Прошивка производит изменения у себя в USM и отправляет телеги об изменениях приложению.</p>
<p>4.6.2. Помещение устройств в группу производится поштучно телегами <code>SET.&lt;TBL&gt;[&lt;DEVID&gt;].GROUP_ID(&lt;GRPID&gt;)</code>.</p>
<p>4.6.3. Перемещение из группы: &lt;GRPID&gt; = -1.</p>
<h3 id="47-именование-и-раздача-пиктограмм-контроллеру-локациям-устройствам">4.7. Именование и раздача пиктограмм контроллеру, локациям, устройствам</h3>
<p>4.7.1. Всё это — интерфейсные данные, поэтому передаются телегой <code>SET.CONTROLLERS[0].IDATA(...)</code> в прошивку, а после изменения в прошивке назад этой же телегой в приложение.</p>
<h3 id="48-добавление-поддействия-в-действие">4.8. Добавление поддействия в действие</h3>
<p>4.8.1. Эти манипуляции требуются при навешивании действий на кнопки и датчики, поэтому из соотв. разделов на текущий раздел мы будем позже ссылаться.</p>
<p>4.8.2. При добавлении в действие с ID = <ACTID> поддействия с ID = <SACTID> (OBJECT_TYPE, OBJECT_NUM, VALUE):</p>
<ul>
  <li>в прошивку поступает <code>SET.SUBACTIONS[&lt;SACTID&gt;](...)</code>
  </li>
  <li>прошивка сохраняет это в своей USM
  </li>
  <li>прошивка отправляет ту же телегу <code>SET.SUBACTIONS[&lt;SACTID&gt;](...)</code> приложению
  </li>
</ul>
<p>4.8.3. При удалении из действия поддействия с ID = <SACTID>:</p>
<ul>
  <li>в прошивку поступает <code>SET.SUBACTIONS[&lt;SACTID&gt;].ACTION_ID(-1)</code>
  </li>
  <li>прошивка сохраняет это в своей USM
  </li>
  <li>прошивка отправляет ту же телегу <code>SET.SUBACTIONS[&lt;SACTID&gt;].ACTION_ID(-1)</code> приложению
  </li>
</ul>
<h3 id="49-назначение-действий-на-присутствие-и-отсутствие-датчиков-присутствия">4.9. Назначение действий на присутствие и отсутствие датчиков присутствия</h3>
<p>4.9.1. При назначении действия с ID = <ACTID> на присутствие датчика ID = <PSID>:</p>
<ul>
  <li>в прошивку поступает <code>SET.PRES_SENSORS[&lt;PSID&gt;].ACTION_OCCUPANCY_ID(&lt;ACTID&gt;)</code>
  </li>
  <li>прошивка выставляет у себя в USM у датчика ACTION_OCCUPANCY_ID = <ACTID>
  </li>
  <li>прошивка отправляет телегу <code>SET.PRES_SENSORS[&lt;PSID&gt;].ACTION_OCCUPANCY_ID(&lt;ACTID&gt;)</code>
  </li>
</ul>
<p>4.9.2. Снятие действия с действия на присутствие датчика делается аналогично, но с передачей в качестве &lt;ACTID&gt; -1.</p>
<p>4.9.3. Как добавляются поддействия в действие, см. выше <strong>4.8. Добавление поддействия в действие</strong>.</p>
<p>4.9.4. Аналогичные чудеса происходят при работе с ACTION_VACANCY_ID.</p>
<h3 id="410-привязка-датчиков-освещённости-к-группам-светильников">4.10. Привязка датчиков освещённости к группам светильников</h3>
<p>4.10.1. При назначении группы с ID = <GRPID> на датчик освещённости ID = <BSID>:</p>
<ul>
  <li>в прошивку поступает <code>SET.BRIGHT_SENSORS[&lt;BSID&gt;].GROUP_ID(&lt;GRPID&gt;)</code>
  </li>
  <li>прошивка выставляет у себя в USM у датчика GROUP_ID = <GRPID>
  </li>
  <li>прошивка отправляет назад ту же телегу <code>SET.BRIGHT_SENSORS[&lt;BSID&gt;].GROUP_ID(&lt;GRPID&gt;)</code>
  </li>
</ul>
<p>4.10.2. Снятие группы с датчика производится аналогично, но передачей в качестве <GRPID> -1.</p>
<h3 id="411-назначение-действий-на-настенные-кнопки">4.11. Назначение действий на настенные кнопки</h3>
<p>4.11.1. Когда (<strong>первым шагом</strong>) мы вешаем на <strong>короткое нажатие</strong> кнопки с ID = <BID> набор действий (набор — потому как надо дать возможность перебирать эти действия каруселью):</p>
<ul>
  <li>в прошивку поступает <code>SET.BUTTONS[&lt;BID&gt;].ACTION_SET_SHORT_NUM(&lt;ASID&gt;)</code>
  </li>
  <li>прошивка выставляет у себя в USM у кнопки ACTION_SET_SHORT_NUM = <ASID>
  </li>
  <li>прошивка отправляет назад ту же телегу <code>SET.BUTTONS[&lt;BID&gt;].ACTION_SET_SHORT_NUM(&lt;ASID&gt;)</code>
  </li>
</ul>
<p>4.11.2. Снятие набора с <strong>короткого нажатия</strong> производится аналогично, но передачей в качестве <ASID> -1.</p>
<p>4.11.3. Потом добавляем в набор действия телегами:</p>
<ul>
  <li>в прошивку поступает <code>SET.ACTIONS[&lt;ACTID&gt;].ACTION_SET_NUM(&lt;ASID&gt;)</code>
  </li>
  <li>прошивка выставляет у себя в USM у действия с ID = <ACTID> ACTION_SET_NUM = <ASID>
  </li>
  <li>прошивка отправляет назад ту же телегу <code>SET.ACTIONS[&lt;ACTID&gt;].ACTION_SET_NUM(&lt;ASID&gt;)</code>
  </li>
</ul>
<p>4.11.4. Удаление действия из набора производится аналогично, но с <ASID> = -1.</p>
<p>4.11.5. Как (<strong>третьим шагом</strong>) добавляются поддействия в каждое действие из набора, см. выше <strong>4.8. Добавление поддействия в действие</strong>.</p>
<p>4.11.6. При назначении действия с ID = <ACTID> на <strong>долгое нажатие</strong> кнопки:</p>
<ul>
  <li>в прошивку поступает <code>SET.BUTTONS[&lt;BID&gt;].ACTION_LONG_ID(&lt;ACTID&gt;)</code>
  </li>
  <li>прошивка выставляет у себя в USM у кнопки ACTION_LONG_ID = <ACTID>
  </li>
  <li>прошивка отправляет назад ту же телегу <code>SET.BUTTONS[&lt;BID&gt;].ACTION_LONG_ID(&lt;ACTID&gt;)</code>
  </li>
</ul>
<p>4.11.7. Снятие действия с <strong>долгого нажатия</strong> производится аналогично, но передачей в качестве <ACTID> -1.</p>
<p>4.11.8. Как добавляются поддействия в действие, см. выше <strong>4.8. Добавление поддействия в действие</strong>.</p>
<h2 id="5-настройка">5. Настройка</h2>
<h2 id="6-оперативное-управление">6. Оперативное управление</h2>
<h2 id="7-работа-по-датчикам">7. Работа по датчикам</h2>
<h2 id="8-работа-по-расписанию">8. Работа по расписанию</h2>
<h2 id="9-сброс-контроллера-железной-кнопкой">9. Сброс контроллера железной кнопкой</h2>
<h2 id="10-индикация-на-контроллере">10. Индикация на контроллере</h2>
<h2 id="11-вопросы">11. Вопросы</h2>
<p>11.1. У нас ведь все команды (на задание яркости светильника и т.п.) в DALI идут от контроллера? Т.е., если всё отрабатывает нормально, контроллер всегда знает актуальное состояние устройства в линии?</p>
<p>11.2. Как лучше отправлять?</p>
<ul>
  <li>одну телегу со всей записью и потом в обработчике это разбирать
  </li>
  <li>две телеги каждую с одним полем
  </li>
</ul>
<h2 id="12-идеи">12. Идеи</h2>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
